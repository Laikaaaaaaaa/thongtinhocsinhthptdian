<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kê khai thông tin cập nhật CSDL ngành - Trang 2 - THPT Dĩ An</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/logo/favicon.svg?v=2025081301">
    <link rel="icon" type="image/png" sizes="32x32" href="/logo/favicon-32x32.png?v=2025081301">
    <link rel="icon" type="image/png" sizes="16x16" href="/logo/favicon-16x16.png?v=2025081301">
    <link rel="apple-touch-icon" sizes="180x180" href="/logo/apple-touch-icon.png?v=2025081301">
    <link rel="manifest" href="/logo/site.webmanifest?v=2025081301">
    <link rel="shortcut icon" href="/logo/favicon.ico?v=2025081301">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>

        // Fix back button spinner issue
        window.addEventListener('pageshow', function(event) {
            // Hide loading overlay when page is shown (including back button navigation)
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('show');
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            function canAccessPage(targetPage) {
                const progress = JSON.parse(localStorage.getItem('formProgress') || '{}');
                for (let i = 0; i < targetPage; i++) {
                    if (!progress[`page${i}`]) {
                        return false;
                    }
                }
                return true;
            }

            if (!canAccessPage(2)) {
                alert('Bạn phải hoàn thành các bước trước đó!');
                window.location.href = 'page1.html';
                return;
            }
        });

        function markPageCompleted(pageNumber) {
            const progress = JSON.parse(localStorage.getItem('formProgress') || '{}');
            progress[`page${pageNumber}`] = true;
            localStorage.setItem('formProgress', JSON.stringify(progress));
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .header {
            background: linear-gradient(135deg, #2196F3 0%, #1565C0 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            margin: 0 20px 20px 20px;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            gap: 2px;
        }

        .progress-segment {
            flex: 1;
            height: 100%;
            background: #e0e0e0;
            border-radius: 2px;
        }

        .progress-segment.active {
            background: linear-gradient(90deg, #4CAF50, #45a049);
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4CAF50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 10px;
            position: relative;
        }

        .step.inactive {
            background: #e0e0e0;
            color: #999;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 20px;
            height: 2px;
            background: #e0e0e0;
            transform: translateY(-50%);
        }

        .step:last-child::after {
            display: none;
        }

        .form-container {
            padding: 50px 60px;
        }

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 20px;
            color: white;
            font-size: 16px;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-group {
            margin-bottom: 25px;
            width: 100%;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.3;
            word-wrap: break-word;
            hyphens: auto;
        }

        .required {
            color: #e74c3c;
            margin-left: 3px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: #fafafa;
        }

        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        /* Style cho dropdown phân nhóm theo chữ cái */
        .form-control option[disabled] {
            font-weight: bold;
            background-color: #f0f0f0 !important;
            color: #666 !important;
            font-style: italic;
        }

        .form-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            align-items: start;
        }

        .form-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: start;
        }

        .form-row-3 .form-group,
        .form-row-2 .form-group {
            min-height: 85px;
        }

        .section-title {
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            margin: 30px 0 20px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .note {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 0 8px 8px 0;
        }

        .note p {
            color: #1565C0;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .note strong {
            color: #0D47A1;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-back {
            background: #6c757d;
            color: white;
        }

        .btn-back:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-submit {
            background: linear-gradient(135deg, #2196F3 0%, #1565C0 100%);
            color: white;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        .example-text {
            font-style: italic;
            color: #666;
            font-size: 13px;
            margin-top: 4px;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
                margin: 0;
                min-height: 100vh;
            }
            
            .container {
                margin: 0;
                max-width: none;
                width: 100%;
                height: 100%;
                min-height: 100vh;
                border-radius: 0;
                box-shadow: none;
                border: none;
            }
            
            .header {
                padding: 15px 15px;
            }
            
            .header h1 {
                font-size: 18px;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 13px;
            }
            
            .progress-bar {
                height: 4px;
                margin: 0;
            }
            
            .form-container {
                padding: 20px 15px;
            }
            
            .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }
            
            .form-control, select.form-control {
                padding: 10px 12px;
                font-size: 14px;
                border-width: 1.5px;
            }
            
            .form-row-2,
            .form-row-3 {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .note {
                padding: 12px;
                margin-bottom: 18px;
            }
            
            .note p {
                font-size: 12px;
                margin-bottom: 6px;
            }
            
            .btn {
                padding: 12px 18px;
                font-size: 14px;
            }
            
            .button-group {
                flex-direction: row;
                align-items: center;
                gap: 10px;
                margin-top: 25px;
                justify-content: space-between;
            }
            
            .btn-next, .btn-prev {
                width: 48%;
                max-width: none;
            }
            
            .loading-text {
                font-size: 14px;
            }
            
            .field-note {
                font-size: 12px;
            }
        }

        @media (max-width: 1024px) {
            .form-row-3 {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .form-row-3 .form-group:nth-child(3) {
                grid-column: 1 / -1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-map-marker-alt"></i> KÊ KHAI THÔNG TIN CẬP NHẬT CSDL NGÀNH</h1>
            <p>II. THÔNG TIN LIÊN QUAN ĐẾN ĐỊA DANH</p>
        </div>

        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">Đang chuyển trang...</div>
        </div>

        <div class="progress-bar">
            <div class="progress-segment active"></div>
            <div class="progress-segment active"></div>
            <div class="progress-segment"></div>
            <div class="progress-segment"></div>
            <div class="progress-segment"></div>
        </div>

        <div class="form-container">
            <div id="catalogStatus" style="display:none; margin-bottom:12px; color:#1565C0; font-size:14px;">
                <i class="fas fa-spinner fa-spin"></i> Đang tải danh mục địa danh sau sáp nhập...
            </div>

            <div class="note">
                <p><strong>LƯU Ý QUAN TRỌNG:</strong></p>
                <p>• Cập nhật địa danh mới sau sáp nhập tỉnh, thành phố (sau 1/7/2025)</p>
                <p>• Những thông tin nào liên quan đến giấy khai sinh thì phải đúng với thông tin trong giấy khai sinh của HS</p>
                <p>• <strong>ĐỂ BIẾT CHÍNH XÁC ĐỊA DANH MỚI VUI LÒNG TRUY CẬP ỨNG DỤNG VNEID ĐỂ XEM</strong></p>
                <p>• Các trường có dấu <span class="required">*</span> là bắt buộc</p>
                <p><strong>Email đã đăng ký:</strong> <span id="userEmailDisplay" style="color: #2196F3; font-weight: 600;"></span></p>
            </div>

            <form id="addressForm" action="javascript:void(0)" method="POST" onsubmit="return false;">
                
                <div class="section-title"><i class="fas fa-home"></i> ĐỊA CHỈ THƯỜNG TRÚ</div>
                
                <div class="form-row-2">
                    <div class="form-group">
                        <label for="permanentProvince">Tỉnh/Thành phố (sau sáp nhập) <span class="required">*</span></label>
                        <select id="permanentProvince" name="permanentProvince" class="form-control" required>
                            <option value="">-- Chọn tỉnh/thành phố --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="permanentWard">Phường/Xã (sau sáp nhập) <span class="required">*</span></label>
                        <select id="permanentWard" name="permanentWard" class="form-control" required disabled>
                            <option value="">-- Chọn phường/xã --</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="permanentHamlet">Tổ/Thôn/Xóm/Khu phố (Địa chỉ thường trú - sau sáp nhập) <span class="required">*</span></label>
                    <input type="text" id="permanentHamlet" name="permanentHamlet" class="form-control" 
                           placeholder="VD: Khu phố Đông Tân" required>
                </div>

                <div class="form-group">
                    <label for="permanentStreet">Số nhà, tên đường (Địa chỉ thường trú - sau sáp nhập) <span class="required">*</span></label>
                    <input type="text" id="permanentStreet" name="permanentStreet" class="form-control" 
                           placeholder="VD: 123/45, đường Nguyễn Du" required>
                    <div class="example-text">Ví dụ: 12/3 Nguyễn Du, Khu phố Đông Tân, Phường Dĩ An, TP. Hồ Chí Minh</div>
                </div>

                <div class="section-title"><i class="fas fa-map"></i> THÔNG TIN QUÊ QUÁN</div>

                <div class="form-row-2">
                    <div class="form-group">
                        <label for="hometownProvince">Tỉnh/Thành phố (Quê quán - sau sáp nhập) <span class="required">*</span></label>
                        <select id="hometownProvince" name="hometownProvince" class="form-control" required>
                            <option value="">-- Chọn tỉnh/thành phố --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="hometownWard">Phường/Xã (Quê quán - sau sáp nhập) <span class="required">*</span></label>
                        <select id="hometownWard" name="hometownWard" class="form-control" required disabled>
                            <option value="">-- Chọn phường/xã --</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="hometownHamlet">Tổ/Thôn/Xóm/Khu phố (Theo quê quán - sau sáp nhập) <span class="required">*</span></label>
                    <input type="text" id="hometownHamlet" name="hometownHamlet" class="form-control" 
                           placeholder="VD: Thôn 1" required>
                </div>

                <div class="section-title"><i class="fas fa-certificate"></i> THÔNG TIN NƠI CẤP GIẤY KHAI SINH</div>

                <div class="form-row-2">
                    <div class="form-group">
                        <label for="birthCertProvince">Tỉnh/Thành phố (Giấy khai sinh - sau sáp nhập) <span class="required">*</span></label>
                        <select id="birthCertProvince" name="birthCertProvince" class="form-control" required>
                            <option value="">-- Chọn tỉnh/thành phố --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthCertWard">Phường/Xã (Giấy khai sinh - sau sáp nhập) <span class="required">*</span></label>
                        <select id="birthCertWard" name="birthCertWard" class="form-control" required disabled>
                            <option value="">-- Chọn phường/xã --</option>
                        </select>
                    </div>
                </div>

                <div class="section-title"><i class="fas fa-baby"></i> THÔNG TIN NƠI SINH</div>

                <div class="form-row-2">
                    <div class="form-group">
                        <label for="birthplaceProvince">Tỉnh/Thành phố (Nơi sinh - sau sáp nhập) <span class="required">*</span></label>
                        <select id="birthplaceProvince" name="birthplaceProvince" class="form-control" required>
                            <option value="">-- Chọn tỉnh/thành phố --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthplaceWard">Phường/Xã (Nơi sinh - sau sáp nhập) <span class="required">*</span></label>
                        <select id="birthplaceWard" name="birthplaceWard" class="form-control" required disabled>
                            <option value="">-- Chọn phường/xã --</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="birthplaceDetail">Nơi sinh chi tiết <span class="required">*</span></label>
                    <input type="text" id="birthplaceDetail" name="birthplaceDetail" class="form-control" 
                           placeholder="Nhập Nơi sinh như bệnh viện, trạm y tế..." required>
                    <div class="example-text">Ví dụ: Bệnh viện Từ Dũ, Trạm Y tế Phường Dĩ An, Nhà riêng</div>
                </div>

                <div class="section-title"><i class="fas fa-location-arrow"></i> THÔNG TIN CHỖ Ở HIỆN NAY</div>

                <div class="form-group">
                    <label for="currentAddressDetail">Chỗ ở hiện nay chi tiết (sau sáp nhập) <span class="required">*</span></label>
                    <textarea id="currentAddressDetail" name="currentAddressDetail" class="form-control" rows="3" 
                              placeholder="Ghi đầy đủ thông tin: số nhà, tên đường, khu phố/thôn, phường/xã, tỉnh/thành phố" required></textarea>
                    <div class="example-text">Ví dụ: 12/3 Nguyễn Du, Khu phố Đông Tân, Phường Dĩ An, TP. Hồ Chí Minh</div>
                </div>

                <div class="form-row-2">
                    <div class="form-group">
                        <label for="currentProvince">Tỉnh/Thành phố (sau sáp nhập) <span class="required">*</span></label>
                        <select id="currentProvince" name="currentProvince" class="form-control" required>
                            <option value="">-- Chọn tỉnh/thành phố --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="currentWard">Phường/Xã (sau sáp nhập) <span class="required">*</span></label>
                        <select id="currentWard" name="currentWard" class="form-control" required disabled>
                            <option value="">-- Chọn phường/xã --</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="currentHamlet">Thôn/Xóm/Khu phố (Chỗ ở hiện nay - sau sáp nhập) <span class="required">*</span></label>
                    <input type="text" id="currentHamlet" name="currentHamlet" class="form-control" 
                           placeholder="VD: Khu phố Đông Tân" required>
                </div>

                <div class="button-group">
                    <a href="page1.html" class="btn btn-back">
                        <i class="fas fa-arrow-left"></i> QUAY LẠI
                    </a>
                    <button type="button" id="nextButton" class="btn btn-submit">
                        <i class="fas fa-arrow-right"></i> TIẾP THEO
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
/* ----- CLEAN VERSION: Replace all duplicate functions ----- */

/* 1) Chuẩn: fillSelect (fix cú pháp & dùng Array.from) */
function fillSelect(select, items, withCode=false, placeholder='-- Chọn --') {
  if (!select) return;
  const current = select.value || '';
  select.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = '';
  opt0.textContent = placeholder;
  opt0.selected = true;
  select.appendChild(opt0);

  items.forEach(it => {
    const opt = document.createElement('option');
    opt.value = withCode ? it.code : it.name;
    opt.dataset.code = it.code || '';
    opt.textContent = it.name;
    select.appendChild(opt);
  });

  // safe restore: check with Array.from, not [.select.options]
  if (current && Array.from(select.options).some(o => o.value === current)) {
    select.value = current;
  } else {
    // don't throw, just leave default
    select.value = '';
  }
}

/* 2) Chuẩn: saveFormData - lưu VALUE hợp nhất và lưu thêm __code để restore chính xác */
function saveFormData() {
  try {
    const formData = {};
    const form = document.getElementById('addressForm');
    if (!form) return;
    const inputs = form.querySelectorAll('input, select, textarea');

    inputs.forEach(input => {
      const tag = input.tagName.toLowerCase();
      if (tag === 'select') {
        const selectedOption = input.options[input.selectedIndex];
        if (selectedOption) {
          formData[input.name] = selectedOption.value || '';
          formData[`${input.name}__code`] = selectedOption.dataset.code || '';
          // short debug
          if (input.name.toLowerCase().includes('province') || input.name.toLowerCase().includes('ward')) {
            console.log(`[SAVE] ${input.name}: "${formData[input.name]}", code="${formData[`${input.name}__code`]}"`);
          }
        } else {
          formData[input.name] = '';
          formData[`${input.name}__code`] = '';
        }
      } else {
        formData[input.name] = input.value || '';
      }
    });

    localStorage.setItem('addressFormData', JSON.stringify(formData));
  } catch (e) {
    console.error('saveFormData error', e);
  }
}

/* 3) Chuẩn: loadFormData + restoreSelectWithFallback (đảm bảo dispatch change sau khi set) */
function restoreSelectWithFallback(selectEl, wardEl, saved, keyPrefix) {
  if (!selectEl) return;
  const savedName = saved[keyPrefix] || '';
  const savedCode = saved[`${keyPrefix}__code`] || '';

  let found = Array.from(selectEl.options).find(o => o.value === savedName);
  if (!found && savedCode) {
    found = Array.from(selectEl.options).find(o => (o.dataset && o.dataset.code) === savedCode);
  }

  if (found) {
    selectEl.value = found.value;
    selectEl.dispatchEvent(new Event('change', { bubbles: true }));
    console.log(`[RESTORE] ${keyPrefix} -> ${found.value} (${found.dataset.code||''})`);
  } else {
    // clear and dispatch so dependent selects get reset
    selectEl.value = '';
    selectEl.dispatchEvent(new Event('change', { bubbles: true }));
    if (savedName || savedCode) console.warn(`[RESTORE] ${keyPrefix} not found for savedName="${savedName}" savedCode="${savedCode}"`);
  }

  // try restore ward after province change
  if (wardEl) {
    const wardKey = keyPrefix.replace('Province','Ward');
    const wardName = saved[wardKey] || '';
    const wardCode = saved[`${wardKey}__code`] || '';
    let wfound = Array.from(wardEl.options).find(o => o.value === wardName);
    if (!wfound && wardCode) {
      wfound = Array.from(wardEl.options).find(o => (o.dataset && o.dataset.code) === wardCode);
    }
    if (wfound) {
      wardEl.value = wfound.value;
      wardEl.dispatchEvent(new Event('change', { bubbles: true }));
      console.log(`[RESTORE] ${wardKey} -> ${wfound.value}`);
    } else {
      wardEl.value = '';
      wardEl.dispatchEvent(new Event('change', { bubbles: true }));
    }
  }
}

function loadFormData() {
  try {
    const savedRaw = localStorage.getItem('addressFormData') || '{}';
    const saved = JSON.parse(savedRaw);
    console.log('[DEBUG] Loading addressFormData:', saved);

    const perProvince = document.getElementById('permanentProvince');
    const perWard = document.getElementById('permanentWard');
    const curProvince = document.getElementById('currentProvince');
    const curWard = document.getElementById('currentWard');
    const hometownProvince = document.getElementById('hometownProvince');
    const hometownWard = document.getElementById('hometownWard');
    const birthCertProvince = document.getElementById('birthCertProvince');
    const birthCertWard = document.getElementById('birthCertWard');
    const birthplaceProvince = document.getElementById('birthplaceProvince');
    const birthplaceWard = document.getElementById('birthplaceWard');

    // Restore order: provinces first (so onProvinceChange can fill wards), then wards
    restoreSelectWithFallback(perProvince, perWard, saved, 'permanentProvince');
    restoreSelectWithFallback(curProvince, curWard, saved, 'currentProvince');
    restoreSelectWithFallback(hometownProvince, hometownWard, saved, 'hometownProvince');
    restoreSelectWithFallback(birthCertProvince, birthCertWard, saved, 'birthCertProvince');
    restoreSelectWithFallback(birthplaceProvince, birthplaceWard, saved, 'birthplaceProvince');

    // Restore simple text inputs
    const form = document.getElementById('addressForm');
    Object.keys(saved).forEach(k => {
      if (k.endsWith('__code')) return; // skip helper keys
      const el = form.querySelector(`[name="${k}"]`);
      if (el && el.tagName !== 'SELECT') {
        el.value = saved[k];
      }
    });

  } catch (e) {
    console.error('loadFormData error', e);
  }
}

// Debug helpers
window.debugClearAndReload = function() {
    localStorage.clear();
    console.log('[DEBUG] LocalStorage cleared, reloading page...');
    location.reload();
};

window.debugShowData = function() {
    console.log('[DEBUG] Current localStorage data:');
    console.log('addressFormData:', localStorage.getItem('addressFormData'));
};

window.debugDOMCheck = function() {
    console.log('[DEBUG] DOM Elements Check:');
    const perP = document.getElementById('permanentProvince');
    const curP = document.getElementById('currentProvince');
    console.log('permanentProvince element:', perP);
    console.log('  - name:', perP?.name, 'id:', perP?.id, 'value:', perP?.value);
    console.log('currentProvince element:', curP);
    console.log('  - name:', curP?.name, 'id:', curP?.id, 'value:', curP?.value);
    
    // Check if they're the same object (major bug)
    if (perP === curP) {
        console.error('❌ CRITICAL BUG: permanentProvince and currentProvince are the same DOM element!');
    }
};

/* ----- END REPLACEMENT ----- */

        document.addEventListener('DOMContentLoaded', async function() {
            var email = localStorage.getItem('userEmail') || '';
            var el = document.getElementById('userEmailDisplay');
            if (el) el.textContent = email;

            // ✅ PREVENT FORM SUBMIT - Fix "Method Not Allowed" error
            const addressForm = document.getElementById('addressForm');
            if (addressForm) {
                addressForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('[DEBUG] Form submit prevented - use navigation buttons instead');
                    return false;
                });
            }

            // Add click handler for next button since form submission is prevented
            const nextButton = document.getElementById('nextButton');
            console.log('[DEBUG] Looking for nextButton:', nextButton);
            if (nextButton) {
                console.log('[DEBUG] nextButton found, adding event listener');
                nextButton.addEventListener('click', function() {
                    // alert('Button clicked! Will navigate to page3.html');
                    console.log('[DEBUG] Next button clicked');
                    
                    // TEMP: Skip validation for testing
                    const skipValidation = true;
                    
                    if (skipValidation) {
                        console.log('[DEBUG] SKIPPING VALIDATION FOR TESTING');
                        const form = document.getElementById('addressForm');
                        const formData = new FormData(form);
                        const addressData = {};
                        
                        formData.forEach((value, key) => {
                            addressData[key] = value;
                        });

                        localStorage.setItem('addressFormData', JSON.stringify(addressData));
                        console.log('[DEBUG] Data saved to localStorage');
                        
                        showNotification('Đã lưu thông tin địa chỉ! Chuyển sang trang tiếp theo...', 'success');

                        markPageCompleted(2);
                        console.log('[DEBUG] Page marked as completed');

                        console.log('[DEBUG] Starting page transition...');
                        // showPageTransition(() => {
                        //     console.log('[DEBUG] Navigating to page3.html');
                        //     window.location.href = 'page3.html';
                        // });
                        
                        // Direct navigation for testing
                        console.log('[DEBUG] Direct navigation to page3.html');
                        setTimeout(() => {
                            window.location.href = 'page3.html';
                        }, 1000);
                        return;
                    }
                    
                    // Same validation logic as form submit
                    let isValid = true;
                    const requiredFields = ['perAddress', 'curAddress', 'hometownAddress', 'birthCertAddress', 'birthplaceAddress'];
                    
                    console.log('[DEBUG] Checking required fields...');
                    requiredFields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        console.log(`[DEBUG] Field ${fieldId}:`, field ? field.value : 'NOT FOUND');
                        if (!field || !field.value.trim()) {
                            isValid = false;
                            console.log(`[DEBUG] Field ${fieldId} is invalid`);
                            if (field) {
                                field.style.borderColor = '#ff6b6b';
                            }
                        } else {
                            field.style.borderColor = '#e0e0e0';
                        }
                    });

                    console.log('[DEBUG] Required fields validation:', isValid);

                    function checkHierarchy(p, w) {
                        if (p && !w) return false;
                        return true;
                    }
                    
                    const perProvince = document.getElementById('perProvince');
                    const perWard = document.getElementById('perWard');
                    const curProvince = document.getElementById('curProvince');
                    const curWard = document.getElementById('curWard');
                    const hometownProvince = document.getElementById('hometownProvince');
                    const hometownWard = document.getElementById('hometownWard');
                    const birthCertProvince = document.getElementById('birthCertProvince');
                    const birthCertWard = document.getElementById('birthCertWard');
                    const birthplaceProvince = document.getElementById('birthplaceProvince');
                    const birthplaceWard = document.getElementById('birthplaceWard');
                    
                    const perOK = checkHierarchy(perProvince?.value, perWard?.value);
                    const curOK = checkHierarchy(curProvince?.value, curWard?.value);
                    const hometownOK = checkHierarchy(hometownProvince?.value, hometownWard?.value);
                    const birthCertOK = checkHierarchy(birthCertProvince?.value, birthCertWard?.value);
                    const birthplaceOK = checkHierarchy(birthplaceProvince?.value, birthplaceWard?.value);
                    
                    console.log('[DEBUG] Hierarchy validation:', {
                        perOK, curOK, hometownOK, birthCertOK, birthplaceOK
                    });
                    
                    if (!perOK || !curOK || !hometownOK || !birthCertOK || !birthplaceOK) {
                        isValid = false;
                        console.log('[DEBUG] Hierarchy validation failed');
                        showNotification('Vui lòng chọn tỉnh và phường/xã cho tất cả các địa chỉ sau sáp nhập', 'error');
                    }

                    console.log('[DEBUG] Final validation result:', isValid);
                    if (isValid) {
                        console.log('[DEBUG] Validation passed, proceeding to save and navigate');
                        const form = document.getElementById('addressForm');
                        const formData = new FormData(form);
                        const addressData = {};
                        
                        formData.forEach((value, key) => {
                            addressData[key] = value;
                        });

                        localStorage.setItem('addressFormData', JSON.stringify(addressData));
                        console.log('[DEBUG] Data saved to localStorage');
                        
                        showNotification('Đã lưu thông tin địa chỉ! Chuyển sang trang tiếp theo...', 'success');

                        markPageCompleted(2);
                        console.log('[DEBUG] Page marked as completed');

                        console.log('[DEBUG] Starting page transition...');
                        showPageTransition(() => {
                            console.log('[DEBUG] Navigating to page3.html');
                            window.location.href = 'page3.html';
                        });
                    } else {
                        console.log('[DEBUG] Validation failed, showing error');
                        showNotification('Vui lòng điền đầy đủ các trường bắt buộc!', 'error');
                    }
                });
            } else {
                console.log('[DEBUG] nextButton NOT FOUND!');
            }

            // Don't load form data here - wait until select boxes are populated
            // loadFormData();
            window.addEventListener('pageshow', function(event) {
                // Chỉ reload nếu là back/forward navigation (persisted = true)
                if (event.persisted) {
                    console.log('[DEBUG] Page restored from cache, reloading data...');
                    setTimeout(() => {
                        loadFormData();
                    }, 100); // Delay để đảm bảo DOM đã sẵn sàng
                }
            });

            const statusEl = document.getElementById('catalogStatus');
            const showStatus = (msg, isError=false) => {
                if (!statusEl) return;
                statusEl.style.display = 'block';
                statusEl.style.color = isError ? '#f44336' : '#1565C0';
                statusEl.innerHTML = `${isError ? '<i class="fas fa-exclamation-triangle"></i>' : '<i class="fas fa-spinner fa-spin"></i>'} ${msg}`;
            };
            showStatus('Đang tải danh mục địa danh sau sáp nhập...');

            async function fetchCatalogWithFallback() {
                const urls = [
                    '/api/locations/latest?refresh=1',
                    '/api/locations/latest'
                ];
                for (const url of urls) {
                    try {
                        const res = await fetch(url, { cache: 'no-store' });
                        if (res.ok) {
                            const data = await res.json();
                            if (data && Array.isArray(data.provinces) && data.provinces.length) return data;
                        }
                    } catch (_) { /* try next */ }
                }
                return { provinces: [], wardsByProvince: {} };
            }

            function replaceSelectWithText(selectId, placeholder) {
                const sel = document.getElementById(selectId);
                if (!sel) return null;
                const input = document.createElement('input');
                input.type = 'text';
                input.id = sel.id;
                input.name = sel.name;
                input.className = sel.className;
                input.placeholder = placeholder || '';
                input.required = sel.required;
                input.value = sel.value || '';
                sel.parentNode.replaceChild(input, sel);
                return input;
            }

            let catalog = await fetchCatalogWithFallback();

            // Add "Ở nước ngoài" option to the beginning
            if (catalog.provinces && catalog.provinces.length) {
                // Add overseas option to the beginning
                catalog.provinces.unshift({ code: 'OVERSEAS', name: 'Ở nước ngoài' });
                
                // Add overseas wards
                if (!catalog.wardsByProvince) catalog.wardsByProvince = {};
                catalog.wardsByProvince['OVERSEAS'] = [
                    { code: 'OVERSEAS_001', name: 'Ở nước ngoài' }
                ];
            }

            if (!catalog.provinces || catalog.provinces.length === 0 || 
                catalog.provinces.some(p => !p.name || p.name.trim() === '')) {
                console.log('Using fallback province list');
                catalog = {
                    provinces: [
                        { code: 'OVERSEAS', name: 'Ở nước ngoài' },
                        { code: '01', name: 'Thành phố Hà Nội' },
                        { code: '79', name: 'Thành phố Hồ Chí Minh' },
                        { code: '48', name: 'Thành phố Đà Nẵng' },
                        { code: '92', name: 'Thành phố Cần Thơ' },
                        { code: '31', name: 'Thành phố Hải Phòng' },
                        { code: '74', name: 'Tỉnh Bình Dương' },
                        { code: '77', name: 'Tỉnh Bà Rịa - Vũng Tàu' },
                        { code: '75', name: 'Tỉnh Đồng Nai' }
                    ],
                    wardsByProvince: {
                        'OVERSEAS': [
                            { code: 'OVERSEAS_001', name: 'Ở nước ngoài' }
                        ],
                        '79': [
                            { code: '79001', name: 'Phường Sài Gòn' },
                            { code: '79002', name: 'Phường Dĩ An' },
                            { code: '79003', name: 'Phường Tân Bình' },
                            { code: '79004', name: 'Phường Thủ Đức' }
                        ]
                    }
                };
            }

            const perProvince = document.getElementById('permanentProvince');
            const perWard = document.getElementById('permanentWard');
            const curProvince = document.getElementById('currentProvince');
            const curWard = document.getElementById('currentWard');

            if (!catalog.provinces || catalog.provinces.length === 0) {

                showStatus('Không tải được danh mục địa danh. Bạn có thể nhập tay tên tỉnh, phường/xã.', true);
                replaceSelectWithText('permanentProvince', 'Nhập tỉnh/thành phố');
                replaceSelectWithText('permanentWard', 'Nhập phường/xã');
                replaceSelectWithText('currentProvince', 'Nhập tỉnh/thành phố');
                replaceSelectWithText('currentWard', 'Nhập phường/xã');
                replaceSelectWithText('hometownProvince', 'Nhập tỉnh/thành phố');
                replaceSelectWithText('hometownWard', 'Nhập phường/xã');
                replaceSelectWithText('birthCertProvince', 'Nhập tỉnh/thành phố');
                replaceSelectWithText('birthCertWard', 'Nhập phường/xã');
                replaceSelectWithText('birthplaceProvince', 'Nhập tỉnh/thành phố');
                replaceSelectWithText('birthplaceWard', 'Nhập phường/xã');

                const form = document.getElementById('addressForm');
                form.querySelectorAll('input[name$="Province"],input[name$="Ward"]').forEach(el => {
                    el.addEventListener('input', debounce(saveFormData, 300));
                });

                setTimeout(() => statusEl && (statusEl.style.display = 'none'), 4000);
                return;
            } else {

                statusEl && (statusEl.style.display = 'none');
            }

            function fillSelect(select, items, withCode=false, placeholder='-- Chọn --') {
                if (!select) return;
                const current = select.value;
                select.innerHTML = '';

                const opt0 = document.createElement('option');
                opt0.value = '';
                opt0.textContent = placeholder;
                opt0.selected = true;
                select.appendChild(opt0);
                
                // Nhóm theo chữ cái đầu cho tất cả dropdown có nhiều hơn 10 items
                if (items.length > 10) {
                    // Special handling: Add "Ở nước ngoài" first if exists
                    const overseasItem = items.find(it => it.name === 'Ở nước ngoài');
                    if (overseasItem) {
                        const opt = document.createElement('option');
                        opt.value = overseasItem.name;
                        opt.dataset.code = overseasItem.code || '';
                        opt.textContent = overseasItem.name;
                        opt.style.fontWeight = 'bold';
                        opt.style.backgroundColor = '#e3f2fd';
                        select.appendChild(opt);
                        
                        // Add separator
                        const separator = document.createElement('option');
                        separator.value = '';
                        separator.textContent = '─────────────────';
                        separator.disabled = true;
                        separator.style.color = '#999';
                        select.appendChild(separator);
                    }
                    
                    // Filter out overseas item from regular grouping
                    const regularItems = items.filter(it => it.name !== 'Ở nước ngoài');
                    
                    const grouped = {};
                    regularItems.forEach(it => {
                        // Lấy tên thực của địa danh (bỏ tiền tố Tỉnh/Thành phố/Phường/Xã)
                        let displayName = it.name;
                        displayName = displayName.replace(/^(Tỉnh|Thành phố|Phường|Xã|Thị xã|Huyện|Thị trấn)\s+/, '');
                        
                        const firstChar = displayName.charAt(0).toUpperCase();
                        if (!grouped[firstChar]) {
                            grouped[firstChar] = [];
                        }
                        grouped[firstChar].push(it);
                    });
                    
                    // Sắp xếp các ký tự theo thứ tự alphabet Việt Nam chuẩn
                    const vietnameseAlphabet = ['A', 'Ă', 'Â', 'B', 'C', 'D', 'Đ', 'E', 'Ê', 'G', 'H', 'I', 'K', 'L', 'M', 'N', 'O', 'Ô', 'Ơ', 'P', 'Q', 'R', 'S', 'T', 'U', 'Ư', 'V', 'X', 'Y'];
                    
                    const sortedChars = Object.keys(grouped).sort((a, b) => {
                        // Chuẩn hóa ký tự để so sánh (bỏ dấu)
                        const normalizeChar = (char) => {
                            const mapping = {
                                'À': 'A', 'Á': 'A', 'Ạ': 'A', 'Ả': 'A', 'Ã': 'A',
                                'Â': 'A', 'Ầ': 'A', 'Ấ': 'A', 'Ậ': 'A', 'Ẩ': 'A', 'Ẫ': 'A',
                                'Ă': 'A', 'Ằ': 'A', 'Ắ': 'A', 'Ặ': 'A', 'Ẳ': 'A', 'Ẵ': 'A',
                                'È': 'E', 'É': 'E', 'Ẹ': 'E', 'Ẻ': 'E', 'Ẽ': 'E',
                                'Ê': 'E', 'Ề': 'E', 'Ế': 'E', 'Ệ': 'E', 'Ể': 'E', 'Ễ': 'E',
                                'Ì': 'I', 'Í': 'I', 'Ị': 'I', 'Ỉ': 'I', 'Ĩ': 'I',
                                'Ò': 'O', 'Ó': 'O', 'Ọ': 'O', 'Ỏ': 'O', 'Õ': 'O',
                                'Ô': 'O', 'Ồ': 'O', 'Ố': 'O', 'Ộ': 'O', 'Ổ': 'O', 'Ỗ': 'O',
                                'Ơ': 'O', 'Ờ': 'O', 'Ớ': 'O', 'Ợ': 'O', 'Ở': 'O', 'Ỡ': 'O',
                                'Ù': 'U', 'Ú': 'U', 'Ụ': 'U', 'Ủ': 'U', 'Ũ': 'U',
                                'Ư': 'U', 'Ừ': 'U', 'Ứ': 'U', 'Ự': 'U', 'Ử': 'U', 'Ữ': 'U',
                                'Ỳ': 'Y', 'Ý': 'Y', 'Ỵ': 'Y', 'Ỷ': 'Y', 'Ỹ': 'Y',
                                'Đ': 'D'
                            };
                            return mapping[char] || char;
                        };
                        
                        const normalA = normalizeChar(a);
                        const normalB = normalizeChar(b);
                        
                        // Sắp xếp theo thứ tự alphabet: D, Đ gần nhau; O, Ô, Ơ gần nhau
                        if (normalA !== normalB) {
                            return normalA.localeCompare(normalB);
                        }
                        
                        // Nếu cùng nhóm (D/Đ, O/Ô/Ơ), sắp xếp theo thứ tự: D < Đ, O < Ô < Ơ
                        const priority = { 'D': 0, 'Đ': 1, 'O': 0, 'Ô': 1, 'Ơ': 2 };
                        return (priority[a] || 0) - (priority[b] || 0);
                    });
                    sortedChars.forEach(char => {
                        // Thêm dòng phân cách
                        const separator = document.createElement('option');
                        separator.value = '';
                        separator.textContent = `-- ${char} --`;
                        separator.disabled = true;
                        separator.style.fontWeight = 'bold';
                        separator.style.backgroundColor = '#f0f0f0';
                        select.appendChild(separator);
                        
                        // Sắp xếp các item trong nhóm theo alphabet Việt Nam
                        grouped[char].sort((a, b) => {
                            // Lấy tên thực (không có tiền tố) để so sánh
                            const nameA = a.name.replace(/^(Tỉnh|Thành phố|Phường|Xã|Thị xã|Huyện|Thị trấn)\s+/, '');
                            const nameB = b.name.replace(/^(Tỉnh|Thành phố|Phường|Xã|Thị xã|Huyện|Thị trấn)\s+/, '');
                            
                            // Sử dụng localeCompare với locale tiếng Việt để sắp xếp đúng
                            return nameA.localeCompare(nameB, 'vi', { 
                                sensitivity: 'base',
                                ignorePunctuation: true,
                                numeric: true 
                            });
                        });
                        
                        grouped[char].forEach(it => {
                            const opt = document.createElement('option');
                            opt.value = it.name; // Luôn dùng name làm value để tránh confusion
                            opt.dataset.code = it.code || '';
                            opt.textContent = '  ' + it.name; // Thêm khoảng trắng để indent
                            select.appendChild(opt);
                        });
                    });
                } else {
                    // Đối với ít item, hiển thị bình thường
                    // Special handling: Add "Ở nước ngoài" first if exists
                    const overseasItem = items.find(it => it.name === 'Ở nước ngoài');
                    if (overseasItem) {
                        const opt = document.createElement('option');
                        opt.value = overseasItem.name;
                        opt.dataset.code = overseasItem.code || '';
                        opt.textContent = overseasItem.name;
                        opt.style.fontWeight = 'bold';
                        opt.style.backgroundColor = '#e3f2fd';
                        select.appendChild(opt);
                        
                        // Add separator
                        const separator = document.createElement('option');
                        separator.value = '';
                        separator.textContent = '─────────────────';
                        separator.disabled = true;
                        separator.style.color = '#999';
                        select.appendChild(separator);
                    }
                    
                    // Add other items (excluding overseas)
                    items.filter(it => it.name !== 'Ở nước ngoài').forEach(it => {
                        const opt = document.createElement('option');
                        opt.value = it.name; // Luôn dùng name làm value để tránh confusion
                        opt.dataset.code = it.code || '';
                        opt.textContent = it.name;
                        select.appendChild(opt);
                    });
                }

                // Restore current value (vì value đã là name nên chỉ cần match value)
                if (current && Array.from(select.options).some(o => o.value === current)) {
                    select.value = current;
                } else {
                    select.value = '';
                }
            }

            if (catalog.provinces && catalog.provinces.length) {
                const provincesByName = catalog.provinces.map(p => ({ code: p.code, name: p.name }));
                fillSelect(perProvince, provincesByName, false, '-- Chọn tỉnh/thành phố --');
                fillSelect(curProvince, provincesByName, false, '-- Chọn tỉnh/thành phố --');
                fillSelect(document.getElementById('hometownProvince'), provincesByName, false, '-- Chọn tỉnh/thành phố --');
                fillSelect(document.getElementById('birthCertProvince'), provincesByName, false, '-- Chọn tỉnh/thành phố --');
                fillSelect(document.getElementById('birthplaceProvince'), provincesByName, false, '-- Chọn tỉnh/thành phố --');
            }

            const saved = (() => { try { return JSON.parse(localStorage.getItem('addressFormData')||'{}'); } catch { return {}; } })();

            function restoreSelectWithFallback(selectEl, wardEl, keyPrefix) {
                if (!selectEl) return;
                const savedName = saved[keyPrefix] || '';
                const savedCode = saved[`${keyPrefix}__code`] || '';

                // 1) cố gắng match theo name (value)
                let found = Array.from(selectEl.options).find(o => o.value === savedName);
                // 2) nếu không có, match theo code
                if (!found && savedCode) {
                    found = Array.from(selectEl.options).find(o => (o.dataset && o.dataset.code) === savedCode);
                }

                if (found) {
                    selectEl.value = found.value;
                    // 🔧 FORCE DOM UPDATE - trigger change event to ensure UI sync
                    selectEl.dispatchEvent(new Event('change', { bubbles: true }));
                    console.log(`[RESTORE] ${keyPrefix} => name:"${found.value}", code:"${found.dataset.code||''}"`);
                } else {
                    selectEl.value = '';
                    selectEl.dispatchEvent(new Event('change', { bubbles: true }));
                    if (savedName || savedCode) console.warn(`[RESTORE] ${keyPrefix} NOT FOUND for savedName="${savedName}" savedCode="${savedCode}"`);
                }

                // gọi onProvinceChange để fill wards tương ứng
                if (typeof onProvinceChange === 'function') {
                    onProvinceChange({ provinceSelect: selectEl, wardSelect: wardEl });
                }

                // khôi phục ward nếu có
                if (wardEl) {
                    const wardName = saved[`${keyPrefix.replace('Province','Ward')}`] || '';
                    const wardCode = saved[`${keyPrefix.replace('Province','Ward')}__code`] || '';
                    let wfound = Array.from(wardEl.options).find(o => o.value === wardName);
                    if (!wfound && wardCode) {
                        wfound = Array.from(wardEl.options).find(o => (o.dataset && o.dataset.code) === wardCode);
                    }
                    if (wfound) {
                        wardEl.value = wfound.value;
                        wardEl.dispatchEvent(new Event('change', { bubbles: true }));
                        console.log(`[RESTORE] ${keyPrefix.replace('Province','Ward')} => "${wfound.value}"`);
                    } else {
                        // nếu không tìm thấy thì clear
                        wardEl.value = '';
                        wardEl.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            }

            // gọi restore cho từng cặp
            restoreSelectWithFallback(perProvince, perWard, 'permanentProvince');
            restoreSelectWithFallback(curProvince, curWard, 'currentProvince');
            restoreSelectWithFallback(document.getElementById('hometownProvince'), document.getElementById('hometownWard'), 'hometownProvince');
            restoreSelectWithFallback(document.getElementById('birthCertProvince'), document.getElementById('birthCertWard'), 'birthCertProvince');
            restoreSelectWithFallback(document.getElementById('birthplaceProvince'), document.getElementById('birthplaceWard'), 'birthplaceProvince');

            // 🔧 FINAL FORCE REFRESH - ensure UI sync after all restores
            setTimeout(() => {
                console.log('[FINAL CHECK] Force refreshing select displays...');
                [perProvince, curProvince].forEach(select => {
                    if (select && select.value) {
                        const currentValue = select.value;
                        select.value = '';
                        select.value = currentValue;
                        console.log(`[FINAL CHECK] ${select.name} final value: "${select.value}"`);
                    }
                });
            }, 100);

            function onProvinceChange(ctx) {
                const provinceName = ctx.provinceSelect.value;
                const provinceEntry = catalog.provinces.find(p => p.name === provinceName);
                const pcode = provinceEntry ? provinceEntry.code : null;
                const wards = pcode ? (catalog.wardsByProvince[pcode] || []) : [];
                
                fillSelect(ctx.wardSelect, wards, false, '-- Chọn phường/xã --');
                ctx.wardSelect.disabled = !wards.length;
            }

            if (perProvince && perWard) {
                perProvince.addEventListener('change', () => { 
                    onProvinceChange({ provinceSelect: perProvince, wardSelect: perWard }); 
                    // ✅ FIX: Delay saveFormData to avoid timing issues
                    setTimeout(saveFormData, 50); 
                });

                perWard.addEventListener('change', saveFormData);
            }
            if (curProvince && curWard) {
                curProvince.addEventListener('change', () => { 
                    onProvinceChange({ provinceSelect: curProvince, wardSelect: curWard }); 
                    setTimeout(saveFormData, 50); 
                });

                curWard.addEventListener('change', saveFormData);
            }

            if (hometownProvince && hometownWard) {
                hometownProvince.addEventListener('change', () => { 
                    onProvinceChange({ provinceSelect: hometownProvince, wardSelect: hometownWard }); 
                    setTimeout(saveFormData, 50); 
                });

                hometownWard.addEventListener('change', saveFormData);
            }

            if (birthCertProvince && birthCertWard) {
                birthCertProvince.addEventListener('change', () => { 
                    onProvinceChange({ provinceSelect: birthCertProvince, wardSelect: birthCertWard }); 
                    setTimeout(saveFormData, 50); 
                });

                birthCertWard.addEventListener('change', saveFormData);
            }

            if (birthplaceProvince && birthplaceWard) {
                birthplaceProvince.addEventListener('change', () => { 
                    onProvinceChange({ provinceSelect: birthplaceProvince, wardSelect: birthplaceWard }); 
                    setTimeout(saveFormData, 50); 
                });

                birthplaceWard.addEventListener('change', saveFormData);
            }

            const form = document.getElementById('addressForm');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                input.addEventListener('change', saveFormData);
                input.addEventListener('input', debounce(saveFormData, 500));
            });

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const requiredFields = this.querySelectorAll('[required]');
                let isValid = true;
                
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.style.borderColor = '#e74c3c';
                    } else {
                        field.style.borderColor = '#e0e0e0';
                    }
                });

                function checkHierarchy(p, w) {
                    if (p && !w) return false;
                    return true;
                }
                const perOK = checkHierarchy(perProvince?.value, perWard?.value);
                const curOK = checkHierarchy(curProvince?.value, curWard?.value);
                const hometownOK = checkHierarchy(hometownProvince?.value, hometownWard?.value);
                const birthCertOK = checkHierarchy(birthCertProvince?.value, birthCertWard?.value);
                const birthplaceOK = checkHierarchy(birthplaceProvince?.value, birthplaceWard?.value);
                
                if (!perOK || !curOK || !hometownOK || !birthCertOK || !birthplaceOK) {
                    isValid = false;
                    showNotification('Vui lòng chọn tỉnh và phường/xã cho tất cả các địa chỉ sau sáp nhập', 'error');
                }

                if (isValid) {

                    const formData = new FormData(this);
                    const addressData = {};
                    
                    formData.forEach((value, key) => {
                        addressData[key] = value;
                    });

                    localStorage.setItem('addressFormData', JSON.stringify(addressData));
                    
                    showNotification('Đã lưu thông tin địa chỉ! Chuyển sang trang tiếp theo...', 'success');

                    markPageCompleted(2);

                    showPageTransition(() => {
                        window.location.href = 'page3.html';
                    });
                } else {
                    showNotification('Vui lòng điền đầy đủ các trường bắt buộc!', 'error');
                }
            });

            // Load form data after select boxes are populated
            console.log('[DEBUG] Select boxes populated, loading form data...');
            setTimeout(() => {
                loadFormData();
            }, 100); // Small delay to ensure all DOM updates are complete
        });

        // Debug function - có thể gọi từ Console
        window.debugFormData = function() {
            const data = JSON.parse(localStorage.getItem('addressFormData') || '{}');
            console.log('=== DEBUG FORM DATA ===');
            console.log('localStorage data:', data);
            
            // Check current form values
            const form = document.getElementById('addressForm');
            const selects = form.querySelectorAll('select');
            console.log('Current form state:');
            selects.forEach(select => {
                const opt = select.options[select.selectedIndex];
                console.log(`${select.name}:`, {
                    value: select.value,
                    text: opt ? opt.textContent.trim() : 'none',
                    code: opt ? opt.dataset.code : 'none'
                });
            });
            
            // ✅ VALIDATION CHECK
            const locationFields = ['permanentProvince', 'permanentWard', 'currentProvince', 'currentWard', 'hometownProvince', 'hometownWard', 'birthplaceProvince', 'birthplaceWard', 'birthCertProvince', 'birthCertWard'];
            let hasCodeValue = false;
            locationFields.forEach(field => {
                if (data[field] && /^\d+$/.test(data[field].toString().trim())) {
                    console.error(`❌ ${field} = "${data[field]}" is CODE, not NAME!`);
                    hasCodeValue = true;
                } else if (data[field]) {
                    console.log(`✅ ${field} = "${data[field]}" is NAME (valid)`);
                }
            });
            
            if (hasCodeValue) {
                console.error('❌ VALIDATION FAILED: Some fields contain codes instead of names!');
            } else {
                console.log('✅ VALIDATION PASSED: All location fields contain names');
            }
            
            return data;
        };

        // Force reload data function - để test
        window.forceReloadData = function() {
            console.log('Force reloading form data...');
            loadFormData();
        };

        // Test save function
        window.testSave = function() {
            console.log('Testing save...');
            saveFormData();
            debugFormData();
        };

        // FINAL TEST FUNCTION - Kiểm tra toàn bộ flow
        window.finalValidationTest = function() {
            console.log('🔍 FINAL VALIDATION TEST');
            console.log('========================');
            
            // 1. Kiểm tra form hiện tại
            const form = document.getElementById('addressForm');
            const selects = form.querySelectorAll('select[name*="Province"], select[name*="Ward"]');
            
            console.log('1. Current form state:');
            let hasFormIssue = false;
            selects.forEach(select => {
                const opt = select.options[select.selectedIndex];
                if (opt && opt.value) {
                    const isCode = /^\d+$/.test(opt.value);
                    const isName = !isCode && opt.value.length > 2;
                    console.log(`   ${select.name}: "${opt.value}" (${isCode ? '❌ CODE' : isName ? '✅ NAME' : '⚠️ UNKNOWN'})`);
                    if (isCode) hasFormIssue = true;
                }
            });
            
            // 2. Test saveFormData
            console.log('2. Testing saveFormData...');
            saveFormData();
            
            // 3. Kiểm tra localStorage
            console.log('3. Checking localStorage...');
            const saved = JSON.parse(localStorage.getItem('addressFormData') || '{}');
            let hasStorageIssue = false;
            const locationFields = ['permanentProvince', 'permanentWard', 'currentProvince', 'currentWard', 'hometownProvince', 'hometownWard'];
            locationFields.forEach(field => {
                if (saved[field]) {
                    const isCode = /^\d+$/.test(saved[field]);
                    console.log(`   ${field}: "${saved[field]}" (${isCode ? '❌ CODE' : '✅ NAME'})`);
                    if (isCode) hasStorageIssue = true;
                }
            });
            
            // 4. Final result
            console.log('4. FINAL RESULT:');
            if (!hasFormIssue && !hasStorageIssue) {
                console.log('🎉 ✅ VALIDATION PASSED: All data is correct!');
                console.log('✅ Form values are names (not codes)');
                console.log('✅ localStorage contains names (not codes)');
                console.log('✅ Ready for submission to server');
            } else {
                console.log('❌ VALIDATION FAILED:');
                if (hasFormIssue) console.log('   - Form contains code values');
                if (hasStorageIssue) console.log('   - localStorage contains code values');
            }
            
            return { hasFormIssue, hasStorageIssue, passed: !hasFormIssue && !hasStorageIssue };
        };

        console.log('[DEBUG] Use debugFormData(), forceReloadData(), testSave(), finalValidationTest() in Console to check form state');

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            if (type === 'success') {
                notification.style.background = '#4CAF50';
            } else if (type === 'error') {
                notification.style.background = '#f44336';
            } else {
                notification.style.background = '#2196F3';
            }
            
            notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    

        function showPageTransition(callback) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('show');

            setTimeout(() => {
                if (callback) callback();
            }, 800);
        }

        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
