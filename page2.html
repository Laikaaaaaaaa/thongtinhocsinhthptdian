<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K√™ khai th√¥ng tin c·∫≠p nh·∫≠t CSDL ng√†nh - Trang 2 - THPT Dƒ© An</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/logo/favicon.svg?v=2025081301">
    <link rel="icon" type="image/png" sizes="32x32" href="/logo/favicon-32x32.png?v=2025081301">
    <link rel="icon" type="image/png" sizes="16x16" href="/logo/favicon-16x16.png?v=2025081301">
    <link rel="apple-touch-icon" sizes="180x180" href="/logo/apple-touch-icon.png?v=2025081301">
    <link rel="manifest" href="/logo/site.webmanifest?v=2025081301">
    <link rel="shortcut icon" href="/logo/favicon.ico?v=2025081301">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>

        // Fix back button spinner issue
        window.addEventListener('pageshow', function(event) {
            // Hide loading overlay when page is shown (including back button navigation)
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('show');
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            function canAccessPage(targetPage) {
                const progress = JSON.parse(localStorage.getItem('formProgress') || '{}');
                for (let i = 0; i < targetPage; i++) {
                    if (!progress[`page${i}`]) {
                        return false;
                    }
                }
                return true;
            }

            if (!canAccessPage(2)) {
                alert('B·∫°n ph·∫£i ho√†n th√†nh c√°c b∆∞·ªõc tr∆∞·ªõc ƒë√≥!');
                window.location.href = 'page1.html';
                return;
            }
        });

        function markPageCompleted(pageNumber) {
            const progress = JSON.parse(localStorage.getItem('formProgress') || '{}');
            progress[`page${pageNumber}`] = true;
            localStorage.setItem('formProgress', JSON.stringify(progress));
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .header {
            background: linear-gradient(135deg, #2196F3 0%, #1565C0 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            margin: 0 20px 20px 20px;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            gap: 2px;
        }

        .progress-segment {
            flex: 1;
            height: 100%;
            background: #e0e0e0;
            border-radius: 2px;
        }

        .progress-segment.active {
            background: linear-gradient(90deg, #4CAF50, #45a049);
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4CAF50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 10px;
            position: relative;
        }

        .step.inactive {
            background: #e0e0e0;
            color: #999;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 20px;
            height: 2px;
            background: #e0e0e0;
            transform: translateY(-50%);
        }

        .step:last-child::after {
            display: none;
        }

        .form-container {
            padding: 50px 60px;
        }

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 20px;
            color: white;
            font-size: 16px;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-group {
            margin-bottom: 25px;
            width: 100%;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.3;
            word-wrap: break-word;
            hyphens: auto;
        }

        .required {
            color: #e74c3c;
            margin-left: 3px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: #fafafa;
        }

        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        /* Style cho dropdown ph√¢n nh√≥m theo ch·ªØ c√°i */
        .form-control option[disabled] {
            font-weight: bold;
            background-color: #f0f0f0 !important;
            color: #666 !important;
            font-style: italic;
        }

        .form-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            align-items: start;
        }

        .form-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: start;
        }

        .form-row-3 .form-group,
        .form-row-2 .form-group {
            min-height: 85px;
        }

        .section-title {
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            margin: 30px 0 20px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .note {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 0 8px 8px 0;
        }

        .note p {
            color: #1565C0;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .note strong {
            color: #0D47A1;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-back {
            background: #6c757d;
            color: white;
        }

        .btn-back:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-submit {
            background: linear-gradient(135deg, #2196F3 0%, #1565C0 100%);
            color: white;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        .example-text {
            font-style: italic;
            color: #666;
            font-size: 13px;
            margin-top: 4px;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
                margin: 0;
                min-height: 100vh;
            }
            
            .container {
                margin: 0;
                max-width: none;
                width: 100%;
                height: 100%;
                min-height: 100vh;
                border-radius: 0;
                box-shadow: none;
                border: none;
            }
            
            .header {
                padding: 15px 15px;
            }
            
            .header h1 {
                font-size: 18px;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 13px;
            }
            
            .progress-bar {
                height: 4px;
                margin: 0;
            }
            
            .form-container {
                padding: 20px 15px;
            }
            
            .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }
            
            .form-control, select.form-control {
                padding: 10px 12px;
                font-size: 14px;
                border-width: 1.5px;
            }
            
            .form-row-2,
            .form-row-3 {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .note {
                padding: 12px;
                margin-bottom: 18px;
            }
            
            .note p {
                font-size: 12px;
                margin-bottom: 6px;
            }
            
            .btn {
                padding: 12px 18px;
                font-size: 14px;
            }
            
            .button-group {
                flex-direction: row;
                align-items: center;
                gap: 10px;
                margin-top: 25px;
                justify-content: space-between;
            }
            
            .btn-next, .btn-prev {
                width: 48%;
                max-width: none;
            }
            
            .loading-text {
                font-size: 14px;
            }
            
            .field-note {
                font-size: 12px;
            }
        }

        @media (max-width: 1024px) {
            .form-row-3 {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .form-row-3 .form-group:nth-child(3) {
                grid-column: 1 / -1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-map-marker-alt"></i> K√ä KHAI TH√îNG TIN C·∫¨P NH·∫¨T CSDL NG√ÄNH</h1>
            <p>II. TH√îNG TIN LI√äN QUAN ƒê·∫æN ƒê·ªäA DANH</p>
        </div>

        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">ƒêang chuy·ªÉn trang...</div>
        </div>

        <div class="progress-bar">
            <div class="progress-segment active"></div>
            <div class="progress-segment active"></div>
            <div class="progress-segment"></div>
            <div class="progress-segment"></div>
            <div class="progress-segment"></div>
        </div>

        <div class="form-container">
            <div id="catalogStatus" style="display:none; margin-bottom:12px; color:#1565C0; font-size:14px;">
                <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i danh m·ª•c ƒë·ªãa danh sau s√°p nh·∫≠p...
            </div>

            <div class="note">
                <p><strong>L∆ØU √ù QUAN TR·ªåNG:</strong></p>
                <p>‚Ä¢ C·∫≠p nh·∫≠t ƒë·ªãa danh m·ªõi sau s√°p nh·∫≠p t·ªânh, th√†nh ph·ªë (sau 1/7/2025)</p>
                <p>‚Ä¢ Nh·ªØng th√¥ng tin n√†o li√™n quan ƒë·∫øn gi·∫•y khai sinh th√¨ ph·∫£i ƒë√∫ng v·ªõi th√¥ng tin trong gi·∫•y khai sinh c·ªßa HS</p>
                <p>‚Ä¢ <strong>ƒê·ªÇ BI·∫æT CH√çNH X√ÅC ƒê·ªäA DANH M·ªöI VUI L√íNG TRUY C·∫¨P ·ª®NG D·ª§NG VNEID ƒê·ªÇ XEM</strong></p>
                <p>‚Ä¢ C√°c tr∆∞·ªùng c√≥ d·∫•u <span class="required">*</span> l√† b·∫Øt bu·ªôc</p>
                <p><strong>Email ƒë√£ ƒëƒÉng k√Ω:</strong> <span id="userEmailDisplay" style="color: #2196F3; font-weight: 600;"></span></p>
            </div>

            <form id="addressForm" action="#" method="POST">
                
                <div class="section-title"><i class="fas fa-home"></i> ƒê·ªäA CH·ªà TH∆Ø·ªúNG TR√ö</div>
                
                <div class="form-row-2">
                    <div class="form-group">
                        <label for="permanentProvince">T·ªânh/Th√†nh ph·ªë (sau s√°p nh·∫≠p) <span class="required">*</span></label>
                        <select id="permanentProvince" name="permanentProvince" class="form-control" required>
                            <option value="">-- Ch·ªçn t·ªânh/th√†nh ph·ªë --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="permanentWard">Ph∆∞·ªùng/X√£ (sau s√°p nh·∫≠p) <span class="required">*</span></label>
                        <select id="permanentWard" name="permanentWard" class="form-control" required disabled>
                            <option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="permanentHamlet">T·ªï/Th√¥n/X√≥m/Khu ph·ªë (ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫ - sau s√°p nh·∫≠p) <span class="required">*</span></label>
                    <input type="text" id="permanentHamlet" name="permanentHamlet" class="form-control" 
                           placeholder="VD: Khu ph·ªë ƒê√¥ng T√¢n" required>
                </div>

                <div class="form-group">
                    <label for="permanentStreet">S·ªë nh√†, t√™n ƒë∆∞·ªùng (ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫ - sau s√°p nh·∫≠p) <span class="required">*</span></label>
                    <input type="text" id="permanentStreet" name="permanentStreet" class="form-control" 
                           placeholder="VD: 123/45, ƒë∆∞·ªùng Nguy·ªÖn Du" required>
                    <div class="example-text">V√≠ d·ª•: 12/3 Nguy·ªÖn Du, Khu ph·ªë ƒê√¥ng T√¢n, Ph∆∞·ªùng Dƒ© An, TP. H·ªì Ch√≠ Minh</div>
                </div>

                <div class="section-title"><i class="fas fa-map"></i> TH√îNG TIN QU√ä QU√ÅN</div>

                <div class="form-row-2">
                    <div class="form-group">
                        <label for="hometownProvince">T·ªânh/Th√†nh ph·ªë (Qu√™ qu√°n - sau s√°p nh·∫≠p) <span class="required">*</span></label>
                        <select id="hometownProvince" name="hometownProvince" class="form-control" required>
                            <option value="">-- Ch·ªçn t·ªânh/th√†nh ph·ªë --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="hometownWard">Ph∆∞·ªùng/X√£ (Qu√™ qu√°n - sau s√°p nh·∫≠p) <span class="required">*</span></label>
                        <select id="hometownWard" name="hometownWard" class="form-control" required disabled>
                            <option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="hometownHamlet">T·ªï/Th√¥n/X√≥m/Khu ph·ªë (Theo qu√™ qu√°n - sau s√°p nh·∫≠p) <span class="required">*</span></label>
                    <input type="text" id="hometownHamlet" name="hometownHamlet" class="form-control" 
                           placeholder="VD: Th√¥n 1" required>
                </div>

                <div class="section-title"><i class="fas fa-certificate"></i> TH√îNG TIN N∆†I C·∫§P GI·∫§Y KHAI SINH</div>

                <div class="form-row-2">
                    <div class="form-group">
                        <label for="birthCertProvince">T·ªânh/Th√†nh ph·ªë (Gi·∫•y khai sinh - sau s√°p nh·∫≠p) <span class="required">*</span></label>
                        <select id="birthCertProvince" name="birthCertProvince" class="form-control" required>
                            <option value="">-- Ch·ªçn t·ªânh/th√†nh ph·ªë --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthCertWard">Ph∆∞·ªùng/X√£ (Gi·∫•y khai sinh - sau s√°p nh·∫≠p) <span class="required">*</span></label>
                        <select id="birthCertWard" name="birthCertWard" class="form-control" required disabled>
                            <option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>
                        </select>
                    </div>
                </div>

                <div class="section-title"><i class="fas fa-baby"></i> TH√îNG TIN N∆†I SINH</div>

                <div class="form-row-2">
                    <div class="form-group">
                        <label for="birthplaceProvince">T·ªânh/Th√†nh ph·ªë (N∆°i sinh - sau s√°p nh·∫≠p) <span class="required">*</span></label>
                        <select id="birthplaceProvince" name="birthplaceProvince" class="form-control" required>
                            <option value="">-- Ch·ªçn t·ªânh/th√†nh ph·ªë --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthplaceWard">Ph∆∞·ªùng/X√£ (N∆°i sinh - sau s√°p nh·∫≠p) <span class="required">*</span></label>
                        <select id="birthplaceWard" name="birthplaceWard" class="form-control" required disabled>
                            <option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>
                        </select>
                    </div>
                </div>

                <div class="section-title"><i class="fas fa-location-arrow"></i> TH√îNG TIN CH·ªñ ·ªû HI·ªÜN NAY</div>

                <div class="form-group">
                    <label for="currentAddressDetail">Ch·ªó ·ªü hi·ªán nay chi ti·∫øt (sau s√°p nh·∫≠p) <span class="required">*</span></label>
                    <textarea id="currentAddressDetail" name="currentAddressDetail" class="form-control" rows="3" 
                              placeholder="Ghi ƒë·∫ßy ƒë·ªß th√¥ng tin: s·ªë nh√†, t√™n ƒë∆∞·ªùng, khu ph·ªë/th√¥n, ph∆∞·ªùng/x√£, t·ªânh/th√†nh ph·ªë" required></textarea>
                    <div class="example-text">V√≠ d·ª•: 12/3 Nguy·ªÖn Du, Khu ph·ªë ƒê√¥ng T√¢n, Ph∆∞·ªùng Dƒ© An, TP. H·ªì Ch√≠ Minh</div>
                </div>

                <div class="form-row-2">
                    <div class="form-group">
                        <label for="currentProvince">T·ªânh/Th√†nh ph·ªë (sau s√°p nh·∫≠p) <span class="required">*</span></label>
                        <select id="currentProvince" name="currentProvince" class="form-control" required>
                            <option value="">-- Ch·ªçn t·ªânh/th√†nh ph·ªë --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="currentWard">Ph∆∞·ªùng/X√£ (sau s√°p nh·∫≠p) <span class="required">*</span></label>
                        <select id="currentWard" name="currentWard" class="form-control" required disabled>
                            <option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="currentHamlet">Th√¥n/X√≥m/Khu ph·ªë (Ch·ªó ·ªü hi·ªán nay - sau s√°p nh·∫≠p) <span class="required">*</span></label>
                    <input type="text" id="currentHamlet" name="currentHamlet" class="form-control" 
                           placeholder="VD: Khu ph·ªë ƒê√¥ng T√¢n" required>
                </div>

                <div class="button-group">
                    <a href="page1.html" class="btn btn-back">
                        <i class="fas fa-arrow-left"></i> QUAY L·∫†I
                    </a>
                    <button type="submit" class="btn btn-submit">
                        <i class="fas fa-arrow-right"></i> TI·∫æP THEO
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function saveFormData() {
            const formData = {};
            const form = document.getElementById('addressForm');
            if (!form) return;
            const inputs = form.querySelectorAll('input, select, textarea');

            inputs.forEach(input => {
                const tag = input.tagName.toLowerCase();

                if (tag === 'select') {
                    const selectedOption = input.options[input.selectedIndex];
                    if (selectedOption) {
                        // L∆∞u c·∫£ name (hi·ªÉn th·ªã) v√† code ƒë·ªÉ restore ch√≠nh x√°c
                        formData[input.name] = selectedOption.value || '';
                        formData[`${input.name}__code`] = selectedOption.dataset.code || '';
                        // debug
                        if (input.name.includes('Province') || input.name.includes('Ward')) {
                            console.log(`[SAVE] ${input.name}: "${formData[input.name]}", code="${formData[`${input.name}__code`]}", DOM_ID="${input.id}"`);
                            
                            // üö® CRITICAL DEBUG: Check for cross-contamination
                            if (input.name === 'permanentProvince' && input.id !== 'permanentProvince') {
                                console.error(`‚ùå MISMATCH: permanentProvince field has wrong DOM ID: ${input.id}`);
                            }
                            if (input.name === 'currentProvince' && input.id !== 'currentProvince') {
                                console.error(`‚ùå MISMATCH: currentProvince field has wrong DOM ID: ${input.id}`);
                            }
                        }
                    } else {
                        formData[input.name] = '';
                        formData[`${input.name}__code`] = '';
                    }
                } else {
                    // input/textarea: l∆∞u nguy√™n text
                    formData[input.name] = input.value || '';
                }
            });

            // l∆∞u object ƒë·∫ßy ƒë·ªß
            console.log('[DEBUG] Page2 saveFormData (with codes):', formData);
            localStorage.setItem('addressFormData', JSON.stringify(formData));
        }

        // üîß DEBUG HELPER: Global function ƒë·ªÉ test t·ª´ console
        window.debugClearAndReload = function() {
            localStorage.clear();
            console.log('[DEBUG] LocalStorage cleared, reloading page...');
            location.reload();
        };
        
        window.debugShowData = function() {
            console.log('[DEBUG] Current localStorage data:');
            console.log('addressFormData:', localStorage.getItem('addressFormData'));
            console.log('studentFormData:', localStorage.getItem('studentFormData'));
            console.log('healthFormData:', localStorage.getItem('healthFormData'));
            console.log('familyFormData:', localStorage.getItem('familyFormData'));
        };

        window.debugDOMCheck = function() {
            console.log('[DEBUG] DOM Elements Check:');
            const perP = document.getElementById('permanentProvince');
            const curP = document.getElementById('currentProvince');
            console.log('permanentProvince element:', perP);
            console.log('  - name:', perP?.name, 'id:', perP?.id, 'value:', perP?.value);
            console.log('currentProvince element:', curP);
            console.log('  - name:', curP?.name, 'id:', curP?.id, 'value:', curP?.value);
            
            // Check if they're the same object (major bug)
            if (perP === curP) {
                console.error('‚ùå CRITICAL BUG: permanentProvince and currentProvince are the same DOM element!');
            }
        };

        function loadFormData() {
            const savedData = localStorage.getItem('addressFormData');
            console.log('[DEBUG] Page2 loading data:', savedData);
            if (savedData) {
                const formData = JSON.parse(savedData);
                const form = document.getElementById('addressForm');
                
                Object.keys(formData).forEach(key => {
                    const element = form.querySelector(`[name="${key}"]`);
                    if (element) {
                        console.log('[DEBUG] Restoring', key, '=', formData[key]);
                        
                        if (element.tagName === 'SELECT') {
                            // X·ª≠ l√Ω select: th·ª≠ match theo value tr∆∞·ªõc, sau ƒë√≥ theo code
                            let found = Array.from(element.options).find(o => o.value === formData[key]);
                            if (!found) {
                                found = Array.from(element.options).find(o => o.dataset.code === formData[key]);
                            }
                            if (found) {
                                element.value = found.value;
                            } else {
                                element.value = '';
                            }
                            
                            // Trigger change event to update dependent dropdowns
                            element.dispatchEvent(new Event('change'));
                        } else {
                            element.value = formData[key];
                        }
                    }
                });
                
                showNotification('ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu ƒë√£ l∆∞u!', 'success');
            }
        }

        function clearSavedData() {
            localStorage.removeItem('addressFormData');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            if (type === 'success') {
                notification.style.background = '#4CAF50';
            } else if (type === 'error') {
                notification.style.background = '#f44336';
            } else {
                notification.style.background = '#2196F3';
            }
            
            notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        document.addEventListener('DOMContentLoaded', async function() {
            var email = localStorage.getItem('userEmail') || '';
            var el = document.getElementById('userEmailDisplay');
            if (el) el.textContent = email;

            loadFormData();
            window.addEventListener('pageshow', function(event) {
                // Ch·ªâ reload n·∫øu l√† back/forward navigation (persisted = true)
                if (event.persisted) {
                    console.log('[DEBUG] Page restored from cache, reloading data...');
                    setTimeout(() => {
                        loadFormData();
                    }, 100); // Delay ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ s·∫µn s√†ng
                }
            });

            const statusEl = document.getElementById('catalogStatus');
            const showStatus = (msg, isError=false) => {
                if (!statusEl) return;
                statusEl.style.display = 'block';
                statusEl.style.color = isError ? '#f44336' : '#1565C0';
                statusEl.innerHTML = `${isError ? '<i class="fas fa-exclamation-triangle"></i>' : '<i class="fas fa-spinner fa-spin"></i>'} ${msg}`;
            };
            showStatus('ƒêang t·∫£i danh m·ª•c ƒë·ªãa danh sau s√°p nh·∫≠p...');

            async function fetchCatalogWithFallback() {
                const urls = [
                    '/api/locations/latest?refresh=1',
                    '/api/locations/latest'
                ];
                for (const url of urls) {
                    try {
                        const res = await fetch(url, { cache: 'no-store' });
                        if (res.ok) {
                            const data = await res.json();
                            if (data && Array.isArray(data.provinces) && data.provinces.length) return data;
                        }
                    } catch (_) { /* try next */ }
                }
                return { provinces: [], wardsByProvince: {} };
            }

            function replaceSelectWithText(selectId, placeholder) {
                const sel = document.getElementById(selectId);
                if (!sel) return null;
                const input = document.createElement('input');
                input.type = 'text';
                input.id = sel.id;
                input.name = sel.name;
                input.className = sel.className;
                input.placeholder = placeholder || '';
                input.required = sel.required;
                input.value = sel.value || '';
                sel.parentNode.replaceChild(input, sel);
                return input;
            }

            let catalog = await fetchCatalogWithFallback();

            if (!catalog.provinces || catalog.provinces.length === 0 || 
                catalog.provinces.some(p => !p.name || p.name.trim() === '')) {
                console.log('Using fallback province list');
                catalog = {
                    provinces: [
                        { code: '01', name: 'Th√†nh ph·ªë H√† N·ªôi' },
                        { code: '79', name: 'Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
                        { code: '48', name: 'Th√†nh ph·ªë ƒê√† N·∫µng' },
                        { code: '92', name: 'Th√†nh ph·ªë C·∫ßn Th∆°' },
                        { code: '31', name: 'Th√†nh ph·ªë H·∫£i Ph√≤ng' },
                        { code: '74', name: 'T·ªânh B√¨nh D∆∞∆°ng' },
                        { code: '77', name: 'T·ªânh B√† R·ªãa - V≈©ng T√†u' },
                        { code: '75', name: 'T·ªânh ƒê·ªìng Nai' }
                    ],
                    wardsByProvince: {
                        '79': [
                            { code: '79001', name: 'Ph∆∞·ªùng S√†i G√≤n' },
                            { code: '79002', name: 'Ph∆∞·ªùng Dƒ© An' },
                            { code: '79003', name: 'Ph∆∞·ªùng T√¢n B√¨nh' },
                            { code: '79004', name: 'Ph∆∞·ªùng Th·ªß ƒê·ª©c' }
                        ]
                    }
                };
            }

            const perProvince = document.getElementById('permanentProvince');
            const perWard = document.getElementById('permanentWard');
            const curProvince = document.getElementById('currentProvince');
            const curWard = document.getElementById('currentWard');

            if (!catalog.provinces || catalog.provinces.length === 0) {

                showStatus('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh m·ª•c ƒë·ªãa danh. B·∫°n c√≥ th·ªÉ nh·∫≠p tay t√™n t·ªânh, ph∆∞·ªùng/x√£.', true);
                replaceSelectWithText('permanentProvince', 'Nh·∫≠p t·ªânh/th√†nh ph·ªë');
                replaceSelectWithText('permanentWard', 'Nh·∫≠p ph∆∞·ªùng/x√£');
                replaceSelectWithText('currentProvince', 'Nh·∫≠p t·ªânh/th√†nh ph·ªë');
                replaceSelectWithText('currentWard', 'Nh·∫≠p ph∆∞·ªùng/x√£');
                replaceSelectWithText('hometownProvince', 'Nh·∫≠p t·ªânh/th√†nh ph·ªë');
                replaceSelectWithText('hometownWard', 'Nh·∫≠p ph∆∞·ªùng/x√£');
                replaceSelectWithText('birthCertProvince', 'Nh·∫≠p t·ªânh/th√†nh ph·ªë');
                replaceSelectWithText('birthCertWard', 'Nh·∫≠p ph∆∞·ªùng/x√£');
                replaceSelectWithText('birthplaceProvince', 'Nh·∫≠p t·ªânh/th√†nh ph·ªë');
                replaceSelectWithText('birthplaceWard', 'Nh·∫≠p ph∆∞·ªùng/x√£');

                const form = document.getElementById('addressForm');
                form.querySelectorAll('input[name$="Province"],input[name$="Ward"]').forEach(el => {
                    el.addEventListener('input', debounce(saveFormData, 300));
                });

                setTimeout(() => statusEl && (statusEl.style.display = 'none'), 4000);
                return;
            } else {

                statusEl && (statusEl.style.display = 'none');
            }

            function fillSelect(select, items, withCode=false, placeholder='-- Ch·ªçn --') {
                if (!select) return;
                const current = select.value;
                select.innerHTML = '';

                const opt0 = document.createElement('option');
                opt0.value = '';
                opt0.textContent = placeholder;
                opt0.selected = true;
                select.appendChild(opt0);
                
                // Nh√≥m theo ch·ªØ c√°i ƒë·∫ßu cho t·∫•t c·∫£ dropdown c√≥ nhi·ªÅu h∆°n 10 items
                if (items.length > 10) {
                    const grouped = {};
                    items.forEach(it => {
                        // L·∫•y t√™n th·ª±c c·ªßa ƒë·ªãa danh (b·ªè ti·ªÅn t·ªë T·ªânh/Th√†nh ph·ªë/Ph∆∞·ªùng/X√£)
                        let displayName = it.name;
                        displayName = displayName.replace(/^(T·ªânh|Th√†nh ph·ªë|Ph∆∞·ªùng|X√£|Th·ªã x√£|Huy·ªán|Th·ªã tr·∫•n)\s+/, '');
                        
                        const firstChar = displayName.charAt(0).toUpperCase();
                        if (!grouped[firstChar]) {
                            grouped[firstChar] = [];
                        }
                        grouped[firstChar].push(it);
                    });
                    
                    // S·∫Øp x·∫øp c√°c k√Ω t·ª± theo th·ª© t·ª± alphabet Vi·ªát Nam chu·∫©n
                    const vietnameseAlphabet = ['A', 'ƒÇ', '√Ç', 'B', 'C', 'D', 'ƒê', 'E', '√ä', 'G', 'H', 'I', 'K', 'L', 'M', 'N', 'O', '√î', '∆†', 'P', 'Q', 'R', 'S', 'T', 'U', '∆Ø', 'V', 'X', 'Y'];
                    
                    const sortedChars = Object.keys(grouped).sort((a, b) => {
                        // Chu·∫©n h√≥a k√Ω t·ª± ƒë·ªÉ so s√°nh (b·ªè d·∫•u)
                        const normalizeChar = (char) => {
                            const mapping = {
                                '√Ä': 'A', '√Å': 'A', '·∫†': 'A', '·∫¢': 'A', '√É': 'A',
                                '√Ç': 'A', '·∫¶': 'A', '·∫§': 'A', '·∫¨': 'A', '·∫®': 'A', '·∫™': 'A',
                                'ƒÇ': 'A', '·∫∞': 'A', '·∫Æ': 'A', '·∫∂': 'A', '·∫≤': 'A', '·∫¥': 'A',
                                '√à': 'E', '√â': 'E', '·∫∏': 'E', '·∫∫': 'E', '·∫º': 'E',
                                '√ä': 'E', '·ªÄ': 'E', '·∫æ': 'E', '·ªÜ': 'E', '·ªÇ': 'E', '·ªÑ': 'E',
                                '√å': 'I', '√ç': 'I', '·ªä': 'I', '·ªà': 'I', 'ƒ®': 'I',
                                '√í': 'O', '√ì': 'O', '·ªå': 'O', '·ªé': 'O', '√ï': 'O',
                                '√î': 'O', '·ªí': 'O', '·ªê': 'O', '·ªò': 'O', '·ªî': 'O', '·ªñ': 'O',
                                '∆†': 'O', '·ªú': 'O', '·ªö': 'O', '·ª¢': 'O', '·ªû': 'O', '·ª†': 'O',
                                '√ô': 'U', '√ö': 'U', '·ª§': 'U', '·ª¶': 'U', '≈®': 'U',
                                '∆Ø': 'U', '·ª™': 'U', '·ª®': 'U', '·ª∞': 'U', '·ª¨': 'U', '·ªÆ': 'U',
                                '·ª≤': 'Y', '√ù': 'Y', '·ª¥': 'Y', '·ª∂': 'Y', '·ª∏': 'Y',
                                'ƒê': 'D'
                            };
                            return mapping[char] || char;
                        };
                        
                        const normalA = normalizeChar(a);
                        const normalB = normalizeChar(b);
                        
                        // S·∫Øp x·∫øp theo th·ª© t·ª± alphabet: D, ƒê g·∫ßn nhau; O, √î, ∆† g·∫ßn nhau
                        if (normalA !== normalB) {
                            return normalA.localeCompare(normalB);
                        }
                        
                        // N·∫øu c√πng nh√≥m (D/ƒê, O/√î/∆†), s·∫Øp x·∫øp theo th·ª© t·ª±: D < ƒê, O < √î < ∆†
                        const priority = { 'D': 0, 'ƒê': 1, 'O': 0, '√î': 1, '∆†': 2 };
                        return (priority[a] || 0) - (priority[b] || 0);
                    });
                    sortedChars.forEach(char => {
                        // Th√™m d√≤ng ph√¢n c√°ch
                        const separator = document.createElement('option');
                        separator.value = '';
                        separator.textContent = `-- ${char} --`;
                        separator.disabled = true;
                        separator.style.fontWeight = 'bold';
                        separator.style.backgroundColor = '#f0f0f0';
                        select.appendChild(separator);
                        
                        // S·∫Øp x·∫øp c√°c item trong nh√≥m theo alphabet Vi·ªát Nam
                        grouped[char].sort((a, b) => {
                            // L·∫•y t√™n th·ª±c (kh√¥ng c√≥ ti·ªÅn t·ªë) ƒë·ªÉ so s√°nh
                            const nameA = a.name.replace(/^(T·ªânh|Th√†nh ph·ªë|Ph∆∞·ªùng|X√£|Th·ªã x√£|Huy·ªán|Th·ªã tr·∫•n)\s+/, '');
                            const nameB = b.name.replace(/^(T·ªânh|Th√†nh ph·ªë|Ph∆∞·ªùng|X√£|Th·ªã x√£|Huy·ªán|Th·ªã tr·∫•n)\s+/, '');
                            
                            // S·ª≠ d·ª•ng localeCompare v·ªõi locale ti·∫øng Vi·ªát ƒë·ªÉ s·∫Øp x·∫øp ƒë√∫ng
                            return nameA.localeCompare(nameB, 'vi', { 
                                sensitivity: 'base',
                                ignorePunctuation: true,
                                numeric: true 
                            });
                        });
                        
                        grouped[char].forEach(it => {
                            const opt = document.createElement('option');
                            opt.value = it.name; // Lu√¥n d√πng name l√†m value ƒë·ªÉ tr√°nh confusion
                            opt.dataset.code = it.code || '';
                            opt.textContent = '  ' + it.name; // Th√™m kho·∫£ng tr·∫Øng ƒë·ªÉ indent
                            select.appendChild(opt);
                        });
                    });
                } else {
                    // ƒê·ªëi v·ªõi √≠t item, hi·ªÉn th·ªã b√¨nh th∆∞·ªùng
                    items.forEach(it => {
                        const opt = document.createElement('option');
                        opt.value = it.name; // Lu√¥n d√πng name l√†m value ƒë·ªÉ tr√°nh confusion
                        opt.dataset.code = it.code || '';
                        opt.textContent = it.name;
                        select.appendChild(opt);
                    });
                }

                // Restore current value (v√¨ value ƒë√£ l√† name n√™n ch·ªâ c·∫ßn match value)
                if (current && Array.from(select.options).some(o => o.value === current)) {
                    select.value = current;
                } else {
                    select.value = '';
                }
            }

            if (catalog.provinces && catalog.provinces.length) {
                const provincesByName = catalog.provinces.map(p => ({ code: p.code, name: p.name }));
                fillSelect(perProvince, provincesByName, false, '-- Ch·ªçn t·ªânh/th√†nh ph·ªë --');
                fillSelect(curProvince, provincesByName, false, '-- Ch·ªçn t·ªânh/th√†nh ph·ªë --');
                fillSelect(document.getElementById('hometownProvince'), provincesByName, false, '-- Ch·ªçn t·ªânh/th√†nh ph·ªë --');
                fillSelect(document.getElementById('birthCertProvince'), provincesByName, false, '-- Ch·ªçn t·ªânh/th√†nh ph·ªë --');
                fillSelect(document.getElementById('birthplaceProvince'), provincesByName, false, '-- Ch·ªçn t·ªânh/th√†nh ph·ªë --');
            }

            const saved = (() => { try { return JSON.parse(localStorage.getItem('addressFormData')||'{}'); } catch { return {}; } })();

            function restoreSelectWithFallback(selectEl, wardEl, keyPrefix) {
                if (!selectEl) return;
                const savedName = saved[keyPrefix] || '';
                const savedCode = saved[`${keyPrefix}__code`] || '';

                // 1) c·ªë g·∫Øng match theo name (value)
                let found = Array.from(selectEl.options).find(o => o.value === savedName);
                // 2) n·∫øu kh√¥ng c√≥, match theo code
                if (!found && savedCode) {
                    found = Array.from(selectEl.options).find(o => (o.dataset && o.dataset.code) === savedCode);
                }

                if (found) {
                    selectEl.value = found.value;
                    console.log(`[RESTORE] ${keyPrefix} => name:"${found.value}", code:"${found.dataset.code||''}"`);
                } else {
                    selectEl.value = '';
                    if (savedName || savedCode) console.warn(`[RESTORE] ${keyPrefix} NOT FOUND for savedName="${savedName}" savedCode="${savedCode}"`);
                }

                // g·ªçi onProvinceChange ƒë·ªÉ fill wards t∆∞∆°ng ·ª©ng
                if (typeof onProvinceChange === 'function') {
                    onProvinceChange({ provinceSelect: selectEl, wardSelect: wardEl });
                }

                // kh√¥i ph·ª•c ward n·∫øu c√≥
                if (wardEl) {
                    const wardName = saved[`${keyPrefix.replace('Province','Ward')}`] || '';
                    const wardCode = saved[`${keyPrefix.replace('Province','Ward')}__code`] || '';
                    let wfound = Array.from(wardEl.options).find(o => o.value === wardName);
                    if (!wfound && wardCode) {
                        wfound = Array.from(wardEl.options).find(o => (o.dataset && o.dataset.code) === wardCode);
                    }
                    if (wfound) {
                        wardEl.value = wfound.value;
                        console.log(`[RESTORE] ${keyPrefix.replace('Province','Ward')} => "${wfound.value}"`);
                    } else {
                        // n·∫øu kh√¥ng t√¨m th·∫•y th√¨ clear
                        wardEl.value = '';
                    }
                }
            }

            // g·ªçi restore cho t·ª´ng c·∫∑p
            restoreSelectWithFallback(perProvince, perWard, 'permanentProvince');
            restoreSelectWithFallback(curProvince, curWard, 'currentProvince');
            restoreSelectWithFallback(document.getElementById('hometownProvince'), document.getElementById('hometownWard'), 'hometownProvince');
            restoreSelectWithFallback(document.getElementById('birthCertProvince'), document.getElementById('birthCertWard'), 'birthCertProvince');
            restoreSelectWithFallback(document.getElementById('birthplaceProvince'), document.getElementById('birthplaceWard'), 'birthplaceProvince');

            function onProvinceChange(ctx) {
                const provinceName = ctx.provinceSelect.value;
                const provinceEntry = catalog.provinces.find(p => p.name === provinceName);
                const pcode = provinceEntry ? provinceEntry.code : null;
                const wards = pcode ? (catalog.wardsByProvince[pcode] || []) : [];
                
                fillSelect(ctx.wardSelect, wards, false, '-- Ch·ªçn ph∆∞·ªùng/x√£ --');
                ctx.wardSelect.disabled = !wards.length;
            }

            if (perProvince && perWard) {
                perProvince.addEventListener('change', () => { 
                    onProvinceChange({ provinceSelect: perProvince, wardSelect: perWard }); 
                    // ‚úÖ FIX: Delay saveFormData to avoid timing issues
                    setTimeout(saveFormData, 50); 
                });

                perWard.addEventListener('change', saveFormData);
            }
            if (curProvince && curWard) {
                curProvince.addEventListener('change', () => { 
                    onProvinceChange({ provinceSelect: curProvince, wardSelect: curWard }); 
                    setTimeout(saveFormData, 50); 
                });

                curWard.addEventListener('change', saveFormData);
            }

            if (hometownProvince && hometownWard) {
                hometownProvince.addEventListener('change', () => { 
                    onProvinceChange({ provinceSelect: hometownProvince, wardSelect: hometownWard }); 
                    setTimeout(saveFormData, 50); 
                });

                hometownWard.addEventListener('change', saveFormData);
            }

            if (birthCertProvince && birthCertWard) {
                birthCertProvince.addEventListener('change', () => { 
                    onProvinceChange({ provinceSelect: birthCertProvince, wardSelect: birthCertWard }); 
                    setTimeout(saveFormData, 50); 
                });

                birthCertWard.addEventListener('change', saveFormData);
            }

            if (birthplaceProvince && birthplaceWard) {
                birthplaceProvince.addEventListener('change', () => { 
                    onProvinceChange({ provinceSelect: birthplaceProvince, wardSelect: birthplaceWard }); 
                    setTimeout(saveFormData, 50); 
                });

                birthplaceWard.addEventListener('change', saveFormData);
            }

            const form = document.getElementById('addressForm');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                input.addEventListener('change', saveFormData);
                input.addEventListener('input', debounce(saveFormData, 500));
            });

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const requiredFields = this.querySelectorAll('[required]');
                let isValid = true;
                
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.style.borderColor = '#e74c3c';
                    } else {
                        field.style.borderColor = '#e0e0e0';
                    }
                });

                function checkHierarchy(p, w) {
                    if (p && !w) return false;
                    return true;
                }
                const perOK = checkHierarchy(perProvince?.value, perWard?.value);
                const curOK = checkHierarchy(curProvince?.value, curWard?.value);
                const hometownOK = checkHierarchy(hometownProvince?.value, hometownWard?.value);
                const birthCertOK = checkHierarchy(birthCertProvince?.value, birthCertWard?.value);
                const birthplaceOK = checkHierarchy(birthplaceProvince?.value, birthplaceWard?.value);
                
                if (!perOK || !curOK || !hometownOK || !birthCertOK || !birthplaceOK) {
                    isValid = false;
                    showNotification('Vui l√≤ng ch·ªçn t·ªânh v√† ph∆∞·ªùng/x√£ cho t·∫•t c·∫£ c√°c ƒë·ªãa ch·ªâ sau s√°p nh·∫≠p', 'error');
                }

                if (isValid) {

                    const formData = new FormData(this);
                    const addressData = {};
                    
                    formData.forEach((value, key) => {
                        addressData[key] = value;
                    });

                    localStorage.setItem('addressFormData', JSON.stringify(addressData));
                    
                    showNotification('ƒê√£ l∆∞u th√¥ng tin ƒë·ªãa ch·ªâ! Chuy·ªÉn sang trang ti·∫øp theo...', 'success');

                    markPageCompleted(2);

                    showPageTransition(() => {
                        window.location.href = 'page3.html';
                    });
                } else {
                    showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc!', 'error');
                }
            });
        });

        // Debug function - c√≥ th·ªÉ g·ªçi t·ª´ Console
        window.debugFormData = function() {
            const data = JSON.parse(localStorage.getItem('addressFormData') || '{}');
            console.log('=== DEBUG FORM DATA ===');
            console.log('localStorage data:', data);
            
            // Check current form values
            const form = document.getElementById('addressForm');
            const selects = form.querySelectorAll('select');
            console.log('Current form state:');
            selects.forEach(select => {
                const opt = select.options[select.selectedIndex];
                console.log(`${select.name}:`, {
                    value: select.value,
                    text: opt ? opt.textContent.trim() : 'none',
                    code: opt ? opt.dataset.code : 'none'
                });
            });
            
            // ‚úÖ VALIDATION CHECK
            const locationFields = ['permanentProvince', 'permanentWard', 'currentProvince', 'currentWard', 'hometownProvince', 'hometownWard', 'birthplaceProvince', 'birthplaceWard', 'birthCertProvince', 'birthCertWard'];
            let hasCodeValue = false;
            locationFields.forEach(field => {
                if (data[field] && /^\d+$/.test(data[field].toString().trim())) {
                    console.error(`‚ùå ${field} = "${data[field]}" is CODE, not NAME!`);
                    hasCodeValue = true;
                } else if (data[field]) {
                    console.log(`‚úÖ ${field} = "${data[field]}" is NAME (valid)`);
                }
            });
            
            if (hasCodeValue) {
                console.error('‚ùå VALIDATION FAILED: Some fields contain codes instead of names!');
            } else {
                console.log('‚úÖ VALIDATION PASSED: All location fields contain names');
            }
            
            return data;
        };

        // Force reload data function - ƒë·ªÉ test
        window.forceReloadData = function() {
            console.log('Force reloading form data...');
            loadFormData();
        };

        // Test save function
        window.testSave = function() {
            console.log('Testing save...');
            saveFormData();
            debugFormData();
        };

        // FINAL TEST FUNCTION - Ki·ªÉm tra to√†n b·ªô flow
        window.finalValidationTest = function() {
            console.log('üîç FINAL VALIDATION TEST');
            console.log('========================');
            
            // 1. Ki·ªÉm tra form hi·ªán t·∫°i
            const form = document.getElementById('addressForm');
            const selects = form.querySelectorAll('select[name*="Province"], select[name*="Ward"]');
            
            console.log('1. Current form state:');
            let hasFormIssue = false;
            selects.forEach(select => {
                const opt = select.options[select.selectedIndex];
                if (opt && opt.value) {
                    const isCode = /^\d+$/.test(opt.value);
                    const isName = !isCode && opt.value.length > 2;
                    console.log(`   ${select.name}: "${opt.value}" (${isCode ? '‚ùå CODE' : isName ? '‚úÖ NAME' : '‚ö†Ô∏è UNKNOWN'})`);
                    if (isCode) hasFormIssue = true;
                }
            });
            
            // 2. Test saveFormData
            console.log('2. Testing saveFormData...');
            saveFormData();
            
            // 3. Ki·ªÉm tra localStorage
            console.log('3. Checking localStorage...');
            const saved = JSON.parse(localStorage.getItem('addressFormData') || '{}');
            let hasStorageIssue = false;
            const locationFields = ['permanentProvince', 'permanentWard', 'currentProvince', 'currentWard', 'hometownProvince', 'hometownWard'];
            locationFields.forEach(field => {
                if (saved[field]) {
                    const isCode = /^\d+$/.test(saved[field]);
                    console.log(`   ${field}: "${saved[field]}" (${isCode ? '‚ùå CODE' : '‚úÖ NAME'})`);
                    if (isCode) hasStorageIssue = true;
                }
            });
            
            // 4. Final result
            console.log('4. FINAL RESULT:');
            if (!hasFormIssue && !hasStorageIssue) {
                console.log('üéâ ‚úÖ VALIDATION PASSED: All data is correct!');
                console.log('‚úÖ Form values are names (not codes)');
                console.log('‚úÖ localStorage contains names (not codes)');
                console.log('‚úÖ Ready for submission to server');
            } else {
                console.log('‚ùå VALIDATION FAILED:');
                if (hasFormIssue) console.log('   - Form contains code values');
                if (hasStorageIssue) console.log('   - localStorage contains code values');
            }
            
            return { hasFormIssue, hasStorageIssue, passed: !hasFormIssue && !hasStorageIssue };
        };

        console.log('[DEBUG] Use debugFormData(), forceReloadData(), testSave(), finalValidationTest() in Console to check form state');
    

        function showPageTransition(callback) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('show');

            setTimeout(() => {
                if (callback) callback();
            }, 800);
        }

        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
