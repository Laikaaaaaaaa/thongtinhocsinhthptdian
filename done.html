<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ho√†n th√†nh k√™ khai - THPT Dƒ© An</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/logo/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/logo/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/logo/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/logo/apple-touch-icon.png">
    <link rel="manifest" href="/logo/site.webmanifest">
    <link rel="shortcut icon" href="/logo/favicon.ico">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            const urlParams = new URLSearchParams(window.location.search);
            const emailParam = urlParams.get('email');
            const progress = JSON.parse(localStorage.getItem('formProgress') || '{}');

            if (!emailParam && !progress.page5) {
                alert('B·∫°n ch∆∞a ho√†n th√†nh qu√° tr√¨nh k√™ khai!');
                window.location.href = 'page.html';
                return;
            }
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .form-container {
            padding: 50px 60px;
            text-align: center;
        }

        .success-icon {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px auto;
            color: white;
            font-size: 60px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .success-message {
            margin-bottom: 30px;
        }

        .success-message h2 {
            color: #2E7D32;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .success-message p {
            color: #555;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .note {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 0 8px 8px 0;
            text-align: left;
        }

        .note p {
            color: #1565C0;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .note p:last-child {
            margin-bottom: 0;
        }

        .note strong {
            color: #0D47A1;
        }

        .required {
            color: #e74c3c;
            margin-left: 3px;
        }

        .info-display {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: left;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .info-value {
            color: #666;
            flex: 2;
            text-align: right;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-edit {
            background: #ff9800;
            color: white;
        }

        .btn-edit:hover {
            background: #f57c00;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
        }

        .btn-home {
            background: #6c757d;
            color: white;
        }

        .btn-home:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-view-more {
            background: #2196F3;
            color: white;
            margin-bottom: 15px;
        }

        .btn-view-more:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            overflow-y: auto;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, #2196F3 0%, #1565C0 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .section-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-content {
            padding: 20px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            align-items: start;
        }

        .detail-label {
            font-weight: 600;
            color: #555;
            padding: 8px 0;
        }

        .detail-value {
            color: #333;
            padding: 8px 0;
            word-break: break-word;
        }

        .detail-value.empty {
            color: #999;
            font-style: italic;
        }

        .btn-resubmit {
            background: linear-gradient(135deg, #2196F3 0%, #1565C0 100%);
            color: white;
            display: none;
        }

        .btn-resubmit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        .edit-mode .btn-resubmit {
            display: inline-flex;
        }

        .edit-mode .btn-edit {
            display: none;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: #fafafa;
        }

        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .form-control:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .timestamp {
            background: #e8f5e8;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 0 8px 8px 0;
            text-align: left;
        }

        .timestamp p {
            color: #2e7d32;
            font-size: 14px;
            margin: 0;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
                margin: 0;
                min-height: 100vh;
            }
            
            .container {
                margin: 0;
                max-width: none;
                width: 100%;
                height: 100%;
                min-height: 100vh;
                border-radius: 0;
                box-shadow: none;
                border: none;
            }
            
            .header h1 {
                font-size: 22px;
                margin-bottom: 8px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .form-container {
                padding: 20px 15px;
            }
            
            .success-icon {
                width: 80px;
                height: 80px;
                font-size: 40px;
                margin-bottom: 20px;
            }
            
            .success-message h2 {
                font-size: 20px;
                margin-bottom: 12px;
            }
            
            .success-message p {
                font-size: 14px;
                margin-bottom: 8px;
            }
            
            .note {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .note p {
                font-size: 13px;
                margin-bottom: 8px;
            }
            
            .timestamp {
                padding: 12px;
                margin-bottom: 20px;
            }
            
            .timestamp p {
                font-size: 13px;
            }
            
            .info-display {
                padding: 18px;
                margin-bottom: 20px;
            }
            
            .info-display h3 {
                font-size: 16px;
                margin-bottom: 15px;
            }
            
            .button-group {
                flex-direction: column;
                align-items: center;
                gap: 12px;
                margin-top: 25px;
            }

            .info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
                padding: 8px 0;
            }

            .info-value {
                text-align: left;
                font-size: 14px;
            }
            
            .info-label {
                font-size: 14px;
                font-weight: 600;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 14px;
                min-width: 140px;
                width: 100%;
                max-width: 280px;
            }
            
            .btn-view-more {
                padding: 10px 18px;
                font-size: 13px;
                margin-bottom: 12px;
            }

            .modal-content {
                width: 100%;
                height: 100%;
                max-width: none;
                max-height: none;
                margin: 0;
                border-radius: 0;
                position: fixed;
                top: 0;
                left: 0;
            }

            .modal-header {
                padding: 15px 20px;
                border-radius: 0;
            }

            .modal-header h2 {
                font-size: 18px;
            }

            .modal-body {
                padding: 15px;
                max-height: calc(100vh - 70px);
                overflow-y: auto;
            }
            
            .section-header {
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .section-content {
                padding: 15px;
            }

            .detail-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .detail-label {
                font-weight: 600;
                color: #2196F3;
                margin-bottom: 4px;
                font-size: 13px;
            }

            .detail-value {
                margin-bottom: 12px;
                padding-left: 0;
                font-size: 14px;
                color: #333;
            }
            
            .close {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-check-circle"></i> HO√ÄN TH√ÄNH K√ä KHAI</h1>
            <p>C·∫£m ∆°n b·∫°n ƒë√£ ho√†n th√†nh vi·ªác k√™ khai th√¥ng tin</p>
        </div>

        <div class="form-container">
            <div class="success-icon">
                <i class="fas fa-check"></i>
            </div>

            <div class="success-message">
                <h2>üéâ ƒê√£ n·ªôp th√†nh c√¥ng!</h2>
                <p>Th√¥ng tin c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o h·ªá th·ªëng.</p>
                <p>B·∫°n c√≥ th·ªÉ xem l·∫°i ho·∫∑c ch·ªânh s·ª≠a th√¥ng tin b√™n d∆∞·ªõi.</p>
            </div>

            <div class="timestamp">
                <p><i class="fas fa-clock"></i> <strong>Th·ªùi gian n·ªôp:</strong> <span id="submitTime">ƒêang t·∫£i...</span></p>
            </div>

            <div class="note">
                <p><i class="fas fa-info-circle"></i> <strong>L∆∞u √Ω quan tr·ªçng:</strong></p>
                <p>‚Ä¢ C·∫≠p nh·∫≠t ƒë·ªãa danh m·ªõi sau s√°p nh·∫≠p t·ªânh, th√†nh ph·ªë (sau 1/7/2025)</p>
                <p>‚Ä¢ Nh·ªØng th√¥ng tin n√†o li√™n quan ƒë·∫øn gi·∫•y khai sinh th√¨ ph·∫£i ƒë√∫ng v·ªõi th√¥ng tin trong gi·∫•y khai sinh c·ªßa HS</p>
                <p>‚Ä¢ ƒê·ªÇ BI·∫æT CH√çNH X√ÅC ƒê·ªäA DANH M·ªöI VUI L√íNG TRUY C·∫¨P ·ª®NG D·ª§NG VNEID ƒê·ªÇ XEM</p>
                <p>‚Ä¢ C√°c tr∆∞·ªùng c√≥ d·∫•u <span class="required">*</span> l√† b·∫Øt bu·ªôc</p>
            </div>

            <div class="info-display">
                <h3 style="margin-bottom: 20px; color: #333;"><i class="fas fa-user"></i> Th√¥ng tin ƒë√£ n·ªôp</h3>
                <div id="studentInfo">
                    <div class="info-row">
                        <div class="info-label">Email:</div>
                        <div class="info-value" id="displayEmail">ƒêang t·∫£i...</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">H·ªç v√† t√™n:</div>
                        <div class="info-value" id="displayName">ƒêang t·∫£i...</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">L·ªõp:</div>
                        <div class="info-value" id="displayClass">ƒêang t·∫£i...</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Ng√†y sinh:</div>
                        <div class="info-value" id="displayBirth">ƒêang t·∫£i...</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">S·ªë ƒëi·ªán tho·∫°i:</div>
                        <div class="info-value" id="displayPhone">ƒêang t·∫£i...</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-view-more" onclick="showDetailModal()">
                        <i class="fas fa-eye"></i> XEM TH√äM CHI TI·∫æT
                    </button>
                </div>
            </div>

            <div class="button-group">
                <a href="page.html" class="btn btn-edit" onclick="startFullEdit(event)">
                    <i class="fas fa-edit"></i> S·ª¨A L·∫†I TH√îNG TIN
                </a>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeDetailModal()">&times;</span>
                <h2><i class="fas fa-clipboard-list"></i> Th√¥ng tin chi ti·∫øt ƒë√£ n·ªôp</h2>
            </div>
            <div class="modal-body" id="modalBody">
                <div id="loadingDetail" style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #2196F3;"></i>
                    <p style="margin-top: 15px;">ƒêang t·∫£i th√¥ng tin chi ti·∫øt...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
    let currentData = {};

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            if (type === 'success') {
                notification.style.background = '#4CAF50';
            } else if (type === 'error') {
                notification.style.background = '#f44336';
            } else {
                notification.style.background = '#2196F3';
            }
            
            notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        async function loadSubmittedData() {

            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email') || localStorage.getItem('userEmail');
            
            if (!email) {
                showNotification('Kh√¥ng t√¨m th·∫•y th√¥ng tin. Chuy·ªÉn v·ªÅ trang ch·ªß...', 'error');
                setTimeout(() => window.location.href = 'page.html', 2000);
                return;
            }

            let apiData = null;
            try {
                const resp = await fetch(`/api/student-by-email?email=${encodeURIComponent(email)}`);
                if (resp.ok) {
                    const json = await resp.json();
                    apiData = json.student || null;
                }
            } catch (_) {}

            const studentData = JSON.parse(localStorage.getItem('studentFormData') || '{}');
            const addressData = JSON.parse(localStorage.getItem('addressFormData') || '{}');
            const healthData = JSON.parse(localStorage.getItem('healthFormData') || '{}');
            const deviceData = JSON.parse(localStorage.getItem('deviceFormData') || '{}');
            const familyData = JSON.parse(localStorage.getItem('familyFormData') || '{}');

            currentData = {
                email,
                ...studentData,
                ...addressData,
                ...healthData,
                ...deviceData,
                ...familyData
            };
            if (apiData) {
                // Merge database data with localStorage data, database takes priority for existing fields
                currentData = {
                    ...currentData,
                    ...apiData
                };
            }

            document.getElementById('displayEmail').textContent = email;
            document.getElementById('displayName').textContent = currentData.ho_ten || currentData.full_name || 'Ch∆∞a c·∫≠p nh·∫≠t';
            document.getElementById('displayClass').textContent = currentData.lop || currentData.class || 'Ch∆∞a c·∫≠p nh·∫≠t';
            
            // Format birth date to Vietnamese
            const formatBirthDate = (dateStr) => {
                if (!dateStr || dateStr === '' || dateStr === 'null' || dateStr === 'undefined') {
                    return 'Ch∆∞a c·∫≠p nh·∫≠t';
                }
                
                try {
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) {
                        return dateStr; // Return original if can't parse
                    }
                    return date.toLocaleDateString('vi-VN');
                } catch (error) {
                    return dateStr; // Return original if error
                }
            };
            
            document.getElementById('displayBirth').textContent = formatBirthDate(currentData.ngay_sinh || currentData.birth_date) || 'Ch∆∞a c·∫≠p nh·∫≠t';
            document.getElementById('displayPhone').textContent = currentData.sdt || currentData.phone || 'Ch∆∞a c·∫≠p nh·∫≠t';

            const parseServerTimeToLocal = (ts) => {
                if (!ts) return null;

                if (ts.includes('T')) {
                    const d = new Date(ts);
                    return isNaN(d) ? null : d;
                }

                const m = ts.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/);
                if (m) {
                    const isoUtc = ts.replace(' ', 'T') + 'Z';
                    const d = new Date(isoUtc);
                    return isNaN(d) ? null : d;
                }

                const d = new Date(ts);
                return isNaN(d) ? null : d;
            };

            const serverTime = apiData?.created_at;
            const localDate = parseServerTimeToLocal(serverTime) || new Date();
            document.getElementById('submitTime').textContent = localDate.toLocaleString('vi-VN');
        }

        async function startFullEdit(e) {
            if (e) e.preventDefault();
            const email = localStorage.getItem('userEmail') || new URLSearchParams(window.location.search).get('email');
            if (!email) {
                window.location.href = 'page.html';
                return;
            }
            localStorage.setItem('userEmail', email);

            try {
                const resp = await fetch(`/api/student-by-email?email=${encodeURIComponent(email)}`);
                const json = resp.ok ? await resp.json() : { student: null };
                const s = json.student;
                if (s) {

                    const parseDMY = (str) => {
                        if (!str || typeof str !== 'string') return { d: '', m: '', y: '' };
                        const parts = str.split(/[\/\-]/).map(p => p.trim());
                        const [d, m, y] = [parts[0] || '', parts[1] || '', parts[2] || ''];
                        return {
                            d: d ? d.padStart(2, '0') : '',
                            m: m ? m.padStart(2, '0') : '',
                            y: y || ''
                        };
                    };

                    const birthDate = s.ngay_sinh || s.birth_date || '';
                    const cccdDate = s.cccd_date || '';
                    const b = parseDMY(birthDate);
                    const c = parseDMY(cccdDate);

                    const studentFormData = {
                        fullName: s.ho_ten || s.full_name || '',
                        nickname: s.nickname || '',
                        class: s.lop || s.class || '',
                        birthDate: birthDate,

                        birthDay: b.d,
                        birthMonth: b.m,
                        birthYear: b.y,
                        gender: s.gioi_tinh || s.gender || '',
                        ethnicity: s.dan_toc || s.ethnicity || '',
                        nationality: s.nationality || '',
                        religion: s.ton_giao || s.religion || '',
                        phone: s.sdt || s.phone || '',
                        citizenId: s.citizen_id || '',
                        cccdDate: cccdDate,

                        cccdDay: c.d,
                        cccdMonth: c.m,
                        cccdYear: c.y,
                        cccdPlace: s.cccd_place || '',
                        personalId: s.personal_id || '',
                        passport: s.passport || '',
                        passportDate: s.passport_date || '',
                        passportPlace: s.passport_place || '',
                        organization: s.organization || ''
                    };
                    localStorage.setItem('studentFormData', JSON.stringify(studentFormData));

                    const addressFormData = {
                        permanentProvince: s.tinh_thanh || s.permanent_province || '',
                        permanentWard: s.permanent_ward || '',
                        permanentHamlet: s.permanent_hamlet || '',
                        permanentStreet: s.permanent_street || '',
                        hometownProvince: s.hometown_province || '',
                        hometownWard: s.hometown_ward || '',
                        hometownHamlet: s.hometown_hamlet || '',
                        birthCertProvince: s.birth_cert_province || '',
                        birthCertWard: s.birth_cert_ward || '',
                        birthplaceProvince: s.birthplace_province || '',
                        birthplaceWard: s.birthplace_ward || '',
                        currentAddressDetail: s.dia_chi || s.current_address_detail || '',
                        currentProvince: s.current_province || '',
                        currentWard: s.current_ward || '',
                        currentHamlet: s.current_hamlet || ''

                    };
                    localStorage.setItem('addressFormData', JSON.stringify(addressFormData));

                    const healthFormData = {
                        height: s.height || '',
                        weight: s.weight || '',
                        eyeDiseases: s.eye_diseases || '',
                        swimmingSkill: s.swimming_skill || ''
                    };
                    localStorage.setItem('healthFormData', JSON.stringify(healthFormData));

                    const deviceFormData = {
                        smartphone: s.smartphone || '',
                        computer: s.computer || ''
                    };
                    localStorage.setItem('deviceFormData', JSON.stringify(deviceFormData));

                    const familyFormData = {
                        fatherEthnicity: s.father_ethnicity || '',
                        motherEthnicity: s.mother_ethnicity || '',
                        fatherName: s.ho_ten_cha || s.father_name || '',
                        fatherJob: s.nghe_nghiep_cha || s.father_job || '',
                        fatherBirthYear: s.father_birth_year || '',
                        fatherPhone: s.father_phone || '',
                        fatherCCCD: s.father_cccd || '',
                        motherName: s.ho_ten_me || s.mother_name || '',
                        motherJob: s.nghe_nghiep_me || s.mother_job || '',
                        motherBirthYear: s.mother_birth_year || '',
                        motherPhone: s.mother_phone || '',
                        motherCCCD: s.mother_cccd || '',
                        guardianName: s.guardian_name || '',
                        guardianJob: s.guardian_job || '',
                        guardianBirthYear: s.guardian_birth_year || '',
                        guardianPhone: s.guardian_phone || '',
                        guardianCCCD: s.guardian_cccd || '',
                        guardianGender: s.guardian_gender || ''
                    };
                    localStorage.setItem('familyFormData', JSON.stringify(familyFormData));
                }
            } catch (err) {
                console.warn('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ server, s·∫Ω d√πng d·ªØ li·ªáu ƒëang c√≥ n·∫øu c√≥.');
            }

            window.location.href = 'page.html';
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadSubmittedData();
        });

        function showDetailModal() {
            if (!currentData || Object.keys(currentData).length === 0) {
                showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã', 'error');
                return;
            }
            
            document.getElementById('detailModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            renderDetailContent();
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeDetailModal();
            }
        }

        function renderDetailContent() {
            const modalBody = document.getElementById('modalBody');

            document.getElementById('loadingDetail').style.display = 'none';
            
            const sections = [
                {
                    title: 'I. TH√îNG TIN C√Å NH√ÇN',
                    icon: 'fas fa-user',
                    data: getPersonalInfo()
                },
                {
                    title: 'II. TH√îNG TIN ƒê·ªäA CH·ªà',
                    icon: 'fas fa-map-marker-alt',
                    data: getAddressInfo()
                },
                {
                    title: 'III. TH√îNG TIN S·ª®C KH·ªéE',
                    icon: 'fas fa-heartbeat',
                    data: getHealthInfo()
                },
                {
                    title: 'IV. THI·∫æT B·ªä H·ªåC TR·ª∞C TUY·∫æN',
                    icon: 'fas fa-laptop',
                    data: getDeviceInfo()
                },
                {
                    title: 'V. TH√îNG TIN GIA ƒê√åNH',
                    icon: 'fas fa-users',
                    data: getFamilyInfo()
                }
            ];

            let html = '';
            sections.forEach(section => {
                const sectionData = section.data.filter(item => item.label && (item.value || item.value === 0));
                if (sectionData.length > 0) {
                    html += `
                        <div class="section">
                            <div class="section-header">
                                <i class="${section.icon}"></i>
                                ${section.title}
                            </div>
                            <div class="section-content">
                                <div class="detail-grid">
                                    ${sectionData.map(item => `
                                        <div class="detail-label">${item.label}</div>
                                        <div class="detail-value">${item.value || 'Ch∆∞a ƒëi·ªÅn'}</div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            modalBody.innerHTML = html;
        }

        function getPersonalInfo() {
            const d = currentData;
            
            // Format gender to Vietnamese
            const formatGender = (gender) => {
                if (gender === 'male') return 'Nam';
                if (gender === 'female') return 'N·ªØ';
                return gender || '';
            };
            
            // Format date to Vietnamese
            const formatDate = (dateStr) => {
                if (!dateStr || dateStr === '' || dateStr === 'null' || dateStr === 'undefined') {
                    return '';
                }
                
                try {
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) {
                        return dateStr; // Return original if can't parse
                    }
                    return date.toLocaleDateString('vi-VN');
                } catch (error) {
                    return dateStr; // Return original if error
                }
            };
            
            return [
                { label: 'H·ªç v√† t√™n', value: d.ho_ten || d.fullName },
                { label: 'T√™n g·ªçi kh√°c', value: d.nickname },
                { label: 'L·ªõp', value: d.lop || d.class },
                { label: 'Kh·ªëi', value: d.khoi },
                { label: 'Ng√†y sinh', value: formatDate(d.ngay_sinh || d.birthDate) || (d.birthDay && d.birthMonth && d.birthYear ? `${d.birthDay}/${d.birthMonth}/${d.birthYear}` : '') },
                { label: 'Gi·ªõi t√≠nh', value: formatGender(d.gioi_tinh || d.gender) },
                { label: 'D√¢n t·ªôc', value: d.dan_toc || d.ethnicity },
                { label: 'Qu·ªëc t·ªãch', value: d.nationality },
                { label: 'T√¥n gi√°o', value: d.ton_giao || d.religion },
                { label: 'S·ªë ƒëi·ªán tho·∫°i', value: d.sdt || d.phone },
                { label: 'Email', value: d.email },
                { label: 'CCCD/CMND', value: d.citizenId },
                { label: 'Ng√†y c·∫•p CCCD', value: formatDate(d.cccdDate) || (d.cccdDay && d.cccdMonth && d.cccdYear ? `${d.cccdDay}/${d.cccdMonth}/${d.cccdYear}` : '') },
                { label: 'N∆°i c·∫•p CCCD', value: d.cccdPlace },
                { label: 'M√£ s·ªë c√° nh√¢n', value: d.personalId },
                { label: 'H·ªô chi·∫øu', value: d.passport },
                { label: 'Ng√†y c·∫•p h·ªô chi·∫øu', value: formatDate(d.passportDate) },
                { label: 'N∆°i c·∫•p h·ªô chi·∫øu', value: d.passportPlace },
                { label: 'Ngh·ªÅ nghi·ªáp', value: d.occupation },
                { label: 'T·ªï ch·ª©c', value: d.organization }
            ].filter(item => item.value !== undefined && item.value !== null && item.value !== '');
        }

        function getAddressInfo() {
            const d = currentData;
            return [
                { label: 'T·ªânh/Th√†nh Ph·ªë th∆∞·ªùng tr√∫', value: d.tinh_thanh || d.permanentProvince },
                { label: 'Ph∆∞·ªùng/X√£ th∆∞·ªùng tr√∫', value: d.permanentWard },
                { label: 'T·ªï/Th√¥n/X√≥m th∆∞·ªùng tr√∫', value: d.permanentHamlet },
                { label: 'S·ªë nh√†, ƒë∆∞·ªùng th∆∞·ªùng tr√∫', value: d.permanentStreet },
                { label: 'T·ªânh/Th√†nh Ph·ªë qu√™ qu√°n', value: d.hometownProvince },
                { label: 'X√£/Ph∆∞·ªùng qu√™ qu√°n', value: d.hometownWard },
                { label: 'T·ªï/Th√¥n/X√≥m qu√™ qu√°n', value: d.hometownHamlet },
                { label: 'T·ªânh/Th√†nh Ph·ªë hi·ªán t·∫°i', value: d.currentProvince },
                { label: 'Ph∆∞·ªùng/X√£ hi·ªán t·∫°i', value: d.currentWard },
                { label: 'T·ªï/Th√¥n/X√≥m hi·ªán t·∫°i', value: d.currentHamlet },
                { label: 'ƒê·ªãa ch·ªâ hi·ªán t·∫°i chi ti·∫øt', value: d.dia_chi || d.currentAddressDetail },
                { label: 'T·ªânh/Th√†nh Ph·ªë n∆°i sinh', value: d.birthplaceProvince },
                { label: 'Ph∆∞·ªùng/X√£ n∆°i sinh', value: d.birthplaceWard },
                { label: 'T·ªânh/Th√†nh Ph·ªë c·∫•p gi·∫•y khai sinh', value: d.birthCertProvince },
                { label: 'Ph∆∞·ªùng/X√£ c·∫•p gi·∫•y khai sinh', value: d.birthCertWard }
            ].filter(item => item.value !== undefined && item.value !== null && item.value !== '');
        }

        function getHealthInfo() {
            const d = currentData;

            const parseArrayField = (fieldValue) => {
                if (!fieldValue) return '';
                if (typeof fieldValue === 'string') {
                    try {
                        const parsed = JSON.parse(fieldValue);
                        return Array.isArray(parsed) ? parsed.join(', ') : fieldValue;
                    } catch (e) {
                        return fieldValue.split(',').map(x => x.trim()).filter(x => x).join(', ');
                    }
                }
                if (Array.isArray(fieldValue)) {
                    return fieldValue.join(', ');
                }
                return String(fieldValue);
            };
            
            return [
                { label: 'Chi·ªÅu cao', value: d.height ? d.height + ' cm' : '' },
                { label: 'C√¢n n·∫∑ng', value: d.weight ? d.weight + ' kg' : '' },
                { label: 'B·ªánh v·ªÅ m·∫Øt', value: parseArrayField(d.eyeDisease || d.eye_diseases) },
                { label: 'K·ªπ nƒÉng b∆°i l·ªôi', value: d.swimmingSkill || d.swimming_skill }
            ].filter(item => item.value !== undefined && item.value !== null && item.value !== '');
        }

        function getDeviceInfo() {
            const d = currentData;
            return [
                { label: 'Smartphone c·ªßa ph·ª• huynh', value: d.smartphone },
                { label: 'M√°y t√≠nh/laptop', value: d.computer }
            ].filter(item => item.value !== undefined && item.value !== null && item.value !== '');
        }

        function getFamilyInfo() {
            const d = currentData;
            return [
                { label: 'D√¢n t·ªôc cha', value: d.fatherEthnicity },
                { label: 'D√¢n t·ªôc m·∫π', value: d.motherEthnicity },
                { label: 'H·ªç t√™n cha', value: d.ho_ten_cha || d.fatherName },
                { label: 'Ngh·ªÅ nghi·ªáp cha', value: d.nghe_nghiep_cha || d.fatherJob },
                { label: 'NƒÉm sinh cha', value: d.fatherBirthYear },
                { label: 'S·ªë ƒëi·ªán tho·∫°i cha', value: d.fatherPhone },
                { label: 'CCCD/CMND cha', value: d.fatherCCCD },
                { label: 'H·ªç t√™n m·∫π', value: d.ho_ten_me || d.motherName },
                { label: 'Ngh·ªÅ nghi·ªáp m·∫π', value: d.nghe_nghiep_me || d.motherJob },
                { label: 'NƒÉm sinh m·∫π', value: d.motherBirthYear },
                { label: 'S·ªë ƒëi·ªán tho·∫°i m·∫π', value: d.motherPhone },
                { label: 'CCCD/CMND m·∫π', value: d.motherCCCD },
                { label: 'H·ªç t√™n ng∆∞·ªùi gi√°m h·ªô', value: d.guardianName },
                { label: 'Ngh·ªÅ nghi·ªáp ng∆∞·ªùi gi√°m h·ªô', value: d.guardianJob },
                { label: 'NƒÉm sinh ng∆∞·ªùi gi√°m h·ªô', value: d.guardianBirthYear },
                { label: 'S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi gi√°m h·ªô', value: d.guardianPhone },
                { label: 'CCCD/CMND ng∆∞·ªùi gi√°m h·ªô', value: d.guardianCCCD },
                { label: 'Gi·ªõi t√≠nh ng∆∞·ªùi gi√°m h·ªô', value: d.guardianGender }
            ].filter(item => item.value !== undefined && item.value !== null && item.value !== '');
        }

        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
