<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω h·ªçc sinh - THPT Dƒ© An</title>
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/logo/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/logo/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/logo/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/logo/apple-touch-icon.png">
  <link rel="manifest" href="/logo/site.webmanifest">
  <link rel="shortcut icon" href="/logo/favicon.ico">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
    .header { 
        background: linear-gradient(135deg, #456cc2 0%, #3f5cac 100%); 
        color: #fff; 
        padding: 24px; 
        text-align: center; 
        box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15);
    }
    .wrap { 
        max-width: 1200px; 
        margin: 24px auto; 
        background: #fff; 
        border-radius: 12px; 
        box-shadow: 0 8px 32px rgba(0,0,0,.08); 
        overflow: hidden; 
        border: 1px solid #f1f5f9;
    }
    .toolbar { 
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 16px;
        align-items: center;
        padding: 24px; 
        background: #fff; 
        border-bottom: 1px solid #e5e7eb; 
    }
    
    .toolbar-left {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .toolbar-center {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-self: center;
    }
    
    .toolbar-right {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-self: end;
    }
    /* Modern Button Styles - Clean outline design */
    .btn { 
        border: 1.5px solid #64748b; 
        background: transparent; 
        color: #64748b; 
        padding: 12px 20px; 
        border-radius: 8px; 
        font-weight: 500; 
        cursor: pointer; 
        display: inline-flex; 
        align-items: center; 
        gap: 8px; 
        font-size: 14px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: none;
        text-decoration: none;
        white-space: nowrap;
    }
    .btn:hover { 
        background: #64748b; 
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(100, 116, 139, 0.2);
    }
    .btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(100, 116, 139, 0.2);
    }
    
    .btn.primary { 
        border-color: #3b82f6;
        color: #3b82f6;
    }
    .btn.primary:hover { 
        background: #3b82f6;
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
    }
    
    .btn.secondary { 
        border-color: #10b981;
        color: #10b981;
    }
    .btn.secondary:hover { 
        background: #10b981;
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
    }
    .btn.danger { 
        border-color: #ef4444;
        color: #ef4444;
    }
    .btn.danger:hover { 
        background: #ef4444;
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
    }
    .btn.info { 
        border-color: #06b6d4;
        color: #06b6d4;
    }
    .btn.info:hover { 
        background: #06b6d4;
        color: white;
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.25);
    }
    .btn.warning { 
        border-color: #f59e0b;
        color: #f59e0b;
    }
    .btn.warning:hover { 
        background: #f59e0b;
        color: white;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.25);
    }
    .btn.bot { 
        border-color: #8b5cf6;
        color: #8b5cf6;
    }
    .btn.bot:hover { 
        background: #8b5cf6;
        color: white;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
    }
    
    .btn:disabled { 
        opacity: .5; 
        cursor: not-allowed; 
        transform: none;
        box-shadow: none;
        border-color: #d1d5db;
        color: #9ca3af;
    }
    .btn:disabled:hover {
        background: transparent;
        color: #9ca3af;
        transform: none;
        box-shadow: none;
    }
    
    /* Compact button variant */
    .btn.compact {
        padding: 8px 16px;
        font-size: 13px;
        border-radius: 6px;
    }
    
    /* Icon-only button variant */
    .btn.icon-only {
        padding: 12px;
        width: 44px;
        height: 44px;
        border-radius: 8px;
        justify-content: center;
    }
    
    /* Modern Refresh Button - Icon only, circular */
    .btn.refresh { 
        background: transparent;
        color: #6b7280;
        border: 1.5px solid #d1d5db;
        padding: 12px;
        border-radius: 10px;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: none;
    }
    .btn.refresh:hover { 
        color: #3b82f6;
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.05);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    .btn.refresh:active {
        transform: translateY(0) rotate(90deg);
    }
    
    /* Loading Spinner for buttons */
    .btn.loading {
        position: relative;
        color: transparent !important;
        pointer-events: none;
    }
    .btn.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        margin: -10px 0 0 -10px;
        width: 20px;
        height: 20px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: btnSpinner 0.8s linear infinite;
    }
    .btn.loading:hover {
        transform: none;
    }
    
    @keyframes btnSpinner {
        to { transform: rotate(360deg); }
    }
    
    /* Loading Overlay - Full screen like page transitions */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .loading-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-left: 4px solid #2196F3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        margin-top: 20px;
        color: white;
        font-size: 16px;
        text-align: center;
        font-weight: 500;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .bulk-actions {
        display: none;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        padding: 16px 24px;
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 8px;
        margin: 0 24px 16px 24px;
        box-shadow: 0 1px 3px rgba(245, 158, 11, 0.1);
    }
    
    .bulk-actions.show {
        display: flex;
    }

    .input { 
        padding: 12px 16px; 
        border: 1.5px solid #d1d5db; 
        border-radius: 8px; 
        width: 320px; 
        font-size: 14px; 
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        background: #fff;
    }
    .input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .input::placeholder {
        color: #9ca3af;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        animation: fadeIn 0.3s;
    }

    .modal-content {
        background-color: #fefefe;
        margin: 2% auto;
        padding: 0;
        border: none;
        border-radius: 8px;
        width: 95%;
        max-width: 1000px;
        max-height: 95vh;
        overflow-y: auto;
        animation: slideIn 0.3s;
    }

    .modal-header {
        background-color: #1976D2;
        color: white;
        padding: 20px;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.5em;
    }

    .close {
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.3s;
    }

    .close:hover {
        background-color: rgba(255,255,255,0.2);
    }

    .modal-body {
        padding: 0;
    }

    .section {
        margin-bottom: 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .section:last-child {
        border-bottom: none;
    }

    .section-header {
        background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
        color: white;
        padding: 15px 20px;
        font-weight: bold;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-content {
        padding: 20px;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px 30px;
        align-items: start;
    }

    .detail-label {
        font-weight: 600;
        color: #333;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .detail-value {
        color: #666;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
        word-wrap: break-word;
    }

    @media (max-width: 768px) {
        .toolbar {
            grid-template-columns: 1fr;
            gap: 16px;
            padding: 16px;
        }
        
        .toolbar-left, .toolbar-center, .toolbar-right {
            justify-self: stretch;
        }
        
        .toolbar-center {
            justify-self: stretch;
        }
        
        .toolbar-right {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .input {
            width: 100%;
        }
        
        .btn.compact {
            padding: 10px 14px;
            font-size: 13px;
        }
        
        .bulk-actions {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
            margin: 0 16px 16px 16px;
        }
        
        .wrap {
            margin: 16px;
            border-radius: 8px;
        }
        
        .modal-content {
            margin: 1% auto;
            width: 98%;
        }
        
        .detail-grid {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .detail-label {
            font-size: 0.9em;
        }
        
        .detail-value {
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        /* Export Modal Mobile */
        .export-modal-content {
            width: 98%;
            max-width: none;
            margin: 1% auto;
            max-height: 98vh;
            border-radius: 16px;
        }
        
        .export-modal-body {
            grid-template-columns: 1fr;
            gap: 24px;
            padding: 20px;
        }
        
        .file-preview-section {
            padding: 16px;
        }
        
        .file-info-grid {
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .export-modal-header {
            padding: 20px;
            border-radius: 16px 16px 0 0;
        }
        
        .export-modal-header h3 {
            font-size: 1.4em;
        }
        
        .export-buttons {
            flex-direction: column;
            gap: 12px;
            margin: 24px -20px -20px -20px;
            padding: 20px;
        }
        
        .export-class-grid {
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 8px;
            padding: 16px;
            max-height: 250px;
        }
        
        .export-radio-item {
            padding: 12px;
        }
        
        .export-option-group h4 {
            font-size: 1em;
        }
        
        .export-section {
            padding: 20px;
        }
        
        .export-option-group {
            padding: 16px;
        }
        
        .filename-input {
            font-size: 16px; /* Prevents zoom on iOS */
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    /* Export Options Modal - Enhanced Large Version */
    .export-modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(12px);
        animation: fadeIn 0.4s ease-out;
    }

    .export-modal-content {
        background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 100%);
        margin: 1% auto;
        border: none;
        border-radius: 24px;
        width: 95%;
        max-width: 1500px;
        max-height: 95vh;
        overflow: hidden;
        animation: slideInFromTop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 
            0 32px 96px rgba(0, 0, 0, 0.25),
            0 16px 32px rgba(0, 0, 0, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.6);
        position: relative;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    @keyframes modalSlideIn {
        from { 
            transform: translateY(-30px) scale(0.95); 
            opacity: 0; 
        }
        to { 
            transform: translateY(0) scale(1); 
            opacity: 1; 
        }
    }

    @keyframes slideInFromTop {
        from {
            transform: translateY(-100px) scale(0.9);
            opacity: 0;
        }
        to {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
    }

    .export-modal-header {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        padding: 28px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        position: relative;
        border-radius: 24px 24px 0 0;
        overflow: hidden;
    }
    
    .export-modal-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(145deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        border-radius: 24px 24px 0 0;
        pointer-events: none;
    }

    .export-modal-header h3 {
        margin: 0;
        font-size: 2em;
        color: white;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 16px;
        position: relative;
        z-index: 1;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .export-close {
        background: rgba(255,255,255,0.15);
        border: 1.5px solid rgba(255,255,255,0.25);
        color: white;
        font-size: 22px;
        cursor: pointer;
        padding: 10px;
        border-radius: 12px;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        z-index: 1;
    }

    .export-close:hover {
        background: rgba(255,255,255,0.25);
        border-color: rgba(255,255,255,0.4);
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }

    .export-modal-body {
        padding: 40px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        background: #ffffff;
        overflow-y: auto;
        max-height: calc(95vh - 120px);
    }
    
    .export-section {
        display: flex;
        flex-direction: column;
        gap: 28px;
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        padding: 28px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
    }

    .export-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #3b82f6, #10b981, #f59e0b, #ef4444);
        border-radius: 16px 16px 0 0;
    }
    
    .export-section.full-width {
        grid-column: 1 / -1;
        margin-top: 20px;
    }

    /* File Preview Section */
    .file-preview-section {
        background: linear-gradient(145deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px solid #0ea5e9;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        position: relative;
    }

    .file-preview-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        color: #0369a1;
        font-weight: 700;
        font-size: 1.1em;
    }

    .file-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 20px;
    }

    .file-info-item {
        background: rgba(255,255,255,0.7);
        padding: 16px;
        border-radius: 12px;
        border: 1px solid rgba(14, 165, 233, 0.2);
    }

    .file-info-label {
        font-size: 0.85em;
        font-weight: 600;
        color: #0369a1;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .file-info-value {
        font-size: 1.1em;
        font-weight: 700;
        color: #1e40af;
    }

    .filename-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #cbd5e1;
        border-radius: 12px;
        font-size: 14px;
        background: white;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .filename-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        transform: translateY(-1px);
    }

    .filename-preview {
        margin-top: 12px;
        padding: 12px 16px;
        background: linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        color: #475569;
        border: 1px solid #cbd5e1;
        word-break: break-all;
    }

    .data-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        margin-top: 16px;
    }

    .stat-card {
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        padding: 16px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .stat-number {
        font-size: 1.4em;
        font-weight: 800;
        color: #1e40af;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 0.8em;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .export-option-group {
        margin-bottom: 0;
        background: rgba(255,255,255,0.6);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid rgba(226, 232, 240, 0.8);
    }

    .export-option-group h4 {
        margin: 0 0 20px 0;
        color: #1e293b;
        font-size: 1.15em;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 12px;
        border-bottom: 2px solid #e2e8f0;
        position: relative;
    }

    .export-option-group h4::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 40px;
        height: 2px;
        background: linear-gradient(90deg, #3b82f6, #10b981);
        border-radius: 1px;
    }

    .export-radio-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .export-radio-item {
        display: flex;
        align-items: flex-start;
        gap: 14px;
        padding: 18px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        position: relative;
        overflow: hidden;
    }

    .export-radio-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
        transition: left 0.5s ease;
    }

    .export-radio-item:hover::before {
        left: 100%;
    }

    .export-radio-item:hover {
        background: linear-gradient(145deg, #f0f9ff 0%, #e0f2fe 100%);
        border-color: #3b82f6;
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.15);
        transform: translateY(-2px);
    }
    
    .export-radio-item.selected {
        border-color: #3b82f6;
        background: linear-gradient(145deg, #dbeafe 0%, #bfdbfe 100%);
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
        transform: translateY(-1px);
    }

    .export-radio-item input[type="radio"] {
        margin: 0;
        width: 18px;
        height: 18px;
        accent-color: #3b82f6;
        transform: scale(1.2);
    }

    .export-radio-item label {
        margin: 0;
        cursor: pointer;
        flex: 1;
        font-size: 0.95em;
        line-height: 1.5;
        color: #334155;
    }

    .export-radio-item label strong {
        color: #1e293b;
        font-weight: 700;
        font-size: 1.05em;
    }

    .export-radio-item label div {
        margin-top: 4px;
        font-size: 0.85em;
        color: #64748b;
        font-weight: 500;
    }

    .export-radio-item:hover {
        background-color: #f8fafc;
        border-color: #3b82f6;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }
    
    .export-radio-item.selected {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .export-radio-item.selected {
        background-color: #e9ecef;
        border-color: #666;
    }

    .export-radio-item input[type="radio"] {
        margin: 0;
    }

    .export-radio-item label {
        margin: 0;
        cursor: pointer;
        flex: 1;
        font-size: 0.9em;
    }

    .export-class-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        margin-top: 16px;
        max-height: 400px;
        overflow-y: auto;
        padding: 20px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        background: linear-gradient(145deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .export-class-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: white;
        border: 1.5px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .export-class-item:hover {
        border-color: #3b82f6;
        background: linear-gradient(145deg, #eff6ff 0%, #dbeafe 100%);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }

    .export-class-item input[type="checkbox"] {
        margin: 0;
        width: 16px;
        height: 16px;
        accent-color: #3b82f6;
    }

    .export-class-item label {
        margin: 0;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        flex: 1;
        color: #374151;
    }
    
    .export-class-item input[type="checkbox"]:checked + label {
        font-weight: 700;
        color: #3b82f6;
    }

    .export-buttons {
        display: flex;
        gap: 16px;
        justify-content: center;
        margin-top: 32px;
        padding: 32px 0;
        border-top: 2px solid #e2e8f0;
        grid-column: 1 / -1;
        background: linear-gradient(145deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 0 0 16px 16px;
        margin: 32px -40px -40px -40px;
        padding: 24px 40px;
    }

    .export-btn {
        padding: 12px 20px;
        border: 1.5px solid #d1d5db;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        color: #64748b;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        position: relative;
        overflow: hidden;
    }

    .export-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s ease;
    }

    .export-btn:hover::before {
        left: 100%;
    }

    .export-btn.primary {
        border-color: #3b82f6;
        color: white;
        background: linear-gradient(145deg, #3b82f6 0%, #1d4ed8 100%);
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
    }

    .export-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
    }

    .export-btn.secondary {
        border-color: #10b981;
        color: #10b981;
        background: linear-gradient(145deg, #ffffff 0%, #f0fdf4 100%);
    }

    .export-btn.secondary:hover {
        background: linear-gradient(145deg, #10b981 0%, #059669 100%);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
    }

    .export-btn.warning {
        border-color: #f59e0b;
        color: #f59e0b;
        background: linear-gradient(145deg, #ffffff 0%, #fffbeb 100%);
    }

    .export-btn.warning:hover {
        background: linear-gradient(145deg, #f59e0b 0%, #d97706 100%);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(245, 158, 11, 0.25);
    }

    .export-btn.success {
        border-color: #10b981;
        color: white;
        background: linear-gradient(145deg, #10b981 0%, #059669 100%);
    }

    .export-btn.success:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.35);
    }

    .export-btn.purple {
        border-color: #8b5cf6;
        color: white;
        background: linear-gradient(145deg, #8b5cf6 0%, #7c3aed 100%);
    }

    .export-btn.purple:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(139, 92, 246, 0.35);
    }

    /* Export Summary Styles */
    .export-summary {
        grid-column: 1 / -1;
        margin-top: 24px;
        padding: 20px;
        background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
    }

    .summary-card h4 {
        margin: 0 0 16px 0;
        color: #1e293b;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .summary-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .summary-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .summary-item i {
        color: #3b82f6;
        font-size: 16px;
        width: 20px;
    }

    /* Template Modal Styles */
    .templates-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    .template-card {
        padding: 20px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    }

    .template-card:hover {
        border-color: #3b82f6;
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
    }

    .template-card i {
        font-size: 32px;
        color: #3b82f6;
        margin-bottom: 12px;
    }

    .template-card h4 {
        margin: 0 0 8px 0;
        color: #1e293b;
        font-size: 16px;
    }

    .template-card p {
        margin: 0;
        color: #64748b;
        font-size: 14px;
        line-height: 1.4;
    }

    /* Advanced filter styles */
    .file-preview-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        font-weight: 600;
        color: #1e293b;
    }

    .file-preview-header i {
        color: #3b82f6;
    }

    /* Enhanced button styles */
    .export-btn i {
        font-size: 14px;
    }

    .export-buttons .export-btn {
        min-width: 140px;
        justify-content: center;
    }

    /* Notification animations */
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    /* Enhanced hover effects */
    .export-radio-item:hover {
        background: #f8fafc;
        border-color: #3b82f6;
    }

    .export-radio-item input[type="radio"]:checked + label strong i {
        animation: bounce 0.6s ease;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }
        40% {
            transform: translateY(-4px);
        }
        60% {
            transform: translateY(-2px);
        }
    }

    /* Active state styles for class selection buttons */
    .export-btn.active {
        background: linear-gradient(145deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border-color: #3b82f6;
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        transform: translateY(-1px);
    }

    .export-btn.active::after {
        content: '‚úì';
        margin-left: 8px;
        font-weight: bold;
    }

    .export-btn.grade-10.active {
        background: linear-gradient(145deg, #3b82f6 0%, #1e3a8a 100%);
        border-color: #3b82f6;
    }

    .export-btn.grade-11.active {
        background: linear-gradient(145deg, #10b981 0%, #047857 100%);
        border-color: #10b981;
    }

    .export-btn.grade-12.active {
        background: linear-gradient(145deg, #f59e0b 0%, #d97706 100%);
        border-color: #f59e0b;
    }

    .export-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .export-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .export-btn.secondary {
        border-color: #10b981;
        color: #10b981;
    }

    .export-btn.secondary:hover {
        background: #10b981;
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
        transform: translateY(-1px);
    }
    
    .export-btn:hover {
        background: #64748b;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(100, 116, 139, 0.2);
    }

    .class-group-header {
        grid-column: 1 / -1;
        font-weight: 700;
        color: #1f2937;
        margin: 16px 0 8px 0;
        font-size: 16px;
        text-align: center;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .class-group-header::before {
        content: 'üìö';
        font-size: 18px;
    }
    .stats { 
        display: flex; 
        gap: 16px; 
        align-items: center; 
        font-weight: 600; 
        color: #374151;
        background: #ffffff;
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    /* Pagination styles */
    .pagination-wrapper { 
        padding: 20px; 
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); 
        border-top: 1px solid #e2e8f0; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }
    .pagination { display: flex; gap: 6px; align-items: center; }
    .pagination button { 
        border: 1px solid #d1d5db; 
        background: #ffffff; 
        color: #374151; 
        padding: 10px 14px; 
        border-radius: 6px; 
        cursor: pointer; 
        font-size: 14px; 
        font-weight: 500;
        transition: all 0.2s ease;
    }
    .pagination button:hover { 
        background: #f3f4f6; 
        border-color: #9ca3af;
        transform: translateY(-1px);
    }
    .pagination button.active { 
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); 
        color: #fff; 
        border-color: #2563eb; 
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }
    .pagination button:disabled { 
        opacity: 0.5; 
        cursor: not-allowed; 
        transform: none;
    }
    .pagination-info { 
        font-size: 14px; 
        color: #6b7280; 
        font-weight: 500;
    }
    
    .table { 
        width: 100%; 
        border-collapse: collapse; 
        margin: 0;
        background: #fff;
    }
    th, td { 
        padding: 16px 12px; 
        border-bottom: 1px solid #f1f5f9; 
        text-align: left; 
        font-size: 14px; 
        vertical-align: middle;
    }
    th { 
        background: #f8fafc; 
        font-weight: 600; 
        color: #374151;
        border-bottom: 1px solid #e2e8f0;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    tr { 
        transition: background-color 0.15s ease;
    }
    tr:hover { 
        background: #f8fafc; 
    }
    tbody tr:nth-child(even) {
        background: #fafbfc;
    }
    tbody tr:nth-child(even):hover {
        background: #f1f5f9;
    }
    .cell-actions { 
        display: flex; 
        gap: 6px;
        justify-content: center;
        align-items: center;
        padding: 8px;
    }
    .empty { 
        text-align: center; 
        color: #6b7280; 
        padding: 48px; 
        font-style: italic;
    }
  </style>
  <script>
    // Loading Overlay Functions
    function showLoadingOverlay(text = 'ƒêang x·ª≠ l√Ω...') {
      const overlay = document.getElementById('loadingOverlay');
      const textElement = document.getElementById('loadingText');
      textElement.textContent = text;
      overlay.classList.add('show');
    }
    
    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.classList.remove('show');
    }

    // File Preview Functions
    async function updateFilePreview() {
      try {
        const exportType = document.querySelector('input[name="exportType"]:checked')?.value || 'all';
        const exportFormat = document.querySelector('input[name="exportFormat"]:checked')?.value || 'xlsx';
        const customTitle = document.getElementById('customTitle')?.value || 'Danh s√°ch h·ªçc sinh THPT Dƒ© An';
      
      // Build scope text based on selections
      let scopeText = '';
      if (exportType === 'all') {
        scopeText = 'T·∫•t c·∫£ h·ªçc sinh';
      } else if (exportType === 'grade') {
        const selectedGrade = document.querySelector('input[name="gradeType"]:checked')?.value;
        scopeText = selectedGrade ? `Kh·ªëi ${selectedGrade}` : 'Ch∆∞a ch·ªçn kh·ªëi';
      } else if (exportType === 'class') {
        const selectedClasses = document.querySelectorAll('input[name="selectedClasses"]:checked');
        scopeText = selectedClasses.length > 0 ? `${selectedClasses.length} l·ªõp ƒë∆∞·ª£c ch·ªçn` : 'Ch∆∞a ch·ªçn l·ªõp';
      } else if (exportType === 'custom') {
        scopeText = 'L·ªçc t√πy ch·ªânh';
      }
      
      // Add filter info to scope
      const provinceFilter = document.getElementById('provinceFilter');
      const ethnicityFilter = document.getElementById('ethnicityFilter');
      
      let filters = [];
      if (provinceFilter?.value) {
        filters.push(`üìç ${provinceFilter.value}`);
      }
      if (ethnicityFilter?.value) {
        filters.push(`üè¥ ${ethnicityFilter.value}`);
      }
      
      if (filters.length > 0) {
        scopeText += ` (${filters.join(', ')})`;
      }
      
      // Fetch actual count from server
      try {
        document.getElementById('recordsInfo').textContent = 'ƒêang t√≠nh...';
        document.getElementById('sizeInfo').textContent = 'ƒêang t√≠nh...';
        
        const params = new URLSearchParams();
        params.append('type', exportType);
        
        if (exportType === 'grade') {
          const selectedGrade = document.querySelector('input[name="gradeType"]:checked');
          if (selectedGrade) params.append('grade', selectedGrade.value);
        } else if (exportType === 'class') {
          const selectedClasses = [];
          document.querySelectorAll('input[name="selectedClasses"]:checked').forEach(checkbox => {
            selectedClasses.push(checkbox.value);
          });
          if (selectedClasses.length > 0) {
            params.append('classes', selectedClasses.join(','));
          }
        } else if (exportType === 'custom') {
          // Add custom filters
          const genderFilters = [];
          const genderCheckboxes = document.querySelectorAll('#customFilters input[value="Nam"], #customFilters input[value="N·ªØ"]');
          genderCheckboxes.forEach(cb => {
            if (cb.checked) genderFilters.push(cb.value);
          });
          if (genderFilters.length > 0) {
            params.append('gender', genderFilters.join(','));
          }
          
          const fromYearInput = document.getElementById('fromYear');
          const toYearInput = document.getElementById('toYear');
          if (fromYearInput?.value) params.append('fromYear', fromYearInput.value);
          if (toYearInput?.value) params.append('toYear', toYearInput.value);
          
          const phoneCheckbox = document.getElementById('hasPhoneFilter');
          if (phoneCheckbox?.checked) params.append('hasPhone', 'true');
        }
        
        // Add province and ethnicity filters for ALL types
        if (provinceFilter?.value) {
          params.append('province', provinceFilter.value);
        }
        if (ethnicityFilter?.value) {
          params.append('ethnicity', ethnicityFilter.value);
        }
        
        const response = await fetch(`/api/export-count?${params.toString()}`);
        const data = await response.json();
        
        if (response.ok) {
          const actualRecords = data.count;
          
          // Calculate estimated file size based on actual records
          const estimatedSizeKB = calculateEstimatedFileSize(actualRecords, exportFormat);
          const sizeText = formatFileSize(estimatedSizeKB * 1024);
          
          // Generate filename
          const filename = generateFileName(customTitle, exportType, exportFormat);
          
          // Update preview
          updateFilePreviewDisplay(filename, sizeText, actualRecords, scopeText, exportFormat);
        } else {
          console.error('Error fetching count:', data.error);
          // Fallback to old estimation method
          const totalStudents = parseInt(document.getElementById('total')?.textContent || 0);
          let estimatedRecords = exportType === 'all' ? totalStudents : Math.floor(totalStudents * 0.7);
          const estimatedSizeKB = calculateEstimatedFileSize(estimatedRecords, exportFormat);
          const sizeText = formatFileSize(estimatedSizeKB * 1024);
          const filename = generateFileName(customTitle, exportType, exportFormat);
          updateFilePreviewDisplay(filename, sizeText, estimatedRecords, scopeText, exportFormat);
        }
        
      } catch (error) {
        console.error('Error updating file preview:', error);
        // Fallback to old estimation method
        const totalStudents = parseInt(document.getElementById('total')?.textContent || 0);
        let estimatedRecords = exportType === 'all' ? totalStudents : Math.floor(totalStudents * 0.7);
        const estimatedSizeKB = calculateEstimatedFileSize(estimatedRecords, exportFormat);
        const sizeText = formatFileSize(estimatedSizeKB * 1024);
        const filename = generateFileName(customTitle, exportType, exportFormat);
        updateFilePreviewDisplay(filename, sizeText, estimatedRecords, scopeText, exportFormat);
      }
      } catch (error) {
        console.error('Error in updateFilePreview outer:', error);
        // Final fallback display
        document.getElementById('recordsInfo').textContent = 'L·ªói t√≠nh to√°n';
        document.getElementById('sizeInfo').textContent = 'Kh√¥ng x√°c ƒë·ªãnh';
      }
    }

    function calculateEstimatedFileSize(records, format) {
      const baseSize = {
        'xlsx': 25, // KB base size
        'csv': 5,
        'pdf': 50,
        'json': 15
      };
      
      const recordSize = {
        'xlsx': 2.5, // KB per record
        'csv': 1.2,
        'pdf': 3.5,
        'json': 2.0
      };
      
      return Math.ceil(baseSize[format] + (records * recordSize[format]));
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function generateFileName(title, type, format) {
      let filename = title.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
        .replace(/[^a-z0-9\s]/g, '')
        .replace(/\s+/g, '_');
      
      if (type === 'grade') {
        const grade = document.querySelector('input[name="gradeType"]:checked')?.value;
        if (grade) filename += `_khoi_${grade}`;
      } else if (type === 'class') {
        const selectedClasses = document.querySelectorAll('input[name="selectedClasses"]:checked');
        if (selectedClasses.length === 1) {
          filename += `_lop_${selectedClasses[0].value}`;
        } else if (selectedClasses.length > 1) {
          filename += `_${selectedClasses.length}_lop`;
        }
      } else if (type === 'custom') {
        filename += '_tuy_chinh';
      } else {
        filename += '_tat_ca';
      }
      
      const timestamp = new Date().toISOString().slice(0,16).replace('T', '_').replace(':', '-');
      return `${filename}_${timestamp}.${format}`;
    }

    function updateFilePreviewDisplay(filename, size, records, scope, format) {
      // Update filename preview
      const filenamePreview = document.getElementById('filenamePreview');
      if (filenamePreview) {
        filenamePreview.textContent = filename;
      }
      
      // Update file info
      const formatInfo = document.getElementById('formatInfo');
      const sizeInfo = document.getElementById('sizeInfo');
      const recordsInfo = document.getElementById('recordsInfo');
      const scopeInfo = document.getElementById('scopeInfo');
      
      if (formatInfo) formatInfo.textContent = format.toUpperCase();
      if (sizeInfo) sizeInfo.textContent = size;
      if (recordsInfo) recordsInfo.textContent = records.toLocaleString();
      if (scopeInfo) scopeInfo.textContent = scope;
    }

    function checkAdminSession() {
      const session = localStorage.getItem('adminSession');
      if (!session) {
        window.location.href = '/admin';
        return false;
      }
      
      try {
        const sessionData = JSON.parse(session);
        if (sessionData.expiry <= Date.now()) {

          localStorage.removeItem('adminSession');
          window.location.href = '/admin';
          return false;
        }
        return true;
      } catch (e) {

        localStorage.removeItem('adminSession');
        window.location.href = '/admin';
        return false;
      }
    }

    function logoutAdmin() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
        localStorage.removeItem('adminSession');
        window.location.href = '/admin';
      }
    }

    function goToHomePage() {
      if (confirm('B·∫°n c√≥ mu·ªën v·ªÅ trang ch·ªß?')) {
        window.location.href = '/page.html';
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      if (!checkAdminSession()) {
        return;
      }

      initAdminPage();
    });

    let currentPage = 1;
    let totalPages = 1;
    let currentSearch = '';
    
    function parseServerTimeToLocal(ts) {
      if (!ts) return null;
      if (ts.includes('T')) { const d = new Date(ts); return isNaN(d) ? null : d; }
      const m = ts.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/);
      if (m) { const d = new Date(ts.replace(' ', 'T') + 'Z'); return isNaN(d) ? null : d; }
      const d = new Date(ts); return isNaN(d) ? null : d;
    }
    
    async function fetchStudents(page = 1, search = '') {
      const params = new URLSearchParams({
        page: page,
        limit: 50,
        search: search
      });
      
      const res = await fetch(`/api/students?${params}`, { cache: 'no-store' });
      if (!res.ok) throw new Error('Load students failed');
      return res.json();
    }
    async function exportExcel(btn) {
      // M·ªü popup t√πy ch·ªçn xu·∫•t file thay v√¨ xu·∫•t tr·ª±c ti·∫øp
      openExportModal();
    }

    function openExportModal() {
      document.getElementById('exportModal').style.display = 'block';
      // Reset form
      document.getElementById('exportAll').checked = true;
      selectExportOption('all');
      
      // Initialize file preview
      setTimeout(() => {
        updateFilePreview();
        setupFilePreviewListeners();
        updateClassSelectionButtonStates(); // Initialize button states
      }, 100);
    }

    function setupFilePreviewListeners() {
      // Add event listeners for real-time updates
      const radioButtons = document.querySelectorAll('input[name="exportType"], input[name="exportFormat"]');
      const titleInput = document.getElementById('customTitle');
      const checkboxes = document.querySelectorAll('input[name="selectedClasses"], input[name="gradeType"]');
      
      radioButtons.forEach(radio => {
        radio.addEventListener('change', updateFilePreview);
      });
      
      if (titleInput) {
        titleInput.addEventListener('input', updateFilePreview);
      }
      
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateFilePreview);
      });
      
      // Add listeners for province and ethnicity filters
      const provinceFilter = document.getElementById('provinceFilter');
      const ethnicityFilter = document.getElementById('ethnicityFilter');
      
      if (provinceFilter) {
        provinceFilter.addEventListener('change', () => {
          console.log('üåç Province filter changed:', provinceFilter.value);
          updateFilePreview();
        });
      }
      
      if (ethnicityFilter) {
        ethnicityFilter.addEventListener('change', () => {
          console.log('üè¥ Ethnicity filter changed:', ethnicityFilter.value);
          updateFilePreview();
        });
      }
      
      // Add listeners for custom filters if they exist
      const customGenderInputs = document.querySelectorAll('#customFilters input[value="Nam"], #customFilters input[value="N·ªØ"]');
      const fromYearInput = document.getElementById('fromYear');
      const toYearInput = document.getElementById('toYear');
      const hasPhoneFilter = document.getElementById('hasPhoneFilter');
      
      customGenderInputs.forEach(input => {
        input.addEventListener('change', updateFilePreview);
      });
      
      if (fromYearInput) {
        fromYearInput.addEventListener('input', updateFilePreview);
      }
      
      if (toYearInput) {
        toYearInput.addEventListener('input', updateFilePreview);
      }
      
      if (hasPhoneFilter) {
        hasPhoneFilter.addEventListener('change', updateFilePreview);
      }
      
      // Add listeners for styling options
      const fontSizeSelect = document.getElementById('fontSize');
      const themeColorInputs = document.querySelectorAll('input[name="themeColor"]');
      
      if (fontSizeSelect) {
        fontSizeSelect.addEventListener('change', () => {
          console.log('üìù Font size changed:', fontSizeSelect.value);
          updateFilePreview();
        });
      }
      
      themeColorInputs.forEach(input => {
        input.addEventListener('change', updateFilePreview);
      });
      
      // Setup class checkbox listeners for button state updates
      setupClassCheckboxListeners();
    }

    function closeExportModal() {
      document.getElementById('exportModal').style.display = 'none';
    }

    function selectExportOption(type) {
      // Update radio selection
      document.getElementById('exportAll').checked = (type === 'all');
      document.getElementById('exportGrade').checked = (type === 'grade');
      document.getElementById('exportClass').checked = (type === 'class');
      document.getElementById('exportCustom').checked = (type === 'custom');
      
      // Update visual selection
      document.querySelectorAll('.export-radio-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Show/hide appropriate sections
      document.getElementById('gradeSelection').style.display = (type === 'grade') ? 'block' : 'none';
      document.getElementById('classSelection').style.display = (type === 'class') ? 'block' : 'none';
      document.getElementById('customFilters').style.display = (type === 'custom') ? 'block' : 'none';
      
      // Add selected class to clicked item
      const items = document.querySelectorAll('#exportModal .export-radio-group .export-radio-item');
      if (type === 'all') {
        items[0].classList.add('selected');
      } else if (type === 'grade') {
        items[1].classList.add('selected');
      } else if (type === 'class') {
        items[2].classList.add('selected');
      } else if (type === 'custom') {
        items[3].classList.add('selected');
      }
      
      // Reset class selection button states when switching export types
      if (type === 'class') {
        setTimeout(() => {
          updateClassSelectionButtonStates();
        }, 100);
      }
      
      // Update file preview
      setTimeout(updateFilePreview, 50);
    }
    
    function selectFormat(format) {
      document.getElementById('formatXlsx').checked = (format === 'xlsx');
      document.getElementById('formatCsv').checked = (format === 'csv');
      document.getElementById('formatPdf').checked = (format === 'pdf');
      document.getElementById('formatJson').checked = (format === 'json');
      
      // Update file preview
      setTimeout(updateFilePreview, 50);
    }
    
    function selectGradeClasses(grade) {
      const checkboxes = document.querySelectorAll(`input[value^="${grade}"]`);
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      
      // First, uncheck all classes
      document.querySelectorAll('input[name="selectedClasses"]').forEach(cb => {
        cb.checked = false;
      });
      
      // Then check only the selected grade if it wasn't fully selected
      if (!allChecked) {
        checkboxes.forEach(cb => {
          cb.checked = true;
        });
      }
      
      // Update button states
      updateClassSelectionButtonStates();
      
      // Update file preview
      setTimeout(updateFilePreview, 50);
    }

    // Function to update button states based on current selection
    function updateClassSelectionButtonStates() {
      const allCheckboxes = document.querySelectorAll('input[name="selectedClasses"]');
      const checkedCheckboxes = document.querySelectorAll('input[name="selectedClasses"]:checked');
      
      const grade10Checkboxes = document.querySelectorAll('input[name="selectedClasses"][value^="10"]');
      const grade11Checkboxes = document.querySelectorAll('input[name="selectedClasses"][value^="11"]');
      const grade12Checkboxes = document.querySelectorAll('input[name="selectedClasses"][value^="12"]');
      
      const grade10Checked = document.querySelectorAll('input[name="selectedClasses"][value^="10"]:checked');
      const grade11Checked = document.querySelectorAll('input[name="selectedClasses"][value^="11"]:checked');
      const grade12Checked = document.querySelectorAll('input[name="selectedClasses"][value^="12"]:checked');
      
      // Get button elements
      const btnSelectAll = document.getElementById('btnSelectAll');
      const btnClearAll = document.getElementById('btnClearAll');
      const btnGrade10 = document.getElementById('btnGrade10');
      const btnGrade11 = document.getElementById('btnGrade11');
      const btnGrade12 = document.getElementById('btnGrade12');
      
      // Reset all button states
      [btnSelectAll, btnGrade10, btnGrade11, btnGrade12].forEach(btn => {
        if (btn) btn.classList.remove('active');
      });
      
      // Check if all classes are selected
      if (checkedCheckboxes.length === allCheckboxes.length && allCheckboxes.length > 0) {
        btnSelectAll?.classList.add('active');
      }
      
      // Check if only grade 10 is fully selected
      if (grade10Checked.length === grade10Checkboxes.length && 
          grade10Checked.length > 0 && 
          checkedCheckboxes.length === grade10Checked.length) {
        btnGrade10?.classList.add('active');
      }
      
      // Check if only grade 11 is fully selected
      if (grade11Checked.length === grade11Checkboxes.length && 
          grade11Checked.length > 0 && 
          checkedCheckboxes.length === grade11Checked.length) {
        btnGrade11?.classList.add('active');
      }
      
      // Check if only grade 12 is fully selected
      if (grade12Checked.length === grade12Checkboxes.length && 
          grade12Checked.length > 0 && 
          checkedCheckboxes.length === grade12Checked.length) {
        btnGrade12?.classList.add('active');
      }
    }

    // Add event listeners to checkboxes to update button states when manually clicked
    function setupClassCheckboxListeners() {
      const checkboxes = document.querySelectorAll('input[name="selectedClasses"]');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          updateClassSelectionButtonStates();
          updateFilePreview();
        });
      });
    }
    
    function previewExport() {
      const format = document.querySelector('input[name="exportFormat"]:checked').value;
      const type = document.querySelector('input[name="exportType"]:checked').value;
      
      alert(`Xem tr∆∞·ªõc xu·∫•t ${format.toUpperCase()}\nLo·∫°i: ${type}\n\nT√≠nh nƒÉng ƒëang ph√°t tri·ªÉn...`);
    }
    
    function scheduleExport() {
      const datetime = prompt("Nh·∫≠p th·ªùi gian xu·∫•t (YYYY-MM-DD HH:MM):");
      if (datetime) {
        alert(`ƒê√£ l√™n l·ªãch xu·∫•t v√†o: ${datetime}\n\nT√≠nh nƒÉng ƒëang ph√°t tri·ªÉn...`);
      }
    }

    function selectGrade(grade) {
      document.getElementById('grade10').checked = (grade === '10');
      document.getElementById('grade11').checked = (grade === '11');
      document.getElementById('grade12').checked = (grade === '12');
      
      // Update visual selection in grade group
      document.querySelectorAll('#gradeSelection .export-radio-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      if (grade === '10') {
        document.querySelector('#gradeSelection .export-radio-item:nth-child(1)').classList.add('selected');
      } else if (grade === '11') {
        document.querySelector('#gradeSelection .export-radio-item:nth-child(2)').classList.add('selected');
      } else if (grade === '12') {
        document.querySelector('#gradeSelection .export-radio-item:nth-child(3)').classList.add('selected');
      }
      
      // Update file preview
      setTimeout(updateFilePreview, 50);
    }

    function selectAllClasses() {
      const checkboxes = document.querySelectorAll('input[name="selectedClasses"]');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      
      // Toggle all checkboxes
      checkboxes.forEach(checkbox => {
        checkbox.checked = !allChecked;
      });
      
      // Update button states
      updateClassSelectionButtonStates();
      
      // Update file preview
      setTimeout(updateFilePreview, 50);
    }

    function clearAllClasses() {
      document.querySelectorAll('input[name="selectedClasses"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // Update button states
      updateClassSelectionButtonStates();
      
      // Update file preview
      setTimeout(updateFilePreview, 50);
    }

    async function executeExport() {
      try {
        // Wait for DOM to be ready
        if (document.readyState !== 'complete') {
          await new Promise(resolve => {
            if (document.readyState === 'complete') {
              resolve();
            } else {
              document.addEventListener('DOMContentLoaded', resolve, { once: true });
            }
          });
        }
        
        const exportTypeElement = document.querySelector('input[name="exportType"]:checked');
        const exportFormatElement = document.querySelector('input[name="exportFormat"]:checked');
        const customTitleElement = document.getElementById('customTitle');
        const themeColorElement = document.querySelector('input[name="themeColor"]:checked');
        const fontSizeElement = document.getElementById('fontSize');
        
        if (!exportTypeElement || !exportFormatElement) {
          alert('Vui l√≤ng ch·ªçn lo·∫°i v√† ƒë·ªãnh d·∫°ng xu·∫•t file!');
          return;
        }
        
        const exportType = exportTypeElement.value;
        const exportFormat = exportFormatElement.value;
        const customTitle = customTitleElement?.value || 'Danh s√°ch h·ªçc sinh THPT Dƒ© An';
        const themeColor = themeColorElement?.value || 'blue';
        const fontSize = fontSizeElement?.value || '12';
        
        // Collect additional options
        const options = {
          includeStats: document.getElementById('includeStats')?.checked || false,
          includeTimestamp: document.getElementById('includeTimestamp')?.checked || false,
          sortByClass: document.getElementById('sortByClass')?.checked || false,
          sortByName: document.getElementById('sortByName')?.checked || false,
          hideEmptyFields: document.getElementById('hideEmptyFields')?.checked || false,
          title: customTitle,
          themeColor: themeColor,
          fontSize: fontSize,
          format: exportFormat
        };
        
        let url = `/api/export-${exportFormat}`;
        let params = new URLSearchParams();
        
        // Add options to params
        Object.keys(options).forEach(key => {
          params.append(key, options[key]);
        });
        
        if (exportType === 'grade') {
          const selectedGrade = document.querySelector('input[name="gradeType"]:checked');
          if (!selectedGrade) {
            alert('Vui l√≤ng ch·ªçn kh·ªëi h·ªçc!');
            return;
          }
          params.append('grade', selectedGrade.value);
        } else if (exportType === 'class') {
          const selectedClasses = [];
          document.querySelectorAll('input[name="selectedClasses"]:checked').forEach(checkbox => {
            selectedClasses.push(checkbox.value);
          });
          
          if (selectedClasses.length === 0) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt l·ªõp!');
            return;
          }
          
          params.append('classes', selectedClasses.join(','));
        } else if (exportType === 'custom') {
          // Handle custom filters
          const genderFilters = [];
          const genderCheckboxes = document.querySelectorAll('#customFilters input[value="Nam"], #customFilters input[value="N·ªØ"]');
          genderCheckboxes.forEach(cb => {
            if (cb.checked) {
              genderFilters.push(cb.value);
            }
          });
          if (genderFilters.length > 0) {
            params.append('gender', genderFilters.join(','));
          }
          
          // Add year filters if provided
          const fromYearInput = document.getElementById('fromYear');
          const toYearInput = document.getElementById('toYear');
          if (fromYearInput && fromYearInput.value) params.append('fromYear', fromYearInput.value);
          if (toYearInput && toYearInput.value) params.append('toYear', toYearInput.value);
          
          // Phone number filter
          const phoneCheckbox = document.getElementById('hasPhoneFilter');
          if (phoneCheckbox) {
            params.append('hasPhone', phoneCheckbox.checked);
          }
        }
        
        // Apply province and ethnicity filters for ALL export types
        const provinceFilter = document.getElementById('provinceFilter');
        if (provinceFilter && provinceFilter.value) {
          params.append('province', provinceFilter.value);
          console.log('üåç Province filter applied:', provinceFilter.value);
        } else {
          console.log('‚ùå No province filter selected');
        }
        
        const ethnicityFilter = document.getElementById('ethnicityFilter');
        if (ethnicityFilter && ethnicityFilter.value) {
          params.append('ethnicity', ethnicityFilter.value);
          console.log('üè¥ Ethnicity filter applied:', ethnicityFilter.value);
        } else {
          console.log('‚ùå No ethnicity filter selected');
        }
        
        console.log('üì§ Export URL:', url + '?' + params.toString());
        
        url += '?' + params.toString();
        
        // Close modal and show loading
        closeExportModal();
        showLoadingOverlay(`ƒêang t·∫°o file ${exportFormat.toUpperCase()}...`);
        
        const res = await fetch(url);
        if (!res.ok) { 
          const e = await res.json().catch(() => ({error:'L·ªói server'})); 
          throw new Error(e.error || 'L·ªói xu·∫•t file'); 
        }
        
        const blob = await res.blob();
        const downloadUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        
        // Generate filename based on selection and format
        let filename = customTitle.toLowerCase().replace(/[^a-z0-9]/g, '_');
        if (exportType === 'grade') {
          const grade = document.querySelector('input[name="gradeType"]:checked').value;
          filename += `_khoi_${grade}`;
        } else if (exportType === 'class') {
          const selectedClasses = [];
          document.querySelectorAll('input[name="selectedClasses"]:checked').forEach(checkbox => {
            selectedClasses.push(checkbox.value);
          });
          if (selectedClasses.length === 1) {
            filename += `_lop_${selectedClasses[0]}`;
          } else {
            filename += `_${selectedClasses.length}_lop`;
          }
        } else if (exportType === 'custom') {
          filename += '_tuy_chinh';
        } else {
          filename += '_tat_ca';
        }
        
        const timestamp = new Date().toISOString().slice(0,16).replace('T', '_').replace(':', '-');
        filename += `_${timestamp}.${exportFormat}`;
        
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(downloadUrl);
        a.remove();
        
        // Show success message
        alert(`‚úÖ Xu·∫•t file ${exportFormat.toUpperCase()} th√†nh c√¥ng!\nFile: ${filename}`);
        
      } catch (e) { 
        alert('‚ùå Xu·∫•t file l·ªói: ' + e.message); 
      } finally { 
        hideLoadingOverlay();
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('exportModal');
      if (event.target === modal) {
        closeExportModal();
      }
    }
    async function deleteStudent(id) {
      if (!confirm('X√≥a h·ªçc sinh n√†y?')) return;
      const res = await fetch(`/api/delete-student/${id}`, { method: 'DELETE' });
      const j = await res.json();
      if (!j.success) { alert(j.error || 'X√≥a th·∫•t b·∫°i'); return; }
      loadAndRender();
    }
    function renderRows(data) {
      const tbody = document.getElementById('tbody');
      const students = data.students || [];
      const pagination = data.pagination || {};

      currentPage = pagination.current_page || 1;
      totalPages = pagination.total_pages || 1;
      currentSearch = data.search || '';

      if (!students.length) { 
        tbody.innerHTML = `<tr><td colspan="10" class="empty">
          ${currentSearch ? `Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ cho "${currentSearch}"` : 'Ch∆∞a c√≥ h·ªçc sinh'}
        </td></tr>`; 
        renderPagination(pagination);
        return; 
      }
      
      tbody.innerHTML = students.map((s, idx) => {
        const dt = parseServerTimeToLocal(s.created_at);
        const globalIdx = (currentPage - 1) * 50 + idx + 1;
        const isSample = s.email && s.email.includes('_sample_');
        
        // Format gender to Vietnamese
        const formatGender = (gender) => {
          if (gender === 'male') return 'Nam';
          if (gender === 'female') return 'N·ªØ';
          return gender || '';
        };
        
        // Format birth date to Vietnamese
        const formatBirthDate = (dateStr) => {
          if (!dateStr || dateStr === '' || dateStr === 'null' || dateStr === 'undefined') {
            return '';
          }
          
          try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
              return dateStr; // Return original if can't parse
            }
            return date.toLocaleDateString('vi-VN');
          } catch (error) {
            return dateStr; // Return original if error
          }
        };
        
        return `<tr onclick="viewStudentDetail(${s.id})" style="cursor: pointer;" title="Click ƒë·ªÉ xem chi ti·∫øt">
          <td onclick="event.stopPropagation()">
            <input type="checkbox" class="student-checkbox" value="${s.id}" onchange="updateSelectionCount()">
          </td>
          <td>${globalIdx}${isSample ? ' üß™' : ''}</td>
          <td>${s.email||''}</td>
          <td>${s.full_name||''}</td>
          <td>${s.class||''}</td>
          <td>${formatBirthDate(s.birth_date)}</td>
          <td>${formatGender(s.gender)}</td>
          <td>${s.phone||''}</td>
          <td>${dt? dt.toLocaleString('vi-VN') : ''}</td>
          <td class="cell-actions" onclick="event.stopPropagation()">
            <button class="btn info compact icon-only" title="Xem chi ti·∫øt" onclick="viewStudentDetail(${s.id})">
              <i class="fa fa-eye"></i>
            </button>
            <button class="btn danger compact icon-only" title="X√≥a h·ªçc sinh" onclick="deleteStudent(${s.id})">
              <i class="fa fa-trash"></i>
            </button>
          </td>
        </tr>`;
      }).join('');
      
      renderPagination(pagination);
    }
    
    function renderPagination(pagination) {
      const wrapper = document.getElementById('pagination-wrapper');
      const paginationDiv = document.getElementById('pagination');
      const infoSpan = document.getElementById('pagination-info-text');
      
      if (!pagination || pagination.total_records === 0) {
        wrapper.style.display = 'none';
        return;
      }
      
      wrapper.style.display = 'flex';

      const startRecord = (pagination.current_page - 1) * pagination.limit + 1;
      const endRecord = Math.min(pagination.current_page * pagination.limit, pagination.total_records);
      infoSpan.textContent = `Hi·ªÉn th·ªã ${startRecord}-${endRecord} c·ªßa ${pagination.total_records} b·∫£n ghi`;

      let buttons = [];

      buttons.push(`
        <button onclick="changePage(${pagination.current_page - 1})" 
                ${!pagination.has_prev ? 'disabled' : ''}>
          <i class="fas fa-chevron-left"></i> Tr∆∞·ªõc
        </button>
      `);

      const maxVisible = 5;
      const current = pagination.current_page;
      const total = pagination.total_pages;
      
      let startPage = Math.max(1, current - Math.floor(maxVisible / 2));
      let endPage = Math.min(total, startPage + maxVisible - 1);
      
      if (endPage - startPage + 1 < maxVisible) {
        startPage = Math.max(1, endPage - maxVisible + 1);
      }
      
      if (startPage > 1) {
        buttons.push(`<button onclick="changePage(1)">1</button>`);
        if (startPage > 2) {
          buttons.push(`<span style="padding: 8px;">...</span>`);
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        buttons.push(`
          <button onclick="changePage(${i})" 
                  ${i === current ? 'class="active"' : ''}>
            ${i}
          </button>
        `);
      }
      
      if (endPage < total) {
        if (endPage < total - 1) {
          buttons.push(`<span style="padding: 8px;">...</span>`);
        }
        buttons.push(`<button onclick="changePage(${total})">${total}</button>`);
      }

      buttons.push(`
        <button onclick="changePage(${pagination.current_page + 1})" 
                ${!pagination.has_next ? 'disabled' : ''}>
          Sau <i class="fas fa-chevron-right"></i>
        </button>
      `);
      
      paginationDiv.innerHTML = buttons.join('');
    }
    
    function changePage(page) {
      if (page < 1 || page > totalPages || page === currentPage) return;
      loadAndRender(page, currentSearch);
    }
    
    function performSearch() {
      const query = document.getElementById('q').value.trim();
      loadAndRender(1, query);
    }
    let allStudents = [];

    let searchTimer;
    
    function applyFilter() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        performSearch();
      }, 300);
    }
    async function loadAndRender(page = 1, search = '') {
      try {
        document.getElementById('loading').style.display = 'inline-flex';
        const data = await fetchStudents(page, search);

        document.getElementById('total').textContent = data.pagination?.total_records || 0;

        if (search !== document.getElementById('q').value) {
          document.getElementById('q').value = search;
        }
        
        renderRows(data);
      } catch (e) {
        alert('L·ªói t·∫£i d·ªØ li·ªáu: ' + e.message);
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }
    
    async function refreshData(btn) {
      try {
        showLoadingOverlay('ƒêang l√†m m·ªõi d·ªØ li·ªáu...');
        await loadAndRender();
      } finally {
        hideLoadingOverlay();
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      initAdminPage();
    });

    function initAdminPage() {
      document.getElementById('q').addEventListener('input', applyFilter);

      const modal = document.getElementById('studentModal');
      const closeBtn = modal.querySelector('.close');
      
      closeBtn.onclick = () => modal.style.display = 'none';
      
      window.onclick = (event) => {
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      };
      
      loadAndRender();
    }

    async function viewStudentDetail(id) {
      try {
        const modal = document.getElementById('studentModal');
        const modalBody = document.getElementById('modalBody');

        modalBody.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</div>';
        modal.style.display = 'block';

        const response = await fetch(`/api/student/${id}`);
        const student = await response.json();
        
        if (!response.ok) {
          throw new Error(student.error || 'L·ªói t·∫£i d·ªØ li·ªáu');
        }

        modalBody.innerHTML = generateStudentDetailHTML(student);
        
      } catch (error) {
        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = `<div style="text-align: center; padding: 40px; color: #f44336;"><i class="fas fa-exclamation-circle"></i> ${error.message}</div>`;
      }
    }

    function generateStudentDetailHTML(student) {
      const formatDate = (dateStr) => {
        if (!dateStr || dateStr === '' || dateStr === 'null' || dateStr === 'undefined') {
          return 'Ch∆∞a c√≥ th√¥ng tin';
        }
        
        try {
          const date = new Date(dateStr);

          if (isNaN(date.getTime())) {
            return 'Ch∆∞a c√≥ th√¥ng tin';
          }
          return date.toLocaleDateString('vi-VN');
        } catch (error) {
          return 'Ch∆∞a c√≥ th√¥ng tin';
        }
      };

      const formatValue = (value) => {
        if (!value || value === '' || value === 'null' || value === 'undefined') {
          return 'Ch∆∞a c√≥ th√¥ng tin';
        }
        return value;
      };

      const formatGender = (gender) => {
        if (gender === 'male') return 'Nam';
        if (gender === 'female') return 'N·ªØ';
        return 'Ch∆∞a c√≥ th√¥ng tin';
      };

      const parseArrayField = (fieldValue) => {
        if (!fieldValue) return 'Ch∆∞a c√≥ th√¥ng tin';
        if (typeof fieldValue === 'string') {
          try {
            const parsed = JSON.parse(fieldValue);
            return Array.isArray(parsed) ? parsed.join(', ') : fieldValue;
          } catch (e) {
            return fieldValue.split(',').map(x => x.trim()).filter(x => x).join(', ') || fieldValue;
          }
        }
        if (Array.isArray(fieldValue)) {
          return fieldValue.join(', ');
        }
        return String(fieldValue);
      };

      const sections = [
        {
          title: 'I. TH√îNG TIN C√Å NH√ÇN',
          icon: 'fas fa-user',
          data: [
            { label: 'H·ªç v√† t√™n', value: student.ho_ten || student.full_name },
            { label: 'T√™n g·ªçi kh√°c', value: student.nickname },
            { label: 'L·ªõp', value: student.lop || student.class },
            { label: 'Kh·ªëi', value: student.khoi },
            { label: 'Ng√†y sinh', value: formatDate(student.ngay_sinh || student.birth_date) },
            { label: 'Gi·ªõi t√≠nh', value: formatGender(student.gioi_tinh || student.gender) },
            { label: 'D√¢n t·ªôc', value: student.dan_toc || student.ethnicity },
            { label: 'Qu·ªëc t·ªãch', value: student.nationality },
            { label: 'T√¥n gi√°o', value: student.ton_giao || student.religion },
            { label: 'S·ªë ƒëi·ªán tho·∫°i', value: student.sdt || student.phone },
            { label: 'Email', value: student.email },
            { label: 'CCCD/CMND', value: student.citizen_id || student.personal_id },
            { label: 'Ng√†y c·∫•p CCCD', value: formatDate(student.cccd_date) },
            { label: 'N∆°i c·∫•p CCCD', value: student.cccd_place },
            { label: 'M√£ s·ªë c√° nh√¢n', value: student.personal_id },
            { label: 'H·ªô chi·∫øu', value: student.passport },
            { label: 'Ng√†y c·∫•p h·ªô chi·∫øu', value: formatDate(student.passport_date) },
            { label: 'N∆°i c·∫•p h·ªô chi·∫øu', value: student.passport_place },
            { label: 'Ngh·ªÅ nghi·ªáp', value: student.occupation },
            { label: 'T·ªï ch·ª©c ƒêo√†n/ƒê·ªôi', value: student.organization }
          ]
        },
        {
          title: 'II. TH√îNG TIN ƒê·ªäA CH·ªà',
          icon: 'fas fa-map-marker-alt',
          data: [
            { label: 'T·ªânh th∆∞·ªùng tr√∫', value: student.tinh_thanh || student.permanent_province },
            { label: 'Qu·∫≠n/Huy·ªán th∆∞·ªùng tr√∫', value: student.permanent_district },
            { label: 'Ph∆∞·ªùng/X√£ th∆∞·ªùng tr√∫', value: student.permanent_ward },
            { label: 'T·ªï/Th√¥n/X√≥m th∆∞·ªùng tr√∫', value: student.permanent_hamlet },
            { label: 'S·ªë nh√†, ƒë∆∞·ªùng th∆∞·ªùng tr√∫', value: student.permanent_street },
            { label: 'T·ªânh qu√™ qu√°n', value: student.hometown_province },
            { label: 'Qu·∫≠n/Huy·ªán qu√™ qu√°n', value: student.hometown_district },
            { label: 'X√£/Ph∆∞·ªùng qu√™ qu√°n', value: student.hometown_ward },
            { label: 'T·ªï/Th√¥n/X√≥m qu√™ qu√°n', value: student.hometown_hamlet },
            { label: 'T·ªânh hi·ªán t·∫°i', value: student.current_province },
            { label: 'Qu·∫≠n/Huy·ªán hi·ªán t·∫°i', value: student.current_district },
            { label: 'Ph∆∞·ªùng/X√£ hi·ªán t·∫°i', value: student.current_ward },
            { label: 'T·ªï/Th√¥n/X√≥m hi·ªán t·∫°i', value: student.current_hamlet },
            { label: 'ƒê·ªãa ch·ªâ hi·ªán t·∫°i chi ti·∫øt', value: student.dia_chi || student.current_address_detail },
            { label: 'T·ªânh n∆°i sinh', value: student.birthplace_province },
            { label: 'Qu·∫≠n/Huy·ªán n∆°i sinh', value: student.birthplace_district },
            { label: 'Ph∆∞·ªùng/X√£ n∆°i sinh', value: student.birthplace_ward },
            { label: 'T·ªânh c·∫•p gi·∫•y khai sinh', value: student.birth_cert_province },
            { label: 'Qu·∫≠n/Huy·ªán c·∫•p gi·∫•y khai sinh', value: student.birth_cert_district },
            { label: 'Ph∆∞·ªùng/X√£ c·∫•p gi·∫•y khai sinh', value: student.birth_cert_ward }
          ]
        },
        {
          title: 'III. TH√îNG TIN S·ª®C KH·ªéE',
          icon: 'fas fa-heartbeat',
          data: [
            { label: 'Chi·ªÅu cao', value: student.height ? student.height + ' cm' : null },
            { label: 'C√¢n n·∫∑ng', value: student.weight ? student.weight + ' kg' : null },
            { label: 'B·ªánh v·ªÅ m·∫Øt', value: parseArrayField(student.eye_diseases) },
            { label: 'K·ªπ nƒÉng b∆°i l·ªôi', value: student.swimming_skill }
          ]
        },
        {
          title: 'IV. THI·∫æT B·ªä H·ªåC TR·ª∞C TUY·∫æN',
          icon: 'fas fa-laptop',
          data: [
            { label: 'Smartphone c·ªßa ph·ª• huynh', value: student.smartphone },
            { label: 'M√°y t√≠nh ƒë·ªÉ b√†n/laptop', value: student.computer }
          ]
        },
        {
          title: 'V. TH√îNG TIN GIA ƒê√åNH',
          icon: 'fas fa-users',
          data: [
            { label: 'D√¢n t·ªôc cha', value: student.father_ethnicity },
            { label: 'H·ªç t√™n cha', value: student.ho_ten_cha || student.father_name },
            { label: 'NƒÉm sinh cha', value: student.father_birth_year },
            { label: 'Ngh·ªÅ nghi·ªáp cha', value: student.nghe_nghiep_cha || student.father_job },
            { label: 'S·ªë ƒëi·ªán tho·∫°i cha', value: student.father_phone },
            { label: 'CCCD cha', value: student.father_cccd },
            { label: 'D√¢n t·ªôc m·∫π', value: student.mother_ethnicity },
            { label: 'H·ªç t√™n m·∫π', value: student.ho_ten_me || student.mother_name },
            { label: 'NƒÉm sinh m·∫π', value: student.mother_birth_year },
            { label: 'Ngh·ªÅ nghi·ªáp m·∫π', value: student.nghe_nghiep_me || student.mother_job },
            { label: 'S·ªë ƒëi·ªán tho·∫°i m·∫π', value: student.mother_phone },
            { label: 'CCCD m·∫π', value: student.mother_cccd },
            { label: 'H·ªç t√™n ng∆∞·ªùi gi√°m h·ªô', value: student.guardian_name },
            { label: 'NƒÉm sinh ng∆∞·ªùi gi√°m h·ªô', value: student.guardian_birth_year },
            { label: 'Ngh·ªÅ nghi·ªáp ng∆∞·ªùi gi√°m h·ªô', value: student.guardian_job },
            { label: 'S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi gi√°m h·ªô', value: student.guardian_phone },
            { label: 'CCCD ng∆∞·ªùi gi√°m h·ªô', value: student.guardian_cccd },
            { label: 'Gi·ªõi t√≠nh ng∆∞·ªùi gi√°m h·ªô', value: formatGender(student.guardian_gender) }
          ]
        },
        {
          title: 'VI. TH√îNG TIN H·ªÜ TH·ªêNG',
          icon: 'fas fa-clock',
          data: [
            { label: 'Th·ªùi gian n·ªôp', value: formatDate(student.created_at) },
            { label: 'ID h·ªá th·ªëng', value: student.id }
          ]
        }
      ];

      let html = '';
      sections.forEach(section => {
        // Always show all sections, but filter out empty values for display
        const sectionData = section.data.filter(item => {
          if (!item.label) return false;
          return true; // Show all fields
        }).map(item => {
          const value = item.value;
          // Format the value for display
          if (!value || value === '' || value === 'null' || value === 'undefined') {
            return { ...item, value: 'Ch∆∞a c√≥ th√¥ng tin' };
          }
          if (item.label.toLowerCase().includes('ng√†y') && value.includes && value.includes('Invalid Date')) {
            return { ...item, value: 'Ch∆∞a c√≥ th√¥ng tin' };
          }
          return item;
        });
        
        // Always show the section
        html += `
          <div class="section">
            <div class="section-header">
              <i class="${section.icon}"></i>
              ${section.title}
            </div>
            <div class="section-content">
              <div class="detail-grid">
                ${sectionData.map(item => `
                  <div class="detail-label">${item.label}</div>
                  <div class="detail-value">${formatValue(item.value)}</div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      });

      return html;
    }
  </script>
  </head>
<body>
  <div class="header">
    <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto;">
      <h1><i class="fas fa-users"></i> QU·∫¢N L√ù H·ªåC SINH THPT Dƒ® AN</h1>
      <div style="display: flex; gap: 12px; align-items: center;">
        <button class="btn" onclick="goToHomePage()" style="background: white; color: #1e40af; border: 2px solid white; font-weight: 600;" title="V·ªÅ trang ch·ªß">
          <i class="fas fa-home"></i> Trang ch·ªß
        </button>
        <button class="btn" onclick="logoutAdmin()" style="background: white; color: #1e40af; border: 2px solid white; font-weight: 600;">
          <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
        </button>
      </div>
    </div>
  </div>
  <div class="wrap">
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="stats">
          <span>T·ªïng s·ªë:</span> <span id="total">0</span>
          <span id="loading" style="display:none;color:#1565C0"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</span>
        </div>
      </div>
      
      <div class="toolbar-center">
        <input id="q" class="input" placeholder="T√¨m theo email, h·ªç t√™n, l·ªõp, SƒêT..." />
        <button class="btn refresh icon-only" onclick="refreshData(this)" title="L√†m m·ªõi">
          <i class="fas fa-rotate"></i>
        </button>
      </div>
      
      <div class="toolbar-right">
        <button class="btn info compact" onclick="exportExcel(this)">
          <i class="fas fa-file"></i> Xu·∫•t File
        </button>
        <button class="btn secondary compact" onclick="generateSampleData(this)">
          <i class="fas fa-users"></i> T·∫°o Data
        </button>
        <button class="btn warning compact" onclick="deleteAllBots(this)">
          <i class="fas fa-robot"></i> X√≥a Data ·∫¢o
        </button>
        <button class="btn danger compact" onclick="clearAllData(this)">
          <i class="fas fa-trash"></i> X√≥a T·∫•t C·∫£
        </button>
      </div>
    </div>
    
    <div id="bulkActions" class="bulk-actions">
      <span id="selectedCount">0 h·ªçc sinh ƒë∆∞·ª£c ch·ªçn</span>
      <div style="display: flex; gap: 8px;">
        <button class="btn danger compact" onclick="deleteSelected()">
          <i class="fas fa-trash"></i> X√≥a ƒë√£ ch·ªçn
        </button>
        <button class="btn compact" onclick="clearSelection()">
          <i class="fas fa-times"></i> H·ªßy ch·ªçn
        </button>
      </div>
    </div>
    <div style="overflow:auto;">
      <table class="table">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
            <th>STT</th>
            <th>Email</th>
            <th>H·ªç v√† t√™n</th>
            <th>L·ªõp</th>
            <th>Ng√†y sinh</th>
            <th>Gi·ªõi t√≠nh</th>
            <th>SƒêT</th>
            <th>Th·ªùi gian n·ªôp</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="9" class="empty">ƒêang t·∫£i...</td></tr>
        </tbody>
      </table>
    </div>

    <div id="pagination-wrapper" class="pagination-wrapper" style="display: none;">
      <div class="pagination-info">
        <span id="pagination-info-text">Hi·ªÉn th·ªã 1-50 c·ªßa 0 b·∫£n ghi</span>
      </div>
      <div class="pagination" id="pagination">
        
      </div>
    </div>
  </div>

  <div id="studentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Th√¥ng tin chi ti·∫øt h·ªçc sinh</h2>
        <button type="button" class="close">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div id="loadingText" class="loading-text">ƒêang x·ª≠ l√Ω...</div>
  </div>

  <script>
    // New functions for bulk operations
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.student-checkbox');
      
      checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
      });
      
      updateSelectionCount();
    }
    
    function updateSelectionCount() {
      const checkboxes = document.querySelectorAll('.student-checkbox:checked');
      const count = checkboxes.length;
      const bulkActions = document.getElementById('bulkActions');
      const selectedCount = document.getElementById('selectedCount');
      
      if (count > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = `${count} h·ªçc sinh ƒë∆∞·ª£c ch·ªçn`;
      } else {
        bulkActions.classList.remove('show');
      }
      
      // Update select all checkbox state
      const allCheckboxes = document.querySelectorAll('.student-checkbox');
      const selectAll = document.getElementById('selectAll');
      selectAll.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
      selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
    }
    
    function clearSelection() {
      document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('selectAll').checked = false;
      updateSelectionCount();
    }
    
    async function deleteSelected() {
      const checkboxes = document.querySelectorAll('.student-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h·ªçc sinh ƒë·ªÉ x√≥a!');
        return;
      }
      
      if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${checkboxes.length} h·ªçc sinh ƒë√£ ch·ªçn?`)) return;
      
      const ids = Array.from(checkboxes).map(cb => cb.value);
      
      try {
        const promises = ids.map(id => 
          fetch(`/api/delete-student/${id}`, { method: 'DELETE' })
        );
        
        await Promise.all(promises);
        alert('ƒê√£ x√≥a th√†nh c√¥ng!');
        clearSelection();
        loadAndRender();
      } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra khi x√≥a: ' + error.message);
      }
    }
    
    async function clearAllData(btn) {
      if (!confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ h·ªçc sinh? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;
      if (!confirm('X√°c nh·∫≠n l·∫ßn cu·ªëi: X√ìA T·∫§T C·∫¢ d·ªØ li·ªáu h·ªçc sinh?')) return;
      
      try {
        showLoadingOverlay('ƒêang x√≥a t·∫•t c·∫£ d·ªØ li·ªáu...');
        const res = await fetch('/api/clear-all-data', { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
          alert(`ƒê√£ x√≥a th√†nh c√¥ng ${data.deleted_count} h·ªçc sinh v√† reset database!`);
          loadAndRender();
        } else {
          alert('L·ªói: ' + data.error);
        }
      } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
      } finally {
        hideLoadingOverlay();
      }
    }
    
    async function generateSampleData(btn) {
      const count = prompt('Nh·∫≠p s·ªë l∆∞·ª£ng d·ªØ li·ªáu ·∫£o mu·ªën t·∫°o:', '50');
      if (!count || isNaN(count) || count <= 0) return;
      
      if (parseInt(count) > 200) {
        alert('Kh√¥ng th·ªÉ t·∫°o qu√° 200 b·∫£n ghi c√πng l√∫c ƒë·ªÉ tr√°nh lag!');
        return;
      }
      
      try {
        showLoadingOverlay(`ƒêang t·∫°o ${count} h·ªçc sinh ·∫£o...`);
        const res = await fetch('/api/generate-sample-data', { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ count: parseInt(count) })
        });
        const data = await res.json();
        
        if (data.success) {
          alert(`ƒê√£ t·∫°o th√†nh c√¥ng ${data.created_count} h·ªçc sinh ·∫£o v·ªõi d·ªØ li·ªáu th·ª±c t·∫ø!`);
          loadAndRender();
        } else {
          alert('L·ªói: ' + data.error);
        }
      } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
      } finally {
        hideLoadingOverlay();
      }
    }
    
    async function deleteAllBots(btn) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu ·∫£o?')) return;
      
      try {
        showLoadingOverlay('ƒêang x√≥a t·∫•t c·∫£ d·ªØ li·ªáu ·∫£o...');
        const res = await fetch('/api/delete-all-bots', { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
          alert(`ƒê√£ x√≥a th√†nh c√¥ng ${data.deleted_count} h·ªçc sinh ·∫£o!`);
          loadAndRender();
        } else {
          alert('L·ªói: ' + data.error);
        }
      } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
      } finally {
        hideLoadingOverlay();
      }
    }

    // Advanced Export Functions
    function resetExportSettings() {
      // Reset all form inputs to default values
      document.querySelector('input[name="exportType"][value="all"]').checked = true;
      document.querySelector('input[name="exportFormat"][value="xlsx"]').checked = true;
      document.querySelector('input[name="themeColor"][value="blue"]').checked = true;
      
      // Reset checkboxes
      document.getElementById('includeStats').checked = true;
      document.getElementById('includeTimestamp').checked = true;
      document.getElementById('sortByClass').checked = false;
      document.getElementById('sortByName').checked = false;
      document.getElementById('hideEmptyFields').checked = false;
      document.getElementById('compressFile').checked = false;
      
      // Reset custom filters
      const genderCheckboxes = document.querySelectorAll('#customFilters input[type="checkbox"]');
      genderCheckboxes.forEach(cb => cb.checked = true);
      
      const yearInputs = document.querySelectorAll('#customFilters input[type="number"]');
      yearInputs.forEach(input => input.value = '');
      
      // Reset selects
      document.getElementById('maxColumns').selectedIndex = 0;
      document.getElementById('fontSize').selectedIndex = 1;
      document.getElementById('encoding').selectedIndex = 0;
      
      if (document.getElementById('provinceFilter')) {
        document.getElementById('provinceFilter').selectedIndex = 0;
      }
      if (document.getElementById('ethnicityFilter')) {
        document.getElementById('ethnicityFilter').selectedIndex = 0;
      }
      
      // Reset title
      document.getElementById('customTitle').value = 'Danh s√°ch h·ªçc sinh THPT Dƒ© An';
      
      // Clear all class selections
      clearAllClasses();
      
      // Hide all conditional sections
      document.getElementById('gradeSelection').style.display = 'none';
      document.getElementById('classSelection').style.display = 'none';
      document.getElementById('customFilters').style.display = 'none';
      
      // Update preview
      updateFilePreview();
      
      // Show notification
      showNotification('ƒê√£ kh√¥i ph·ª•c c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh', 'success');
    }

    function previewExport() {
      const exportType = document.querySelector('input[name="exportType"]:checked').value;
      const exportFormat = document.querySelector('input[name="exportFormat"]:checked').value;
      
      let previewText = `B·∫°n s·∫Øp xu·∫•t d·ªØ li·ªáu v·ªõi c√†i ƒë·∫∑t sau:\n\n`;
      previewText += `üìÅ ƒê·ªãnh d·∫°ng: ${exportFormat.toUpperCase()}\n`;
      previewText += `üéØ Ph·∫°m vi: ${getExportScopeText()}\n`;
      previewText += `üìä Bao g·ªìm th·ªëng k√™: ${document.getElementById('includeStats').checked ? 'C√≥' : 'Kh√¥ng'}\n`;
      previewText += `üïí Ghi th·ªùi gian: ${document.getElementById('includeTimestamp').checked ? 'C√≥' : 'Kh√¥ng'}\n`;
      previewText += `üé® M√†u ch·ªß ƒë·ªÅ: ${document.querySelector('input[name="themeColor"]:checked').value}\n`;
      
      if (exportType === 'class') {
        const selectedClasses = Array.from(document.querySelectorAll('input[name="selectedClasses"]:checked')).map(cb => cb.value);
        previewText += `üè´ L·ªõp ƒë∆∞·ª£c ch·ªçn: ${selectedClasses.join(', ')}\n`;
      } else if (exportType === 'grade') {
        const selectedGrade = document.querySelector('input[name="gradeType"]:checked');
        if (selectedGrade) {
          previewText += `üéì Kh·ªëi: ${selectedGrade.value}\n`;
        }
      }
      
      alert(previewText);
    }

    function saveExportTemplate() {
      const templateName = prompt('Nh·∫≠p t√™n cho m·∫´u xu·∫•t file:', 'M·∫´u t√πy ch·ªânh');
      if (!templateName) return;
      
      const settings = gatherExportSettings();
      
      // Save to localStorage
      let savedTemplates = JSON.parse(localStorage.getItem('exportTemplates') || '{}');
      savedTemplates[templateName] = settings;
      localStorage.setItem('exportTemplates', JSON.stringify(savedTemplates));
      
      showNotification(`ƒê√£ l∆∞u m·∫´u "${templateName}"`, 'success');
    }

    function scheduleExport() {
      alert('Ch·ª©c nƒÉng l√™n l·ªãch xu·∫•t file ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.\n\nB·∫°n c√≥ th·ªÉ:\n‚Ä¢ L√™n l·ªãch xu·∫•t h√†ng ng√†y\n‚Ä¢ L√™n l·ªãch xu·∫•t h√†ng tu·∫ßn\n‚Ä¢ L√™n l·ªãch xu·∫•t theo th√°ng\n‚Ä¢ G·ª≠i email t·ª± ƒë·ªông');
    }

    function gatherExportSettings() {
      return {
        exportType: document.querySelector('input[name="exportType"]:checked').value,
        exportFormat: document.querySelector('input[name="exportFormat"]:checked').value,
        themeColor: document.querySelector('input[name="themeColor"]:checked').value,
        includeStats: document.getElementById('includeStats').checked,
        includeTimestamp: document.getElementById('includeTimestamp').checked,
        sortByClass: document.getElementById('sortByClass').checked,
        sortByName: document.getElementById('sortByName').checked,
        hideEmptyFields: document.getElementById('hideEmptyFields').checked,
        customTitle: document.getElementById('customTitle').value,
        maxColumns: document.getElementById('maxColumns').value,
        fontSize: document.getElementById('fontSize').value,
        encoding: document.getElementById('encoding').value
      };
    }

    function getExportScopeText() {
      const exportType = document.querySelector('input[name="exportType"]:checked').value;
      switch(exportType) {
        case 'all': return 'T·∫•t c·∫£ h·ªçc sinh';
        case 'grade': 
          const grade = document.querySelector('input[name="gradeType"]:checked');
          return grade ? `Kh·ªëi ${grade.value}` : 'Ch∆∞a ch·ªçn kh·ªëi';
        case 'class': 
          const count = document.querySelectorAll('input[name="selectedClasses"]:checked').length;
          return count > 0 ? `${count} l·ªõp ƒë∆∞·ª£c ch·ªçn` : 'Ch∆∞a ch·ªçn l·ªõp';
        case 'custom': return 'T√πy ch·ªânh';
        default: return 'Kh√¥ng x√°c ƒë·ªãnh';
      }
    }

    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 300px;
        font-weight: 500;
        animation: slideIn 0.3s ease;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 3000);
    }

    // Templates Modal Functions
    function closeTemplatesModal() {
      document.getElementById('exportTemplatesModal').style.display = 'none';
    }

    function loadTemplate(templateType) {
      resetExportSettings();
      
      switch(templateType) {
        case 'all_students':
          document.querySelector('input[name="exportType"][value="all"]').checked = true;
          document.getElementById('includeStats').checked = true;
          break;
        case 'contact_only':
          document.querySelector('input[name="exportType"][value="all"]').checked = true;
          document.getElementById('maxColumns').value = 'contact';
          document.getElementById('hideEmptyFields').checked = true;
          break;
        case 'grade_summary':
          document.querySelector('input[name="exportType"][value="grade"]').checked = true;
          document.getElementById('includeStats').checked = true;
          document.getElementById('sortByClass').checked = true;
          selectExportOption('grade');
          break;
        case 'birthday_list':
          document.querySelector('input[name="exportType"][value="birthday"]').checked = true;
          document.getElementById('maxColumns').value = 'basic';
          selectExportOption('birthday');
          break;
      }
      
      updateFilePreview();
      closeTemplatesModal();
      showNotification(`ƒê√£ t·∫£i m·∫´u "${templateType}"`, 'success');
    }

    // Enhanced selectExportOption function to handle new types
    function selectExportOption(type) {
      // Hide all conditional sections first
      document.getElementById('gradeSelection').style.display = 'none';
      document.getElementById('classSelection').style.display = 'none';
      document.getElementById('customFilters').style.display = 'none';
      
      // Update radio button
      document.querySelector(`input[name="exportType"][value="${type}"]`).checked = true;
      
      // Show relevant section
      if (type === 'grade') {
        document.getElementById('gradeSelection').style.display = 'block';
      } else if (type === 'class') {
        document.getElementById('classSelection').style.display = 'block';
      } else if (type === 'custom') {
        document.getElementById('customFilters').style.display = 'block';
      }
      
      updateFilePreview();
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Just initialize without summary functions
    });
  </script>

  <!-- Export Options Modal -->
  <div id="exportModal" class="export-modal">
    <div class="export-modal-content">
      <div class="export-modal-header">
        <h3><i class="fas fa-cloud-download-alt"></i> Xu·∫•t D·ªØ Li·ªáu N√¢ng Cao</h3>
        <button class="export-close" onclick="closeExportModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="export-modal-body">
        <!-- Left Column: Data Selection & Format -->
        <div class="export-section">
          <!-- File Preview Section -->
          <div class="file-preview-section">
            <div class="file-preview-header">
              <i class="fas fa-file-preview"></i>
              <span>Xem Tr∆∞·ªõc File</span>
            </div>
            
            <div class="file-info-grid">
              <div class="file-info-item">
                <div class="file-info-label"><i class="fas fa-file-alt"></i> ƒê·ªãnh d·∫°ng</div>
                <div class="file-info-value" id="formatInfo">XLSX</div>
              </div>
              <div class="file-info-item">
                <div class="file-info-label"><i class="fas fa-weight-hanging"></i> Dung l∆∞·ª£ng ∆∞·ªõc t√≠nh</div>
                <div class="file-info-value" id="sizeInfo">ƒêang t√≠nh...</div>
              </div>
              <div class="file-info-item">
                <div class="file-info-label"><i class="fas fa-database"></i> S·ªë b·∫£n ghi</div>
                <div class="file-info-value" id="recordsInfo">0</div>
              </div>
              <div class="file-info-item">
                <div class="file-info-label"><i class="fas fa-search"></i> Ph·∫°m vi</div>
                <div class="file-info-value" id="scopeInfo">T·∫•t c·∫£</div>
              </div>
            </div>

            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #0369a1;">
                <i class="fas fa-signature"></i> T√™n file t√πy ch·ªânh:
              </label>
              <input type="text" id="customTitle" class="filename-input" 
                     placeholder="Danh s√°ch h·ªçc sinh THPT Dƒ© An" 
                     value="Danh s√°ch h·ªçc sinh THPT Dƒ© An">
              <div class="filename-preview">
                <strong><i class="fas fa-file"></i> T√™n file cu·ªëi c√πng:</strong>
                <span id="filenamePreview">danh_sach_hoc_sinh_thpt_di_an_tat_ca_2025-08-14_12-00.xlsx</span>
              </div>
            </div>
          </div>

          <!-- Data Range Selection -->
          <div class="export-option-group">
            <h4><i class="fas fa-filter"></i> Ph·∫°m vi d·ªØ li·ªáu</h4>
            <div class="export-radio-group">
              <div class="export-radio-item" onclick="selectExportOption('all')">
                <input type="radio" id="exportAll" name="exportType" value="all" checked>
                <label for="exportAll">
                  <strong><i class="fas fa-globe"></i> T·∫•t c·∫£ h·ªçc sinh</strong>
                  <div>Xu·∫•t to√†n b·ªô danh s√°ch trong h·ªá th·ªëng</div>
                </label>
              </div>
              
              <div class="export-radio-item" onclick="selectExportOption('grade')">
                <input type="radio" id="exportGrade" name="exportType" value="grade">
                <label for="exportGrade">
                  <strong><i class="fas fa-layer-group"></i> Theo kh·ªëi h·ªçc</strong>
                  <div>Ch·ªçn kh·ªëi 10, 11 ho·∫∑c 12</div>
                </label>
              </div>
              
              <div class="export-radio-item" onclick="selectExportOption('class')">
                <input type="radio" id="exportClass" name="exportType" value="class">
                <label for="exportClass">
                  <strong><i class="fas fa-users"></i> Theo l·ªõp c·ª• th·ªÉ</strong>
                  <div>Ch·ªçn m·ªôt ho·∫∑c nhi·ªÅu l·ªõp</div>
                </label>
              </div>

              <div class="export-radio-item" onclick="selectExportOption('custom')">
                <input type="radio" id="exportCustom" name="exportType" value="custom">
                <label for="exportCustom">
                  <strong><i class="fas fa-sliders-h"></i> T√πy ch·ªânh n√¢ng cao</strong>
                  <div>L·ªçc theo nhi·ªÅu ti√™u ch√≠</div>
                </label>
              </div>
            </div>
          </div>

          <!-- Grade Selection -->
          <div id="gradeSelection" class="export-option-group" style="display: none;">
            <h4><i class="fas fa-graduation-cap"></i> Ch·ªçn kh·ªëi h·ªçc</h4>
            <div class="export-radio-group">
              <div class="export-radio-item" onclick="selectGrade('10')">
                <input type="radio" id="grade10" name="gradeType" value="10">
                <label for="grade10">
                  <strong>Kh·ªëi 10</strong>
                  <div style="color: #3b82f6;">12 l·ªõp (10A1 ‚Üí 10B4)</div>
                </label>
              </div>
              
              <div class="export-radio-item" onclick="selectGrade('11')">
                <input type="radio" id="grade11" name="gradeType" value="11">
                <label for="grade11">
                  <strong>Kh·ªëi 11</strong>
                  <div style="color: #10b981;">12 l·ªõp (11A1 ‚Üí 11B4)</div>
                </label>
              </div>
              
              <div class="export-radio-item" onclick="selectGrade('12')">
                <input type="radio" id="grade12" name="gradeType" value="12">
                <label for="grade12">
                  <strong>Kh·ªëi 12</strong>
                  <div style="color: #f59e0b;">12 l·ªõp (12A1 ‚Üí 12B4)</div>
                </label>
              </div>
            </div>
          </div>

          <!-- Custom Filters -->
          <div id="customFilters" class="export-option-group" style="display: none;">
            <h4><i class="fas fa-filter"></i> B·ªô l·ªçc n√¢ng cao</h4>
            <div style="display: grid; gap: 16px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                  <i class="fas fa-venus-mars"></i> Gi·ªõi t√≠nh:
                </label>
                <div style="display: flex; gap: 16px;">
                  <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" value="Nam" checked> 
                    <span><i class="fas fa-mars" style="color: #3b82f6;"></i> Nam</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" value="N·ªØ" checked> 
                    <span><i class="fas fa-venus" style="color: #ec4899;"></i> N·ªØ</span>
                  </label>
                </div>
              </div>
              
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                  <i class="fas fa-calendar-alt"></i> NƒÉm sinh:
                </label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="number" id="fromYear" placeholder="T·ª´ nƒÉm" style="width: 100px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" min="2000" max="2010">
                  <span><i class="fas fa-arrow-right"></i></span>
                  <input type="number" id="toYear" placeholder="ƒê·∫øn nƒÉm" style="width: 100px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" min="2000" max="2010">
                </div>
              </div>
              
              <div>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="hasPhoneFilter" checked> 
                  <span><i class="fas fa-mobile-alt" style="color: #10b981;"></i> Ch·ªâ xu·∫•t h·ªçc sinh c√≥ s·ªë ƒëi·ªán tho·∫°i</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Format & Options -->
        <div class="export-section">
          <!-- Format Selection -->
          <div class="export-option-group">
            <h4><i class="fas fa-file-export"></i> ƒê·ªãnh d·∫°ng xu·∫•t</h4>
            <div class="export-radio-group">
              <div class="export-radio-item" onclick="selectFormat('xlsx')">
                <input type="radio" id="formatXlsx" name="exportFormat" value="xlsx" checked>
                <label for="formatXlsx">
                  <strong><i class="fas fa-file-excel" style="color: #10b981;"></i> Excel (.xlsx)</strong>
                  <div>T∆∞∆°ng th√≠ch v·ªõi MS Excel, t·ªët nh·∫•t cho b√°o c√°o</div>
                </label>
              </div>
              
              <div class="export-radio-item" onclick="selectFormat('csv')">
                <input type="radio" id="formatCsv" name="exportFormat" value="csv">
                <label for="formatCsv">
                  <strong><i class="fas fa-file-csv" style="color: #f59e0b;"></i> CSV (.csv)</strong>
                  <div>D·ªØ li·ªáu ph√¢n c√°ch, dung l∆∞·ª£ng nh·ªè</div>
                </label>
              </div>
              
              <div class="export-radio-item" onclick="selectFormat('pdf')" style="display: none;">
                <input type="radio" id="formatPdf" name="exportFormat" value="pdf">
                <label for="formatPdf">
                  <strong><i class="fas fa-file-pdf" style="color: #ef4444;"></i> PDF (.pdf)</strong>
                  <div>ƒê·ªãnh d·∫°ng in ·∫•n, kh√¥ng ch·ªânh s·ª≠a ƒë∆∞·ª£c</div>
                </label>
              </div>

              <div class="export-radio-item" onclick="selectFormat('json')">
                <input type="radio" id="formatJson" name="exportFormat" value="json">
                <label for="formatJson">
                  <strong><i class="fas fa-code" style="color: #8b5cf6;"></i> JSON (.json)</strong>
                  <div>D·ªØ li·ªáu c√≥ c·∫•u tr√∫c cho l·∫≠p tr√¨nh</div>
                </label>
              </div>
            </div>
          </div>

          <!-- Export Options -->
          <div class="export-option-group">
            <h4><i class="fas fa-cogs"></i> T√πy ch·ªçn xu·∫•t</h4>
            <div style="display: grid; gap: 12px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                <input type="checkbox" id="includeStats" checked>
                <span><i class="fas fa-chart-bar" style="color: #3b82f6;"></i> Bao g·ªìm th·ªëng k√™ t·ªïng quan</span>
              </label>
              
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                <input type="checkbox" id="includeTimestamp" checked>
                <span><i class="fas fa-clock" style="color: #10b981;"></i> Ghi th·ªùi gian xu·∫•t file</span>
              </label>
              
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                <input type="checkbox" id="sortByClass">
                <span><i class="fas fa-sort-alpha-down" style="color: #f59e0b;"></i> S·∫Øp x·∫øp theo l·ªõp</span>
              </label>
              
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                <input type="checkbox" id="sortByName">
                <span><i class="fas fa-user-sort" style="color: #8b5cf6;"></i> S·∫Øp x·∫øp theo t√™n</span>
              </label>
              
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                <input type="checkbox" id="hideEmptyFields">
                <span><i class="fas fa-eye-slash" style="color: #6b7280;"></i> ·∫®n c√°c tr∆∞·ªùng d·ªØ li·ªáu tr·ªëng</span>
              </label>
            </div>
          </div>

          <!-- B·ªô l·ªçc d·ªØ li·ªáu -->
          <div class="export-option-group">
            <h4><i class="fas fa-filter"></i> B·ªô l·ªçc d·ªØ li·ªáu</h4>
            <div style="display: grid; gap: 16px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                  <i class="fas fa-map-marker-alt"></i> T·ªânh/Th√†nh th∆∞·ªùng tr√∫:
                </label>
                <select id="provinceFilter" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="">T·∫•t c·∫£ t·ªânh/th√†nh</option>

                  <!-- 6 th√†nh ph·ªë tr·ª±c thu·ªôc trung ∆∞∆°ng -->
                  <option value="H√† N·ªôi">H√† N·ªôi</option>
                  <option value="Th√†nh ph·ªë H·ªì Ch√≠ Minh">Th√†nh ph·ªë H·ªì Ch√≠ Minh</option>
                  <option value="H·∫£i Ph√≤ng">H·∫£i Ph√≤ng</option>
                  <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
                  <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
                  <option value="Th·ª´a Thi√™n Hu·∫ø">Th·ª´a Thi√™n Hu·∫ø</option>

                  <!-- 28 t·ªânh -->
                  <option value="Tuy√™n Quang">Tuy√™n Quang</option>
                  <option value="L√†o Cai">L√†o Cai</option>
                  <option value="Th√°i Nguy√™n">Th√°i Nguy√™n</option>
                  <option value="Ph√∫ Th·ªç">Ph√∫ Th·ªç</option>
                  <option value="B·∫Øc Ninh">B·∫Øc Ninh</option>
                  <option value="H∆∞ng Y√™n">H∆∞ng Y√™n</option>
                  <option value="Ninh B√¨nh">Ninh B√¨nh</option>
                  <option value="Qu·∫£ng Tr·ªã">Qu·∫£ng Tr·ªã</option>
                  <option value="Qu·∫£ng Ng√£i">Qu·∫£ng Ng√£i</option>
                  <option value="Gia Lai">Gia Lai</option>
                  <option value="Kh√°nh H√≤a">Kh√°nh H√≤a</option>
                  <option value="L√¢m ƒê·ªìng">L√¢m ƒê·ªìng</option>
                  <option value="ƒê·∫Øk L·∫Øk">ƒê·∫Øk L·∫Øk</option>
                  <option value="ƒê·ªìng Nai">ƒê·ªìng Nai</option>
                  <option value="T√¢y Ninh">T√¢y Ninh</option>
                  <option value="Vƒ©nh Long">Vƒ©nh Long</option>
                  <option value="ƒê·ªìng Th√°p">ƒê·ªìng Th√°p</option>
                  <option value="C√† Mau">C√† Mau</option>
                  <option value="An Giang">An Giang</option>
                  <option value="Cao B·∫±ng">Cao B·∫±ng</option>
                  <option value="ƒêi·ªán Bi√™n">ƒêi·ªán Bi√™n</option>
                  <option value="H√† Tƒ©nh">H√† Tƒ©nh</option>
                  <option value="Lai Ch√¢u">Lai Ch√¢u</option>
                  <option value="L·∫°ng S∆°n">L·∫°ng S∆°n</option>
                  <option value="Ngh·ªá An">Ngh·ªá An</option>
                  <option value="Qu·∫£ng Ninh">Qu·∫£ng Ninh</option>
                  <option value="Thanh H√≥a">Thanh H√≥a</option>
                  <option value="S∆°n La">S∆°n La</option>
                </select>
              </div>

              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                  <i class="fas fa-flag"></i> D√¢n t·ªôc:
                </label>
                <select id="ethnicityFilter" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="">T·∫•t c·∫£ d√¢n t·ªôc</option>
                  <option value="Kinh">Kinh</option>
                  <option value="T√†y">T√†y</option>
                  <option value="Th√°i">Th√°i</option>
                  <option value="Hoa">Hoa</option>
                  <option value="Khmer">Khmer</option>
                  <option value="M∆∞·ªùng">M∆∞·ªùng</option>
                  <option value="N√πng">N√πng</option>
                  <option value="H'M√¥ng">H'M√¥ng</option>
                  <option value="Dao">Dao</option>
                  <option value="Gia Rai">Gia Rai</option>
                  <option value="Ng√°i">Ng√°i</option>
                  <option value="√ä ƒê√™">√ä ƒê√™</option>
                  <option value="Ba Na">Ba Na</option>
                  <option value="X∆° ƒêƒÉng">X∆° ƒêƒÉng</option>
                  <option value="S√°n Chay">S√°n Chay</option>
                  <option value="C∆° Ho">C∆° Ho</option>
                  <option value="ChƒÉm">ChƒÉm</option>
                  <option value="S√°n D√¨u">S√°n D√¨u</option>
                  <option value="Hr√™">Hr√™</option>
                  <option value="Mn√¥ng">Mn√¥ng</option>
                  <option value="Ra Glai">Ra Glai</option>
                  <option value="Xti√™ng">Xti√™ng</option>
                  <option value="Bru - V√¢n Ki·ªÅu">Bru - V√¢n Ki·ªÅu</option>
                  <option value="Th·ªï">Th·ªï</option>
                  <option value="Gi√°y">Gi√°y</option>
                  <option value="C∆° Tu">C∆° Tu</option>
                  <option value="Gi√© Tri√™ng">Gi√© Tri√™ng</option>
                  <option value="M·∫°">M·∫°</option>
                  <option value="Kh∆° M√∫">Kh∆° M√∫</option>
                  <option value="Co">Co</option>
                  <option value="T√† √îi">T√† √îi</option>
                  <option value="Ch∆° Ro">Ch∆° Ro</option>
                  <option value="Kh√°ng">Kh√°ng</option>
                  <option value="Xinh Mun">Xinh Mun</option>
                  <option value="H√† Nh√¨">H√† Nh√¨</option>
                  <option value="Chu Ru">Chu Ru</option>
                  <option value="L√†o">L√†o</option>
                  <option value="La Ch√≠">La Ch√≠</option>
                  <option value="La Ha">La Ha</option>
                  <option value="Ph√π L√°">Ph√π L√°</option>
                  <option value="La H·ªß">La H·ªß</option>
                  <option value="L·ª±">L·ª±</option>
                  <option value="L√¥ L√¥">L√¥ L√¥</option>
                  <option value="Ch·ª©t">Ch·ª©t</option>
                  <option value="M·∫£ng">M·∫£ng</option>
                  <option value="P√† Th·∫ªn">P√† Th·∫ªn</option>
                  <option value="C∆° Lao">C∆° Lao</option>
                  <option value="C·ªëng">C·ªëng</option>
                  <option value="B·ªë Y">B·ªë Y</option>
                  <option value="Si La">Si La</option>
                  <option value="Pu P√©o">Pu P√©o</option>
                  <option value="Br√¢u">Br√¢u</option>
                  <option value="∆† ƒêu">∆† ƒêu</option>
                  <option value="R∆° MƒÉm">R∆° MƒÉm</option>
                </select>
              </div>
            </div>
          </div>

          <!-- T√πy ch·ªânh giao di·ªán -->
          <div class="export-option-group">
            <h4><i class="fas fa-palette"></i> T√πy ch·ªânh giao di·ªán</h4>

            <!-- Theme Colors -->
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                <i class="fas fa-swatchbook"></i> M√†u ch·ªß ƒë·ªÅ:
              </label>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="radio" id="colorBlue" name="themeColor" value="blue" checked>
                  <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 8px; border: 2px solid #e2e8f0;"></div>
                  <span>Xanh d∆∞∆°ng</span>
                </label>
                
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="radio" id="colorGreen" name="themeColor" value="green">
                  <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 8px; border: 2px solid #e2e8f0;"></div>
                  <span>Xanh l√°</span>
                </label>
                
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="radio" id="colorOrange" name="themeColor" value="orange">
                  <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 8px; border: 2px solid #e2e8f0;"></div>
                  <span>Cam</span>
                </label>
                
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="radio" id="colorPurple" name="themeColor" value="purple">
                  <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 8px; border: 2px solid #e2e8f0;"></div>
                  <span>T√≠m</span>
                </label>

                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="radio" id="colorRed" name="themeColor" value="red">
                  <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 8px; border: 2px solid #e2e8f0;"></div>
                  <span>ƒê·ªè</span>
                </label>
                
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="radio" id="colorTeal" name="themeColor" value="teal">
                  <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #14b8a6, #0d9488); border-radius: 8px; border: 2px solid #e2e8f0;"></div>
                  <span>Xanh ng·ªçc</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Class Selection Grid (Full Width) -->
        <div id="classSelection" class="export-section full-width" style="display: none;">
          <div class="export-option-group">
            <h4><i class="fas fa-th-list"></i> Ch·ªçn l·ªõp c·ª• th·ªÉ</h4>
            <div style="margin-bottom: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
              <button type="button" id="btnSelectAll" class="export-btn secondary" onclick="selectAllClasses()">
                <i class="fas fa-check-double"></i> Ch·ªçn t·∫•t c·∫£
              </button>
              <button type="button" id="btnClearAll" class="export-btn" onclick="clearAllClasses()">
                <i class="fas fa-times"></i> B·ªè ch·ªçn
              </button>
              <button type="button" id="btnGrade10" class="export-btn grade-10" onclick="selectGradeClasses('10')">
                <i class="fas fa-seedling"></i> Ch·ªâ kh·ªëi 10
              </button>
              <button type="button" id="btnGrade11" class="export-btn grade-11" onclick="selectGradeClasses('11')">
                Ch·ªâ kh·ªëi 11
              </button>
              <button type="button" id="btnGrade12" class="export-btn grade-12" onclick="selectGradeClasses('12')">
                Ch·ªâ kh·ªëi 12
              </button>
            </div>
            
            <div class="export-class-grid">
              <!-- Kh·ªëi 10 -->
              <div class="export-class-item">
                <input type="checkbox" id="class_10A1" name="selectedClasses" value="10A1">
                <label for="class_10A1">10A1</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_10A2" name="selectedClasses" value="10A2">
                <label for="class_10A2">10A2</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_10A3" name="selectedClasses" value="10A3">
                <label for="class_10A3">10A3</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_10A4" name="selectedClasses" value="10A4">
                <label for="class_10A4">10A4</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_10A5" name="selectedClasses" value="10A5">
                <label for="class_10A5">10A5</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_10A6" name="selectedClasses" value="10A6">
                <label for="class_10A6">10A6</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_10A7" name="selectedClasses" value="10A7">
                <label for="class_10A7">10A7</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_10A8" name="selectedClasses" value="10A8">
                <label for="class_10A8">10A8</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_10B1" name="selectedClasses" value="10B1">
                <label for="class_10B1">10B1</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_10B2" name="selectedClasses" value="10B2">
                <label for="class_10B2">10B2</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_10B3" name="selectedClasses" value="10B3">
                <label for="class_10B3">10B3</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_10B4" name="selectedClasses" value="10B4">
                <label for="class_10B4">10B4</label>
              </div>

              <!-- Kh·ªëi 11 -->
              <div class="export-class-item">
                <input type="checkbox" id="class_11A1" name="selectedClasses" value="11A1">
                <label for="class_11A1">11A1</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_11A2" name="selectedClasses" value="11A2">
                <label for="class_11A2">11A2</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_11A3" name="selectedClasses" value="11A3">
                <label for="class_11A3">11A3</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_11A4" name="selectedClasses" value="11A4">
                <label for="class_11A4">11A4</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_11A5" name="selectedClasses" value="11A5">
                <label for="class_11A5">11A5</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_11A6" name="selectedClasses" value="11A6">
                <label for="class_11A6">11A6</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_11A7" name="selectedClasses" value="11A7">
                <label for="class_11A7">11A7</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_11A8" name="selectedClasses" value="11A8">
                <label for="class_11A8">11A8</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_11B1" name="selectedClasses" value="11B1">
                <label for="class_11B1">11B1</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_11B2" name="selectedClasses" value="11B2">
                <label for="class_11B2">11B2</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_11B3" name="selectedClasses" value="11B3">
                <label for="class_11B3">11B3</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_11B4" name="selectedClasses" value="11B4">
                <label for="class_11B4">11B4</label>
              </div>

              <!-- Kh·ªëi 12 -->
              <div class="export-class-item">
                <input type="checkbox" id="class_12A1" name="selectedClasses" value="12A1">
                <label for="class_12A1">12A1</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_12A2" name="selectedClasses" value="12A2">
                <label for="class_12A2">12A2</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_12A3" name="selectedClasses" value="12A3">
                <label for="class_12A3">12A3</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_12A4" name="selectedClasses" value="12A4">
                <label for="class_12A4">12A4</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_12A5" name="selectedClasses" value="12A5">
                <label for="class_12A5">12A5</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_12A6" name="selectedClasses" value="12A6">
                <label for="class_12A6">12A6</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_12A7" name="selectedClasses" value="12A7">
                <label for="class_12A7">12A7</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_12A8" name="selectedClasses" value="12A8">
                <label for="class_12A8">12A8</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_12B1" name="selectedClasses" value="12B1">
                <label for="class_12B1">12B1</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_12B2" name="selectedClasses" value="12B2">
                <label for="class_12B2">12B2</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_12B3" name="selectedClasses" value="12B3">
                <label for="class_12B3">12B3</label>
              </div>
              <div class="export-class-item">
                <input type="checkbox" id="class_12B4" name="selectedClasses" value="12B4">
                <label for="class_12B4">12B4</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="export-buttons">
          <button class="export-btn secondary" onclick="resetExportSettings()" title="Kh√¥i ph·ª•c c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh">
            <i class="fas fa-undo"></i> ƒê·∫∑t l·∫°i m·∫∑c ƒë·ªãnh
          </button>
          <button class="export-btn primary" onclick="executeExport()" title="T·∫£i xu·ªëng file ngay l·∫≠p t·ª©c">
            <i class="fas fa-cloud-download-alt"></i> T·∫£i xu·ªëng ngay
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Templates Modal -->
  <div id="exportTemplatesModal" class="export-modal" style="display: none;">
    <div class="export-modal-content" style="max-width: 600px;">
      <div class="export-modal-header">
        <h3><i class="fas fa-layer-group"></i> M·∫´u Xu·∫•t File</h3>
        <button class="export-close" onclick="closeTemplatesModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="export-modal-body">
        <div class="templates-grid">
          <div class="template-card" onclick="loadTemplate('all_students')">
            <i class="fas fa-globe"></i>
            <h4>T·∫•t c·∫£ h·ªçc sinh</h4>
            <p>Xu·∫•t to√†n b·ªô danh s√°ch h·ªçc sinh v·ªõi ƒë·∫ßy ƒë·ªß th√¥ng tin</p>
          </div>
          <div class="template-card" onclick="loadTemplate('contact_only')">
            <i class="fas fa-address-book"></i>
            <h4>Ch·ªâ th√¥ng tin li√™n h·ªá</h4>
            <p>T√™n, l·ªõp, s·ªë ƒëi·ªán tho·∫°i, email cho m·ª•c ƒë√≠ch li√™n l·∫°c</p>
          </div>
          <div class="template-card" onclick="loadTemplate('grade_summary')">
            <i class="fas fa-layer-group"></i>
            <h4>B√°o c√°o theo kh·ªëi</h4>
            <p>Th·ªëng k√™ t·ªïng quan theo t·ª´ng kh·ªëi h·ªçc</p>
          </div>
          <div class="template-card" onclick="loadTemplate('birthday_list')">
            <i class="fas fa-birthday-cake"></i>
            <h4>Danh s√°ch sinh nh·∫≠t</h4>
            <p>H·ªçc sinh c√≥ sinh nh·∫≠t trong th√°ng</p>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
